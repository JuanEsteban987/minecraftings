<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RPG P2P: Sincronización Total</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Courier New', monospace; margin: 0; overflow: hidden; background: #1a1a1a; color: white; }
        canvas { background: #2d5a27; display: block; }
        
        /* Paneles UI */
        .ui-panel { position: absolute; top: 10px; left: 10px; z-index: 10; padding: 10px; background: rgba(0,0,0,0.8); border: 2px solid #555; font-size: 12px; }
        
        /* NUEVO: Menú de Ropa y Personalización en la esquina derecha */
        .custom-panel { position: absolute; top: 10px; right: 10px; z-index: 10; padding: 15px; background: rgba(40, 40, 40, 0.9); border: 3px solid #8b4513; width: 180px; }
        .custom-panel h4 { margin: 0 0 10px 0; color: #ffd700; text-align: center; }
        .item-row { margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .item-row input[type="color"] { border: none; width: 30px; height: 20px; cursor: pointer; }
        .item-row input[type="text"] { width: 80px; background: #111; color: #0f0; border: 1px solid #555; padding: 2px; }

        #hud { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center; pointer-events: none; }
        .bar { width: 200px; height: 10px; background: #444; border: 1px solid #000; margin: 5px; }
        .hp-fill { background: #ff3333; height: 100%; width: 100%; transition: width 0.2s; }
        #inventory { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 250px; background: #333; border: 4px solid #8b4513; padding: 20px; display: none; z-index: 20; }
    </style>
</head>
<body>

    <div class="ui-panel">
        ID: <span id="my-id" style="color:#0f0">...</span><br>
        <input type="text" id="target-id" placeholder="ID Amigo" style="width: 100px;">
        <button onclick="connectToPeer()">Conectar</button>
        <div id="host-status" style="font-size: 9px; color: #aaa; margin-top:5px;">Iniciando...</div>
    </div>

    <div class="custom-panel">
        <h4>PERSONALIZAR</h4>
        <div class="item-row">
            <span>Nombre:</span>
            <input type="text" id="change-nick" value="Heroe" maxlength="10" oninput="updateAppearance()">
        </div>
        <div class="item-row">
            <span>Ropa:</span>
            <input type="color" id="change-skin" value="#ffd700" onchange="updateAppearance()">
        </div>
        <div class="item-row">
            <span>Accesorio:</span>
            <input type="color" id="change-acc" value="#ff0000" onchange="updateAppearance()">
        </div>
    </div>

    <div id="hud">
        <div id="player-tag">Nivel 1</div>
        <div class="bar"><div id="hp-bar" class="hp-fill"></div></div>
        <small>[WASD] Mover - [Espacio] Atacar - [I] Inventario</small>
    </div>

    <div id="inventory">
        <h2 style="text-align:center; color: gold;">STATS</h2>
        <p>Nivel: <span id="st-lv">1</span></p>
        <p>Ataque: <span id="st-atk">10</span></p>
        <p>HP Máx: <span id="st-hp">100</span></p>
    </div>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const peer = new Peer();

        const WORLD_SIZE = 1500;
        let isHost = true;
        let myData = { 
            id: '', x: 750, y: 750, 
            nick: "Heroe", skin: "#ffd700", acc: "#ff0000", // Añadido color de accesorio
            lv: 1, xp: 0, hp: 100, maxHp: 100, atk: 10, 
            state: 'idle', frame: 0, dir: 1 
        };
        
        let peers = {};
        let remotePlayers = {};
        let slimes = [];
        let animTimer = 0;

        // Función para actualizar apariencia desde el menú UI
        function updateAppearance() {
            myData.nick = document.getElementById('change-nick').value;
            myData.skin = document.getElementById('change-skin').value;
            myData.acc = document.getElementById('change-acc').value;
            broadcast({ type: 'player_sync', data: myData });
        }

        // --- LÓGICA RED (PeerJS) ---
        peer.on('open', (id) => { 
            myData.id = id; 
            document.getElementById('my-id').innerText = id; 
        });

        peer.on('connection', (conn) => {
            isHost = true;
            document.getElementById('host-status').innerText = "Estado: HOST";
            setupConnection(conn);
        });

        function connectToPeer() {
            isHost = false;
            document.getElementById('host-status').innerText = "Estado: CLIENTE";
            setupConnection(peer.connect(document.getElementById('target-id').value));
        }

        function setupConnection(conn) {
            peers[conn.peer] = conn;
            conn.on('data', (data) => {
                if (data.type === 'player_sync') remotePlayers[data.data.id] = data.data;
                if (data.type === 'world_sync') slimes = data.slimes;
                if (data.type === 'slime_damage' && isHost) {
                    let s = slimes.find(s => s.id === data.id);
                    if(s) s.hp -= data.dmg;
                }
            });
        }

        function broadcast(msg) {
            for(let id in peers) peers[id].send(msg);
        }

        if(isHost) {
            for(let i=0; i<10; i++) {
                slimes.push({ id: i, x: Math.random()*WORLD_SIZE, y: Math.random()*WORLD_SIZE, hp: 40, maxHp: 40, frame: 0 });
            }
        }

        const keys = {};
        window.onkeydown = (e) => {
            keys[e.key.toLowerCase()] = true;
            if(e.key.toLowerCase() === 'i') {
                const inv = document.getElementById('inventory');
                inv.style.display = (inv.style.display === 'block') ? 'none' : 'block';
                document.getElementById('st-lv').innerText = myData.lv;
                document.getElementById('st-atk').innerText = myData.atk;
                document.getElementById('st-hp').innerText = myData.maxHp;
            }
        };
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

        function update() {
            let moving = false;
            const speed = 4;
            if (keys['w']) { myData.y -= speed; moving = true; }
            if (keys['s']) { myData.y += speed; moving = true; }
            if (keys['a']) { myData.x -= speed; moving = true; myData.dir = -1; }
            if (keys['d']) { myData.x += speed; moving = true; myData.dir = 1; }

            if (keys[' ']) {
                myData.state = 'attack';
                checkAttack();
            } else if (moving) {
                myData.state = 'walk';
            } else {
                myData.state = 'idle';
            }

            animTimer++;
            if(animTimer > 10) {
                myData.frame = (myData.frame + 1) % 4;
                if(isHost) slimes.forEach(s => s.frame = (s.frame + 1) % 4);
                animTimer = 0;
            }

            if(isHost) {
                slimes.forEach(s => {
                    if(s.hp <= 0) return;
                    let dist = Math.hypot(myData.x - s.x, myData.y - s.y);
                    if(dist < 150) {
                        s.x += (myData.x - s.x) * 0.01;
                        s.y += (myData.y - s.y) * 0.01;
                        if(dist < 20 && Math.random() < 0.05) myData.hp -= 1;
                    }
                });
                broadcast({ type: 'world_sync', slimes: slimes });
            }
            broadcast({ type: 'player_sync', data: myData });
            document.getElementById('hp-bar').style.width = (myData.hp/myData.maxHp)*100 + "%";
            document.getElementById('player-tag').innerText = `Nivel ${myData.lv} - ${myData.nick}`;
        }

        function checkAttack() {
            slimes.forEach(s => {
                let dist = Math.hypot(s.x - myData.x, s.y - myData.y);
                if(dist < 50 && s.hp > 0) {
                    if(isHost) s.hp -= myData.atk;
                    else broadcast({ type: 'slime_damage', id: s.id, dmg: myData.atk });
                }
            });
        }

        // --- DIBUJO ---
        function drawPlayer(p) {
            ctx.save();
            ctx.translate(p.x, p.y);
            let bounce = (p.state === 'walk' || p.state === 'idle') ? Math.sin(p.frame) * 3 : 0;
            ctx.scale(p.dir, 1);
            
            // Cuerpo (Ropa)
            ctx.fillStyle = p.skin;
            ctx.fillRect(-15, -15 + bounce, 30, 30);
            
            // Accesorio (Cinturón o banda)
            ctx.fillStyle = p.acc || "#ff0000";
            ctx.fillRect(-15, -2 + bounce, 30, 5); 
            
            if(p.state === 'attack') {
                ctx.strokeStyle = "white"; ctx.lineWidth = 4;
                ctx.beginPath(); ctx.arc(10, 0, 30, -1, 1); ctx.stroke();
            }
            ctx.restore();
            
            ctx.fillStyle = "white"; ctx.textAlign = "center"; ctx.font = "12px Arial";
            ctx.fillText(p.nick, p.x, p.y - 35);
        }

        function drawSlime(s) {
            if(s.hp <= 0) return;
            let bounce = Math.sin(s.frame) * 4;
            ctx.fillStyle = "#44ff44";
            ctx.beginPath();
            ctx.ellipse(s.x, s.y + 10, 15 + bounce, 10 - bounce, 0, 0, Math.PI * 2);
            ctx.fill();
        }

        function render() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const camX = canvas.width/2 - myData.x;
            const camY = canvas.height/2 - myData.y;
            ctx.save();
            ctx.translate(camX, camY);

            // Suelo
            ctx.strokeStyle = "rgba(255,255,255,0.05)";
            for(let i=0; i<=WORLD_SIZE; i+=100) {
                ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, WORLD_SIZE); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(WORLD_SIZE, i); ctx.stroke();
            }

            slimes.forEach(drawSlime);
            for(let id in remotePlayers) drawPlayer(remotePlayers[id]);
            drawPlayer(myData);

            ctx.restore();
            update();
            requestAnimationFrame(render);
        }
        render();
    </script>
</body>
</html>
