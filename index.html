<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Minecraft RPG 2D Online</title>
<style>
body{margin:0;font-family:sans-serif;background:#1b1b1b;color:white;overflow:hidden}
canvas{display:block}
.panel{background:#000c;padding:15px;border-radius:12px}
#menu{
position:absolute;left:50%;top:50%;
transform:translate(-50%,-50%);
width:260px;text-align:center
}
input,button,select{
width:100%;margin:5px 0;padding:6px;border-radius:6px;border:none
}
button{background:#3a8;color:white;font-weight:bold;cursor:pointer}
#ui{
position:absolute;left:10px;top:10px;
background:#0008;padding:8px;border-radius:10px;font-size:14px
}
#chat{height:90px;overflow:auto;background:#111;margin-top:5px;padding:4px}
</style>
</head>
<body>

<!-- MENU -->
<div id="menu" class="panel">
<h3>Minecraft RPG 2D</h3>

Nombre:
<input id="name" placeholder="Tu nombre">

Skin:
<select id="skin">
<option>ğŸ˜€</option>
<option>ğŸ˜</option>
<option>ğŸ¤ </option>
<option>ğŸ‘½</option>
<option>ğŸ¤–</option>
<option>ğŸ¸</option>
<option>ğŸ±</option>
</select>

CÃ³digo sala:
<input id="roomInput" placeholder="Si estÃ¡ vacÃ­o crea sala">

<button onclick="enter()">ENTRAR</button>
</div>

<canvas id="c"></canvas>

<div id="ui" style="display:none">
<div>Sala: <span id="roomLabel"></span></div>
<div id="players"></div>
<div id="chat"></div>
<input id="msg" placeholder="chat">
</div>

<script>
const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
canvas.width=innerWidth;
canvas.height=innerHeight;

let ws;
let peers={};
let players={};
let keys={};

let myId=Math.random().toString(36).substr(2,9);
let room="";
let started=false;

let me={
x:1500,y:1500,
emoji:"ğŸ˜€",
name:"Player"
};

players[myId]=me;

const TREES=[];
for(let i=0;i<50;i++){
TREES.push({x:Math.random()*3000,y:Math.random()*3000});
}

function enter(){
me.name=document.getElementById("name").value||"Player";
me.emoji=document.getElementById("skin").value;

room=document.getElementById("roomInput").value;
if(!room) room=Math.random().toString(36).substr(2,6);

document.getElementById("menu").style.display="none";
document.getElementById("ui").style.display="block";
document.getElementById("roomLabel").innerText=room;

connect();
started=true;
}

function connect(){
ws=new WebSocket("wss://y-webrtc-signaling-eu.herokuapp.com");

ws.onopen=()=>{
ws.send(JSON.stringify({type:"join",room,from:myId}));
setTimeout(()=>ws.send(JSON.stringify({type:"peers",room,from:myId})),500);
};

ws.onmessage=async e=>{
let msg=JSON.parse(e.data);
if(msg.from===myId)return;

if(msg.type==="peers"){
let pc=createPeer(msg.from);
let offer=await pc.createOffer();
await pc.setLocalDescription(offer);
ws.send(JSON.stringify({type:"offer",offer,to:msg.from,room,from:myId}));
}

if(msg.type==="offer"){
let pc=createPeer(msg.from);
await pc.setRemoteDescription(msg.offer);
let ans=await pc.createAnswer();
await pc.setLocalDescription(ans);
ws.send(JSON.stringify({type:"answer",answer:ans,to:msg.from,room,from:myId}));
}

if(msg.type==="answer"){
await peers[msg.from].setRemoteDescription(msg.answer);
}

if(msg.type==="candidate"){
if(peers[msg.from])
await peers[msg.from].addIceCandidate(msg.candidate);
}
};
}

function createPeer(id){
let pc=new RTCPeerConnection({
iceServers:[{urls:"stun:stun.l.google.com:19302"}]
});
peers[id]=pc;

let dc=pc.createDataChannel("game");
setupDC(id,dc);

pc.ondatachannel=e=>setupDC(id,e.channel);

pc.onicecandidate=e=>{
if(e.candidate){
ws.send(JSON.stringify({
type:"candidate",
candidate:e.candidate,
to:id,room,from:myId
}));
}
};

return pc;
}

function setupDC(id,dc){
dc.onmessage=e=>{
let data=JSON.parse(e.data);

if(data.type==="state") players[id]=data.player;
if(data.type==="chat") addChat(data.name+": "+data.msg);
};
peers[id].dc=dc;
}

function sendState(){
for(let id in peers){
let dc=peers[id].dc;
if(dc && dc.readyState==="open"){
dc.send(JSON.stringify({type:"state",player:me}));
}
}
}

function sendChat(m){
for(let id in peers){
let dc=peers[id].dc;
if(dc && dc.readyState==="open"){
dc.send(JSON.stringify({type:"chat",msg:m,name:me.name}));
}
}
addChat(me.name+": "+m);
}

document.getElementById("msg").onkeydown=e=>{
if(e.key==="Enter"){
sendChat(e.target.value);
e.target.value="";
}
};

function addChat(t){
let c=document.getElementById("chat");
c.innerHTML+=t+"<br>";
c.scrollTop=9999;
}

addEventListener("keydown",e=>keys[e.key]=true);
addEventListener("keyup",e=>keys[e.key]=false);

function update(){
if(!started)return;

let sp=4;
if(keys["w"])me.y-=sp;
if(keys["s"])me.y+=sp;
if(keys["a"])me.x-=sp;
if(keys["d"])me.x+=sp;

sendState();
}

function draw(){
ctx.fillStyle="#3a7";
ctx.fillRect(0,0,canvas.width,canvas.height);

if(!started)return;

let camX=me.x-canvas.width/2;
let camY=me.y-canvas.height/2;

for(let t of TREES){
ctx.font="28px serif";
ctx.fillText("ğŸŒ³",t.x-camX,t.y-camY);
}

for(let id in players){
let p=players[id];
ctx.font="26px serif";
ctx.fillText(p.emoji,p.x-camX,p.y-camY);
ctx.font="12px sans-serif";
ctx.fillText(p.name,p.x-camX-10,p.y-camY-12);
}

document.getElementById("players").innerHTML=
"ğŸ‘¥ "+Object.keys(players).length+" jugadores";
}

function loop(){
update();
draw();
requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
