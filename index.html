<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG Neo Genesis - Dungeons</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #38bdf8; --accent: #ef4444; --gold: #fbbf24; --glass: rgba(15, 23, 42, 0.95); }
        body { margin: 0; overflow: hidden; background: #070a0e; font-family: 'Segoe UI', sans-serif; color: white; touch-action: none; }
        canvas { display: block; background: #0a0f0a; }
        .glass { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; }
        
        /* HUD Superior */
        #hud { position: absolute; top: 15px; left: 15px; padding: 12px; min-width: 180px; z-index: 500; }
        .bar { height: 6px; border-radius: 3px; margin-top: 5px; overflow: hidden; background: #334155; }
        #hp-fill { height: 100%; width: 100%; background: var(--accent); transition: 0.3s; }
        #xp-fill { height: 100%; width: 0%; background: #a855f7; transition: 0.3s; }
        .stats-text { font-size: 12px; display: flex; justify-content: space-between; margin-top: 5px; font-weight: bold; }

        /* Tienda */
        #shop-ui { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); width: 220px; padding: 15px; display: none; z-index: 600; }
        .shop-item { background: rgba(255,255,255,0.05); border: 1px solid #334155; padding: 10px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; }
        .shop-item:hover { border-color: var(--primary); background: rgba(56, 189, 248, 0.1); }
        .shop-item.owned { opacity: 0.5; cursor: default; border-color: #22c55e; }

        /* Setup */
        #setup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 30px; text-align: center; z-index: 1000; width: 300px; }
        input { background: #1e293b; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; width: 90%; margin-bottom: 10px; }
        button { background: var(--primary); border: none; padding: 12px; font-weight: bold; border-radius: 8px; cursor: pointer; width: 100%; color: #000; }

        /* Notificaciones */
        #log { position: absolute; bottom: 100px; left: 20px; font-size: 12px; color: var(--gold); pointer-events: none; }

        /* Controles */
        #mobile-controls { position: absolute; inset: 0; pointer-events: none; display: none; }
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: auto; }
        #joystick-stick { position: absolute; top: 30px; left: 30px; width: 40px; height: 40px; background: var(--primary); border-radius: 50%; }
        #attack-btn { position: absolute; bottom: 50px; right: 40px; width: 70px; height: 70px; background: var(--accent); border-radius: 50%; pointer-events: auto; display: flex; justify-content: center; align-items: center; font-size: 24px; }

        #hotbar { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: none; gap: 8px; padding: 8px; }
        .slot { width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; border-radius: 8px; background: rgba(255,255,255,0.05); cursor: pointer; font-size: 20px; }
        .slot.active { background: var(--primary); color: #000; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="game"></canvas>
    
    <div id="setup" class="glass">
        <h2 style="color:var(--primary); margin:0 0 15px 0;">NEO GENESIS II</h2>
        <input type="text" id="playerName" placeholder="Nombre">
        <button onclick="startHost()">CREAR REINO</button>
        <input type="text" id="joinId" placeholder="ID del Host" style="margin-top:10px">
        <button onclick="startJoin()" style="background:#475569; color:white;">UNIRSE</button>
        <div id="status" style="font-size:10px; margin-top:10px;">V 2.0 - Dungeons & Shop</div>
    </div>

    <div id="hud" class="glass" style="display:none">
        <div id="d-name" style="font-weight:bold">---</div>
        <div class="stats-text"><span id="d-lv">LV. 1</span> <span id="d-gold" style="color:var(--gold)">$0</span></div>
        <div class="bar"><div id="hp-fill"></div></div>
        <div class="bar" style="height:3px; margin-top:3px"><div id="xp-fill"></div></div>
    </div>

    <div id="shop-ui" class="glass">
        <h3 style="margin-top:0; font-size:14px; color:var(--gold)">üõí TIENDA ARCANIA</h3>
        <div class="shop-item" onclick="buyItem('katana', 150)">
            <strong>Katana</strong> <span style="color:var(--gold)">$150</span><br><small>Rango +20% | Da√±o +5</small>
        </div>
        <div class="shop-item" onclick="buyItem('gran_hacha', 400)">
            <strong>Gran Hacha</strong> <span style="color:var(--gold)">$400</span><br><small>√Årea de Da√±o 360¬∞</small>
        </div>
        <div class="shop-item" onclick="buyItem('pocion', 50)">
            <strong>Poci√≥n Vida</strong> <span style="color:var(--gold)">$50</span><br><small>Sana 50 HP</small>
        </div>
        <button onclick="toggleShop()" style="background:#334155; color:white; font-size:10px; padding:5px;">CERRAR</button>
    </div>

    <div id="log"></div>

    <div id="mobile-controls">
        <div id="joystick-zone"><div id="joystick-stick"></div></div>
        <div id="attack-btn">‚öîÔ∏è</div>
    </div>

    <div id="hotbar" class="glass">
        <div class="slot active" id="s1" onclick="setSlot(1)">üëä</div>
        <div class="slot" id="s2" onclick="setSlot(2)">‚öîÔ∏è</div>
    </div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth; canvas.height = window.innerHeight;

let world = [], players = {}, slimes = [], connections = {}, peer = null;
let myId = null, isHost = false, selectedSlot = 1, isDead = false;
let camera = { x: 0, y: 0 }, keys = {};
let me = { x: 2000, y: 2000, name: "", hp: 100, maxHp: 100, lv: 1, xp: 0, gold: 0, atkF: 0, items: ['mano'], weapon: 'mano' };

const WEAPONS = {
    'mano': { range: 60, dmg: 10, color: 'white', area: 1.2 },
    'katana': { range: 90, dmg: 20, color: '#38bdf8', area: 1.5 },
    'gran_hacha': { range: 70, dmg: 35, color: '#ef4444', area: 6.28 } // 360 grados
};

// --- RED ---
function startHost() {
    me.name = document.getElementById('playerName').value || "Rey";
    isHost = true;
    for(let x=0; x<60; x++){ world[x]=[]; for(let y=0; y<60; y++) world[x][y]=Math.random()<0.05?1:0; }
    for(let i=0; i<15; i++) spawnSlime();
    peer = new Peer();
    peer.on('open', id => { myId=id; players[id]=me; initGame(); });
    peer.on('connection', conn => {
        conn.on('open', () => { connections[conn.peer]=conn; conn.send({type:'init', world, players, slimes}); });
        conn.on('data', data => handleData(data, conn.peer));
    });
}

function startJoin() {
    const hostId = document.getElementById('joinId').value.trim();
    if(!hostId) return;
    me.name = document.getElementById('playerName').value || "Viajero";
    peer = new Peer();
    peer.on('open', id => {
        myId=id; players[id]=me;
        const conn = peer.connect(hostId);
        conn.on('open', () => { connections[hostId]=conn; conn.send({type:'join', p:me}); initGame(); });
        conn.on('data', data => handleData(data, hostId));
    });
}

function handleData(data, senderId) {
    if (data.type === 'init') { world=data.world; players=data.players; slimes=data.slimes; players[myId]=me; }
    if (data.type === 'join') { players[senderId]=data.p; if(isHost) broadcast({type:'new', id:senderId, p:data.p}); }
    if (data.type === 'new') { players[data.id]=data.p; }
    if (data.type === 'sync') {
        if(!players[senderId]) return;
        Object.assign(players[senderId], data);
        if(isHost) broadcast(data, senderId);
    }
    if (data.type === 'slime_update') slimes = data.slimes;
    if (data.type === 'kill_slime') { if(isHost) slimes = slimes.filter(s => s.id !== data.sid); }
    if (data.type === 'hit') { if(data.tid === myId) takeDamage(data.dmg); }
    if (data.type === 'leave') delete players[data.id];
}

function broadcast(data, skip=null) { for(let id in connections) if(id!==skip) connections[id].send(data); }

// --- LOGICA TIENDA Y LVL ---
function buyItem(id, price) {
    if(me.gold >= price) {
        if(id === 'pocion') { me.hp = Math.min(me.maxHp, me.hp + 50); log("Sanci√≥n aplicada"); }
        else {
            if(me.items.includes(id)) return alert("Ya tienes esta arma");
            me.items.push(id); me.weapon = id; log("¬°Arma comprada!");
        }
        me.gold -= price; updateHUD();
    } else alert("Oro insuficiente");
}

function addXP(amt) {
    me.xp += amt;
    if(me.xp >= 100) { me.lv++; me.xp = 0; me.maxHp += 20; me.hp = me.maxHp; log("¬°SUBISTE DE NIVEL!"); }
    updateHUD();
}

function log(msg) {
    const l = document.getElementById('log');
    l.innerText = msg; setTimeout(() => l.innerText = "", 3000);
}

// --- GAME LOOP ---
function initGame() {
    document.getElementById('setup').style.display='none';
    document.getElementById('hud').style.display='block';
    document.getElementById('hotbar').style.display='flex';
    window.addEventListener('keydown', e => {
        keys[e.key.toLowerCase()]=true;
        if(e.key === 'e') toggleShop();
    });
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()]=false);
    canvas.addEventListener('mousedown', doAttack);
    document.getElementById('attack-btn').onclick = doAttack;
    requestAnimationFrame(loop);
}

function doAttack() {
    if(isDead) return;
    me.atkF = 12;
    const w = WEAPONS[me.weapon];
    
    // Atacar Slimes
    slimes.forEach(s => {
        if(Math.hypot(s.x - me.x, s.y - me.y) < w.range) {
            if(isHost) killSlime(s); 
            else connections[Object.keys(connections)[0]].send({type:'kill_slime', sid: s.id});
        }
    });

    // Atacar Jugadores
    for(let id in players) {
        if(id === myId) continue;
        if(Math.hypot(players[id].x - me.x, players[id].y - me.y) < w.range) {
            let h = {type:'hit', tid: id, dmg: w.dmg};
            if(isHost) broadcast(h); else Object.values(connections)[0].send(h);
        }
    }
}

function killSlime(s) {
    slimes = slimes.filter(sl => sl.id !== s.id);
    addXP(25); me.gold += s.boss ? 50 : 10;
    setTimeout(spawnSlime, 5000);
}

function spawnSlime() {
    let x = Math.random()*3800, y = Math.random()*3800;
    let isBoss = Math.hypot(x-2000, y-2000) > 1200; // Dungeon area
    slimes.push({id: Math.random(), x, y, boss: isBoss, hp: isBoss ? 3 : 1});
}

function toggleShop() {
    const s = document.getElementById('shop-ui');
    s.style.display = s.style.display === 'block' ? 'none' : 'block';
}

function loop() {
    const v = 5;
    if(!isDead) {
        if(keys['a']) me.x-=v; if(keys['d']) me.x+=v; if(keys['w']) me.y-=v; if(keys['s']) me.y+=v;
    }
    if(me.atkF > 0) me.atkF--;
    players[myId] = me;
    camera.x=me.x-canvas.width/2; camera.y=me.y-canvas.height/2;

    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save(); ctx.translate(-camera.x, -camera.y);

    // Dungeons Visual (Suelo oscuro al alejarse)
    let distToSpawn = Math.hypot(me.x-2000, me.y-2000);
    ctx.fillStyle = distToSpawn > 1200 ? "#050505" : "#0d1a0d";
    ctx.fillRect(0,0,4000,4000);

    // Tienda (Zona segura)
    ctx.fillStyle="#fbbf24"; ctx.globalAlpha=0.3;
    ctx.beginPath(); ctx.arc(2000, 2000, 150, 0, 7); ctx.fill(); ctx.globalAlpha=1;
    ctx.fillStyle="white"; ctx.fillText("ZONA SEGURA / TIENDA (E)", 1940, 2000);

    // Slimes
    if(isHost) {
        slimes.forEach(s => {
            let target = null, minDist = 600;
            for(let id in players) {
                let d = Math.hypot(players[id].x-s.x, players[id].y-s.y);
                if(d < minDist) { minDist = d; target = players[id]; }
            }
            if(target) {
                let a = Math.atan2(target.y-s.y, target.x-s.x);
                s.x += Math.cos(a)*(s.boss?2.2:1.5); s.y += Math.sin(a)*(s.boss?2.2:1.5);
                if(minDist < 30) takeDamage(s.boss?0.8:0.3);
            }
        });
        broadcast({type:'slime_update', slimes});
    }
    slimes.forEach(s => {
        ctx.fillStyle = s.boss ? "#ef4444" : "#4ade80";
        ctx.beginPath(); ctx.ellipse(s.x, s.y, s.boss?25:15, s.boss?20:12, 0, 0, 7); ctx.fill();
    });

    // Jugadores
    for(let id in players) {
        let p = players[id];
        if(id !== myId) { p.x+=(p.targetX-p.x)*0.2; p.y+=(p.targetY-p.y)*0.2; }
        else { broadcast({type:'sync', x:me.x, y:me.y, weapon:me.weapon, hp:me.hp, atk:me.atkF, lv:me.lv, gold:me.gold}); }
        
        ctx.fillStyle = id === myId ? "#38bdf8" : "#f472b6";
        ctx.fillRect(p.x-15, p.y-20, 30, 40);
        
        if(p.atk > 0) {
            const w = WEAPONS[p.weapon || 'mano'];
            ctx.strokeStyle = w.color; ctx.lineWidth = 4; ctx.beginPath();
            ctx.arc(p.x, p.y, w.range, -w.area/2, w.area/2); ctx.stroke();
        }
        ctx.fillStyle="white"; ctx.textAlign="center"; ctx.font="10px Arial";
        ctx.fillText(`${p.name} (Lv.${p.lv})`, p.x, p.y-30);
    }

    ctx.restore(); requestAnimationFrame(loop);
}

function takeDamage(a) { 
    me.hp-=a; updateHUD(); 
    if(me.hp<=0 && !isDead) { isDead=true; alert("Has muerto. Perdiste tu oro."); location.reload(); } 
}

function updateHUD() {
    document.getElementById('d-name').innerText = me.name;
    document.getElementById('d-lv').innerText = "LV. " + me.lv;
    document.getElementById('d-gold').innerText = "$" + Math.floor(me.gold);
    document.getElementById('hp-fill').style.width = (me.hp/me.maxHp*100) + "%";
    document.getElementById('xp-fill').style.width = me.xp + "%";
}
function setSlot(n) { selectedSlot=n; document.querySelectorAll('.slot').forEach((s,i)=>s.classList.toggle('active', i===n-1)); }
</script>
</body>
</html>
