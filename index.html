<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nebula RPG Multiplayer P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #ffd700;
            --danger: #ff4444;
            --bg-dark: rgba(20, 20, 20, 0.95);
            --border: 3px solid #5d4037;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; overflow: hidden; background: #000; color: #eee; }
        canvas { display: none; background: #1b3a1a; cursor: crosshair; }

        /* --- INTERFAZ DE MEN√ö --- */
        #main-menu {
            position: fixed; width: 100%; height: 100%; z-index: 1000;
            display: flex; justify-content: center; align-items: center;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://www.transparenttextures.com/patterns/dark-matter.png');
        }
        .window {
            background: var(--bg-dark); padding: 40px; border: var(--border);
            border-radius: 10px; box-shadow: 0 0 50px rgba(0,0,0,0.8); text-align: center; width: 350px;
        }
        h1 { color: var(--primary); text-shadow: 2px 2px #000; margin-bottom: 30px; }
        input, select, button { 
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; 
            border: 1px solid #444; background: #111; color: white; box-sizing: border-box;
        }
        button { 
            background: #8b4513; color: white; font-weight: bold; border: none; 
            cursor: pointer; transition: 0.3s; 
        }
        button:hover { background: var(--primary); color: #000; }

        /* --- INTERFAZ IN-GAME --- */
        .hud-panel { position: fixed; z-index: 100; pointer-events: none; }
        .interactive { pointer-events: auto; }
        
        #top-left { top: 20px; left: 20px; }
        #top-right { top: 20px; right: 20px; }
        #bottom-center { bottom: 20px; left: 50%; transform: translateX(-50%); }

        .glass { background: rgba(0,0,0,0.7); border: 2px solid #555; padding: 15px; border-radius: 8px; }
        
        /* Stats & Oro */
        .stat-badge { font-weight: bold; color: var(--primary); font-size: 1.2em; display: block; margin-bottom: 5px; }
        .player-tag { background: rgba(0,255,0,0.2); padding: 4px 8px; border-radius: 4px; font-size: 0.8em; margin: 2px 0; display: block; }

        /* Barras */
        .bar-container { width: 250px; height: 15px; background: #333; border: 1px solid #000; margin: 5px 0; position: relative; }
        .bar-fill { height: 100%; transition: width 0.3s ease; }
        #hp-fill { background: var(--danger); }
        #xp-fill { background: #0088ff; }

        /* Inventario Emergente */
        #inv-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: none; width: 300px; z-index: 200;
        }
    </style>
</head>
<body>

    <div id="main-menu">
        <div class="window">
            <h1>NEBULA RPG</h1>
            <input type="text" id="in-nick" placeholder="Nickname..." maxlength="12">
            <div style="display: flex; gap: 10px;">
                <div style="flex:1">Ropa: <input type="color" id="in-skin" value="#ffd700"></div>
                <div style="flex:1">Acc: <input type="color" id="in-acc" value="#ff4444"></div>
            </div>
            <button onclick="init(true)">CREAR MUNDO</button>
            <div style="margin: 15px 0; color: #666;">‚Äî o ‚Äî</div>
            <input type="text" id="join-id" placeholder="Pegar ID del Host">
            <button onclick="init(false)" style="background: #2e7d32;">UNIRSE A MUNDO</button>
        </div>
    </div>

    <div id="top-left" class="hud-panel glass">
        <span style="font-size: 0.7em; color: #888;">ID DE SALA:</span>
        <div id="my-id-display" style="color: #0f0; font-size: 0.9em; margin-bottom: 10px;">Cargando...</div>
        <div id="player-list"></div>
    </div>

    <div id="top-right" class="hud-panel glass interactive">
        <span class="stat-badge">üí∞ $<span id="gold-ui">0</span></span>
        <div style="border-top: 1px solid #444; padding-top: 10px;">
            <input type="text" id="live-nick" oninput="syncAppearance()" style="padding: 5px; font-size: 0.8em;">
            <div style="display:flex; gap:5px;">
                <input type="color" id="live-skin" onchange="syncAppearance()">
                <input type="color" id="live-acc" onchange="syncAppearance()">
            </div>
        </div>
    </div>

    <div id="bottom-center" class="hud-panel">
        <div id="level-tag" style="margin-bottom: 5px; font-weight: bold;">NIVEL 1</div>
        <div class="bar-container"><div id="hp-fill" class="bar-fill" style="width: 100%;"></div></div>
        <div class="bar-container" style="height: 5px;"><div id="xp-fill" class="bar-fill" style="width: 0%;"></div></div>
        <div style="font-size: 0.7em; color: #aaa; margin-top: 5px;">[WASD] Mover | [CLICK] Atacar | [I] Inventario</div>
    </div>

    <div id="inv-modal" class="window glass interactive">
        <h2 style="color: var(--primary); margin: 0;">ESTAD√çSTICAS</h2>
        <div style="text-align: left; margin: 20px 0;">
            <p>‚öîÔ∏è Da√±o: <span id="stat-atk">10</span></p>
            <p>üõ°Ô∏è Defensa: <span id="stat-def">5</span></p>
            <p>üìà XP: <span id="stat-xp">0/100</span></p>
        </div>
        <button onclick="toggleInventory()">CERRAR</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const peer = new Peer();

        // --- ESTADO DEL JUEGO ---
        const WORLD_SIZE = 3000;
        let isHost = false;
        let gameRunning = false;
        let gold = 0;
        let animFrame = 0;

        let myData = {
            id: '', x: 1500, y: 1500, nick: 'H√©roe', skin: '#ffd700', acc: '#ff4444',
            hp: 100, maxHp: 100, lv: 1, xp: 0, atk: 15, angle: 0, state: 'idle', dir: 1
        };

        let remotePlayers = {};
        let slimes = [];
        let peers = {};

        // Zona Tienda
        const shopPos = { x: 1450, y: 1450, size: 200 };

        // --- INICIALIZACI√ìN ---
        function init(hostMode) {
            isHost = hostMode;
            myData.nick = document.getElementById('in-nick').value || "Explorador";
            myData.skin = document.getElementById('in-skin').value;
            myData.acc = document.getElementById('in-acc').value;
            
            document.getElementById('live-nick').value = myData.nick;
            document.getElementById('live-skin').value = myData.skin;
            document.getElementById('live-acc').value = myData.acc;

            if(!isHost) {
                const targetId = document.getElementById('join-id').value;
                if(!targetId) return alert("Introduce el ID del Host");
                connectToPeer(targetId);
            }

            gameRunning = true;
            document.getElementById('main-menu').style.display = 'none';
            canvas.style.display = 'block';
            if(isHost) spawnSlimes();
            loop();
        }

        // --- CONEXI√ìN P2P ---
        peer.on('open', (id) => {
            myData.id = id;
            document.getElementById('my-id-display').innerText = id;
        });

        peer.on('connection', (conn) => {
            setupConn(conn);
        });

        function connectToPeer(id) {
            setupConn(peer.connect(id));
        }

        function setupConn(conn) {
            peers[conn.peer] = conn;
            conn.on('data', (data) => {
                if(data.type === 'sync') remotePlayers[data.player.id] = data.player;
                if(data.type === 'world') slimes = data.slimes;
                if(data.type === 'hit') {
                    if(data.target === myData.id) {
                        myData.hp -= data.dmg;
                        if(myData.hp <= 0) respawn();
                    }
                }
                if(data.type === 'slime_hit' && isHost) {
                    let s = slimes.find(s => s.id === data.sId);
                    if(s) s.hp -= data.dmg;
                }
            });
            conn.on('open', () => refreshPlayerList());
            conn.on('close', () => { delete remotePlayers[conn.peer]; refreshPlayerList(); });
        }

        function broadcast(msg) {
            for(let id in peers) if(peers[id].open) peers[id].send(msg);
        }

        // --- L√ìGICA DE JUEGO ---
        function spawnSlimes() {
            for(let i=0; i<25; i++) {
                slimes.push({ id: i, x: Math.random()*WORLD_SIZE, y: Math.random()*WORLD_SIZE, hp: 60, maxHp: 60 });
            }
        }

        const keys = {};
        window.onkeydown = (e) => {
            keys[e.key.toLowerCase()] = true;
            if(e.key.toLowerCase() === 'i') toggleInventory();
        };
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

        function toggleInventory() {
            const modal = document.getElementById('inv-modal');
            modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
            document.getElementById('stat-atk').innerText = myData.atk;
            document.getElementById('stat-xp').innerText = `${myData.xp}/100`;
        }

        function syncAppearance() {
            myData.nick = document.getElementById('live-nick').value;
            myData.skin = document.getElementById('live-skin').value;
            myData.acc = document.getElementById('live-acc').value;
            refreshPlayerList();
        }

        function refreshPlayerList() {
            let html = `<div class="player-tag" style="color:var(--primary)">‚òÖ ${myData.nick}</div>`;
            for(let id in remotePlayers) html += `<div class="player-tag">‚óè ${remotePlayers[id].nick}</div>`;
            document.getElementById('player-list').innerHTML = html;
        }

        window.onmousedown = (e) => {
            if(!gameRunning) return;
            myData.state = 'attack';
            processAttack();
            setTimeout(() => myData.state = 'idle', 150);
        };

        window.onmousemove = (e) => {
            if(!gameRunning) return;
            myData.angle = Math.atan2(e.clientY - window.innerHeight/2, e.clientX - window.innerWidth/2);
            myData.dir = (e.clientX > window.innerWidth/2) ? 1 : -1;
        };

        function processAttack() {
            // Atacar Slimes
            slimes.forEach(s => {
                if(s.hp <= 0) return;
                let dist = Math.hypot(s.x - myData.x, s.y - myData.y);
                if(dist < 80) {
                    if(isHost) s.hp -= myData.atk;
                    else broadcast({ type: 'slime_hit', sId: s.id, dmg: myData.atk });
                    if(s.hp <= 0 && isHost) { gold += 15; myData.xp += 20; checkLevel(); }
                }
            });
            // PvP (Friendly Fire)
            for(let id in remotePlayers) {
                let p = remotePlayers[id];
                if(Math.hypot(p.x - myData.x, p.y - myData.y) < 80) {
                    broadcast({ type: 'hit', target: p.id, dmg: myData.atk });
                }
            }
        }

        function checkLevel() {
            if(myData.xp >= 100) {
                myData.lv++; myData.xp = 0; myData.atk += 5; myData.maxHp += 20; myData.hp = myData.maxHp;
                document.getElementById('level-tag').innerText = `NIVEL ${myData.lv}`;
            }
        }

        function respawn() {
            myData.hp = myData.maxHp; myData.x = 1500; myData.y = 1500;
        }

        function loop() {
            if(!gameRunning) return;
            
            // Movimiento
            let moving = false;
            const s = 5;
            if(keys['w'] && myData.y > 0) { myData.y -= s; moving = true; }
            if(keys['s'] && myData.y < WORLD_SIZE) { myData.y += s; moving = true; }
            if(keys['a'] && myData.x > 0) { myData.x -= s; moving = true; }
            if(keys['d'] && myData.x < WORLD_SIZE) { myData.x += s; moving = true; }
            if(myData.state !== 'attack') myData.state = moving ? 'walk' : 'idle';

            // Tienda
            if(myData.x > shopPos.x && myData.x < shopPos.x + shopPos.size && myData.y > shopPos.y && myData.y < shopPos.y + shopPos.size) {
                if(gold >= 100) { gold -= 100; myData.atk += 2; }
            }

            // Host: IA Slimes
            if(isHost) {
                const targets = [myData, ...Object.values(remotePlayers)];
                slimes.forEach(sl => {
                    if(sl.hp <= 0) return;
                    let nearest = targets.sort((a,b) => Math.hypot(a.x-sl.x, a.y-sl.y) - Math.hypot(b.x-sl.x, b.y-sl.y))[0];
                    let d = Math.hypot(nearest.x - sl.x, nearest.y - sl.y);
                    if(d < 300) {
                        sl.x += (nearest.x - sl.x) * 0.02;
                        sl.y += (nearest.y - sl.y) * 0.02;
                        if(d < 25 && Math.random() < 0.05) {
                            if(nearest.id === myData.id) myData.hp -= 1;
                            // Da√±o a clientes se maneja v√≠a sync de vida si se quisiera, aqu√≠ es local para fluidez
                        }
                    }
                });
                broadcast({ type: 'world', slimes });
            }

            broadcast({ type: 'sync', player: myData });
            
            // UI Update
            document.getElementById('hp-fill').style.width = (myData.hp/myData.maxHp)*100 + "%";
            document.getElementById('xp-fill').style.width = (myData.xp/100)*100 + "%";
            document.getElementById('gold-ui').innerText = gold;

            draw();
            requestAnimationFrame(loop);
        }

        // --- RENDERIZADO ---
        function draw() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const camX = canvas.width/2 - myData.x;
            const camY = canvas.height/2 - myData.y;
            
            ctx.save();
            ctx.translate(camX, camY);

            // Fondo y cuadr√≠cula
            ctx.fillStyle = '#1b3a1a'; ctx.fillRect(0,0, WORLD_SIZE, WORLD_SIZE);
            ctx.strokeStyle = 'rgba(255,255,255,0.05)';
            for(let i=0; i<=WORLD_SIZE; i+=100) {
                ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, WORLD_SIZE); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(WORLD_SIZE, i); ctx.stroke();
            }

            // Tienda (Visual)
            ctx.fillStyle = '#5d4037'; ctx.fillRect(shopPos.x, shopPos.y, shopPos.size, shopPos.size);
            ctx.fillStyle = '#ffd700'; ctx.font = 'bold 20px Arial';
            ctx.fillText("FORJA: +ATK ($100)", shopPos.x + 10, shopPos.y + 100);

            // Slimes
            slimes.forEach(sl => {
                if(sl.hp <= 0) return;
                ctx.fillStyle = '#44ff44';
                ctx.beginPath(); ctx.ellipse(sl.x, sl.y, 18, 14, 0, 0, Math.PI*2); ctx.fill();
                // Barra HP Slime
                ctx.fillStyle = '#000'; ctx.fillRect(sl.x-15, sl.y-25, 30, 4);
                ctx.fillStyle = '#0f0'; ctx.fillRect(sl.x-15, sl.y-25, 30 * (sl.hp/sl.maxHp), 4);
            });

            // Otros Jugadores
            for(let id in remotePlayers) drawChar(remotePlayers[id]);
            
            // Mi Jugador
            drawChar(myData);

            ctx.restore();
            animFrame++;
        }

        function drawChar(p) {
            ctx.save();
            ctx.translate(p.x, p.y);
            
            // Barra HP
            ctx.fillStyle = '#000'; ctx.fillRect(-20, -45, 40, 6);
            ctx.fillStyle = (p.id === myData.id) ? '#0f0' : '#f00';
            ctx.fillRect(-20, -45, 40 * (p.hp/p.maxHp), 6);
            
            // Cuerpo
            let bounce = (p.state === 'walk') ? Math.sin(animFrame * 0.2) * 5 : 0;
            ctx.save();
            ctx.scale(p.dir, 1);
            ctx.fillStyle = p.skin; ctx.fillRect(-15, -15 + bounce, 30, 30);
            ctx.fillStyle = p.acc; ctx.fillRect(-15, -2 + bounce, 30, 6);
            ctx.restore();

            // Nick
            ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.font = 'bold 12px sans-serif';
            ctx.fillText(p.nick, 0, -55);

            // Ataque
            if(p.state === 'attack') {
                ctx.rotate(p.angle);
                ctx.strokeStyle = 'white'; ctx.lineWidth = 4;
                ctx.beginPath(); ctx.arc(20, 0, 35, -0.8, 0.8); ctx.stroke();
            }
            ctx.restore();
        }
    </script>
</body>
</html>
