<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Minecraft 2D P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: sans-serif; }
        canvas { display: block; image-rendering: pixelated; }
        #ui { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.5); pading: 10px; color: white; padding: 15px; border-radius: 8px; }
        button { cursor: pointer; background: #55a630; border: none; color: white; padding: 5px 10px; font-weight: bold; }
    </style>
</head>
<body>

<div id="ui">
    <div id="setup">
        <button onclick="startHost()">Crear Partida (Host)</button>
        <input type="text" id="joinId" placeholder="ID del Host">
        <button onclick="startJoin()">Unirse</button>
    </div>
    <p id="status">Estado: Esperando...</p>
    <p>Usa Flechas para moverte | Click para poner/quitar bloques</p>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const status = document.getElementById('status');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// --- CONFIGURACIÓN DE JUEGO ---
const TILE_SIZE = 32;
let world = []; 
let players = {}; // { id: {x, y, color} }
let myId = null;
let peer = null;
let connections = [];

// Generar mundo básico (Suelo)
for(let x = 0; x < 50; x++) {
    world[x] = [];
    for(let y = 0; y < 20; y++) {
        world[x][y] = y > 10 ? (y === 11 ? 1 : 2) : 0; // 1: Pasto, 2: Tierra, 0: Aire
    }
}

// --- LÓGICA DE RED (P2P) ---
function startHost() {
    peer = new Peer();
    peer.on('open', id => {
        myId = id;
        status.innerText = "ID para invitar: " + id;
        players[id] = { x: 100, y: 100, color: 'red' };
        setupGameLoop();
    });

    peer.on('connection', conn => {
        connections.push(conn);
        conn.on('data', data => handleData(data, conn.peer));
    });
}

function startJoin() {
    const hostId = document.getElementById('joinId').value;
    peer = new Peer();
    peer.on('open', id => {
        myId = id;
        const conn = peer.connect(hostId);
        connections.push(conn);
        conn.on('open', () => {
            status.innerText = "Conectado al Host";
            players[id] = { x: 150, y: 100, color: 'blue' };
            setupGameLoop();
        });
        conn.on('data', data => handleData(data, hostId));
    });
}

function handleData(data, senderId) {
    if (data.type === 'move') {
        players[senderId] = data.pos;
    }
    if (data.type === 'worldUpdate') {
        world[data.x][data.y] = data.block;
    }
}

function broadcast(data) {
    connections.forEach(conn => conn.send(data));
}

// --- BUCLE DE JUEGO ---
function setupGameLoop() {
    document.getElementById('setup').style.display = 'none';
    
    window.addEventListener('keydown', e => {
        let p = players[myId];
        if(e.key === 'ArrowLeft') p.x -= 8;
        if(e.key === 'ArrowRight') p.x += 8;
        if(e.key === 'ArrowUp') p.y -= 8;
        if(e.key === 'ArrowDown') p.y += 8;
        
        broadcast({ type: 'move', pos: p });
    });

    // Construcción/Destrucción
    canvas.addEventListener('mousedown', e => {
        const gridX = Math.floor(e.clientX / TILE_SIZE);
        const gridY = Math.floor(e.clientY / TILE_SIZE);
        const blockType = e.button === 0 ? 2 : 0; // Click izq: Tierra, Click der: Aire
        
        world[gridX][gridY] = blockType;
        broadcast({ type: 'worldUpdate', x: gridX, y: gridY, block: blockType });
    });

    requestAnimationFrame(gameLoop);
}

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Dibujar Mundo
    for(let x = 0; x < world.length; x++) {
        for(let y = 0; y < world[x].length; y++) {
            if(world[x][y] === 1) ctx.fillStyle = '#55a630'; // Pasto
            else if(world[x][y] === 2) ctx.fillStyle = '#795548'; // Tierra
            else continue;
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
        }
    }

    // Dibujar Jugadores
    for(let id in players) {
        ctx.fillStyle = players[id].color;
        ctx.fillRect(players[id].x, players[id].y, 25, 40);
        ctx.fillText(id.substring(0,4), players[id].x, players[id].y - 5);
    }

    requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>
