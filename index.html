<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RPG Top-Down Multiplayer</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #2d5a27; font-family: 'Segoe UI', sans-serif; display: flex; }
        #game-container { position: relative; flex-grow: 1; height: 100vh; }
        canvas { display: block; background: #3e7c37; }
        
        /* Panel Lateral de Servidor */
        #server-panel { width: 300px; background: #1e293b; color: white; padding: 20px; border-left: 4px solid #38bdf8; box-shadow: -5px 0 15px rgba(0,0,0,0.3); z-index: 100; }
        .code-box { background: #0f172a; padding: 10px; border-radius: 5px; color: #38bdf8; font-family: monospace; word-break: break-all; margin: 10px 0; border: 1px solid #334155; }
        
        #ui-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(15,23,42,0.95); padding: 30px; border-radius: 15px; pointer-events: auto; text-align: center; color: white; border: 2px solid #38bdf8; }
        button { background: #38bdf8; border: none; padding: 10px 20px; font-weight: bold; border-radius: 5px; cursor: pointer; margin: 5px; }
        input { padding: 10px; border-radius: 5px; border: none; margin-bottom: 10px; width: 80%; }
        #inventory { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; pointer-events: auto; }
        .slot { width: 45px; height: 45px; background: rgba(0,0,0,0.6); border: 2px solid #64748b; display: flex; justify-content: center; align-items: center; color: white; font-size: 20px; }
        .slot.active { border-color: #38bdf8; box-shadow: 0 0 10px #38bdf8; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="game"></canvas>
    <div id="ui-overlay">
        <div id="setup" class="menu">
            <h2>RPG WORLD CREATOR</h2>
            <input type="text" id="playerName" placeholder="Tu Nombre RPG">
            <button onclick="startHost()">CREAR MUNDO NUEVO</button>
            <hr style="opacity: 0.2; margin: 20px 0;">
            <input type="text" id="joinId" placeholder="ID del Servidor">
            <button onclick="startJoin()">UNIRSE A PARTIDA</button>
        </div>
        <div id="inventory">
            <div class="slot active" id="s1">üõ°Ô∏è</div>
            <div class="slot" id="s2">‚öîÔ∏è</div>
            <div class="slot" id="s3">üèπ</div>
        </div>
    </div>
</div>

<div id="server-panel">
    <h3>üì° INFO DEL SERVIDOR</h3>
    <p style="font-size: 13px; color: #94a3b8;">Comparte este c√≥digo con tus amigos para que entren a tu mundo:</p>
    <div id="id-display" class="code-box">Sin ID generado...</div>
    <button onclick="copyID()" style="width: 100%; font-size: 12px;">Copiar ID</button>
    <hr style="border: 0; border-top: 1px solid #334155; margin: 20px 0;">
    <h4>Jugadores:</h4>
    <div id="player-list" style="font-size: 14px; color: #38bdf8;">- Nadie conectado -</div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth - 300;
canvas.height = window.innerHeight;

const TILE_SIZE = 64;
const WORLD_SIZE = 50; // 50x50 tiles
let world = [];
let players = {};
let connections = {};
let myId = null;
let isHost = false;
let camera = { x: 0, y: 0 };

let me = {
    x: 1000, y: 1000, targetX: 1000, targetY: 1000,
    name: "User", color: `hsl(${Math.random() * 360}, 70%, 60%)`,
    dir: 'down', anim: 0
};

// --- GENERACI√ìN RPG TOP-DOWN ---
function generateRPGWorld() {
    for(let x=0; x<WORLD_SIZE; x++) {
        world[x] = [];
        for(let y=0; y<WORLD_SIZE; y++) {
            let val = 0; // Hierba base
            if(Math.random() < 0.08) val = 1; // √Årbol
            if(Math.random() < 0.04) val = 2; // Roca
            if(Math.random() < 0.02) val = 3; // Arbusto con bayas
            world[x][y] = val;
        }
    }
}

// --- NETWORKING ---
function startHost() {
    isHost = true;
    generateRPGWorld();
    me.name = document.getElementById('playerName').value || "Host";
    const peer = new Peer();
    peer.on('open', id => {
        myId = id; players[id] = me;
        document.getElementById('id-display').innerText = id;
        init();
    });
    peer.on('connection', conn => {
        conn.on('open', () => {
            connections[conn.peer] = conn;
            conn.send({ type: 'init', world, players });
            updatePlayerList();
        });
        conn.on('data', data => handleData(data, conn.peer));
    });
}

function startJoin() {
    const hostId = document.getElementById('joinId').value;
    if(!hostId) return alert("Introduce un ID");
    me.name = document.getElementById('playerName').value || "Viajero";
    const peer = new Peer();
    peer.on('open', id => {
        myId = id; players[id] = me;
        const conn = peer.connect(hostId);
        conn.on('open', () => {
            connections[hostId] = conn;
            conn.send({ type: 'join', p: me });
            init();
        });
        conn.on('data', data => handleData(data, hostId));
    });
}

function handleData(data, senderId) {
    if (data.type === 'init') { world = data.world; players = data.players; }
    if (data.type === 'join') { 
        players[senderId] = data.p; 
        if(isHost) {
            broadcast({type:'new', id:senderId, p:data.p});
            updatePlayerList();
        }
    }
    if (data.type === 'new') players[data.id] = data.p;
    if (data.type === 'sync') {
        if(!players[senderId]) return;
        players[senderId].targetX = data.x;
        players[senderId].targetY = data.y;
        if(isHost) broadcast(data, senderId);
    }
}

function broadcast(data, skipId = null) {
    for(let id in connections) if(id !== skipId) connections[id].send(data);
}

// --- L√ìGICA DE JUEGO ---
let keys = {};
function init() {
    document.getElementById('setup').style.display = 'none';
    window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
    requestAnimationFrame(loop);
}

function loop() {
    const speed = 5;
    let moving = false;
    if(keys['a']) { me.x -= speed; moving = true; }
    if(keys['d']) { me.x += speed; moving = true; }
    if(keys['w']) { me.y -= speed; moving = true; }
    if(keys['s']) { me.y += speed; moving = true; }

    camera.x = me.x - canvas.width/2;
    camera.y = me.y - canvas.height/2;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-camera.x, -camera.y);

    // Dibujar Suelo y Objetos
    for(let x=0; x<WORLD_SIZE; x++) {
        for(let y=0; y<WORLD_SIZE; y++) {
            let tx = x * TILE_SIZE;
            let ty = y * TILE_SIZE;
            
            // Solo dibujar si est√° en c√°mara (Culling)
            if(tx > camera.x - TILE_SIZE && tx < camera.x + canvas.width &&
               ty > camera.y - TILE_SIZE && ty < camera.y + canvas.height) {
                
                // Suelo
                ctx.fillStyle = "#3e7c37";
                ctx.fillRect(tx, ty, TILE_SIZE, TILE_SIZE);
                ctx.strokeStyle = "rgba(0,0,0,0.05)";
                ctx.strokeRect(tx, ty, TILE_SIZE, TILE_SIZE);

                // Objetos
                if(world[x][y] === 1) drawTree(tx + 32, ty + 32);
                if(world[x][y] === 2) drawRock(tx + 32, ty + 32);
                if(world[x][y] === 3) drawBush(tx + 32, ty + 32);
            }
        }
    }

    // Dibujar Jugadores
    for(let id in players) {
        let p = players[id];
        if(id !== myId) {
            p.x += (p.targetX - p.x) * 0.15;
            p.y += (p.targetY - p.y) * 0.15;
        } else if(moving) {
            broadcast({type:'sync', x:me.x, y:me.y});
        }

        // Sombra
        ctx.fillStyle = "rgba(0,0,0,0.2)";
        ctx.beginPath(); ctx.ellipse(p.x+15, p.y+40, 15, 8, 0, 0, Math.PI*2); ctx.fill();

        // Personaje
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 30, 45);
        
        ctx.fillStyle = "white";
        ctx.font = "bold 14px Arial";
        ctx.textAlign = "center";
        ctx.fillText(p.name, p.x + 15, p.y - 10);
    }

    ctx.restore();
    requestAnimationFrame(loop);
}

// --- DIBUJO DE ASSETS ---
function drawTree(x, y) {
    ctx.fillStyle = "#451a03"; ctx.fillRect(x-8, y, 16, 20); // Tronco
    ctx.fillStyle = "#14532d"; ctx.beginPath(); ctx.arc(x, y-10, 25, 0, Math.PI*2); ctx.fill(); // Hojas
}
function drawRock(x, y) {
    ctx.fillStyle = "#64748b"; ctx.beginPath(); ctx.arc(x, y+10, 15, 0, Math.PI*2); ctx.fill();
}
function drawBush(x, y) {
    ctx.fillStyle = "#166534"; ctx.beginPath(); ctx.arc(x, y+10, 12, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "red"; ctx.fillRect(x-2, y+5, 4, 4); // Baya
}

function copyID() {
    const id = document.getElementById('id-display').innerText;
    navigator.clipboard.writeText(id);
    alert("ID Copiado: " + id);
}

function updatePlayerList() {
    const list = document.getElementById('player-list');
    list.innerHTML = Object.values(players).map(p => `‚Ä¢ ${p.name}`).join('<br>');
}
</script>
</body>
</html>
