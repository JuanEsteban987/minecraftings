<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RPG P2P - Fix Visibilidad</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #0f172a; font-family: sans-serif; }
        canvas { display: block; background: #87CEEB; }
        #ui { position: absolute; top: 10px; left: 10px; background: rgba(15, 23, 42, 0.9); color: #38bdf8; padding: 15px; border-radius: 8px; border: 1px solid #38bdf8; z-index: 100; }
        #chat-box { position: absolute; bottom: 10px; right: 10px; width: 250px; background: rgba(0,0,0,0.6); color: white; padding: 10px; border-radius: 5px; }
        #messages { height: 150px; overflow-y: auto; font-size: 12px; margin-bottom: 5px; }
        input { background: #1e293b; border: 1px solid #334155; color: white; padding: 5px; border-radius: 4px; width: 80%; }
        button { background: #38bdf8; border: none; padding: 5px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="ui">
    <div id="setup">
        <input type="text" id="playerName" placeholder="Nick">
        <button onclick="startHost()">HOST</button>
        <input type="text" id="joinId" placeholder="ID Host">
        <button onclick="startJoin()">UNIRSE</button>
    </div>
    <p id="status" style="font-size: 12px; margin: 5px 0;">Configura tu personaje...</p>
</div>

<div id="chat-box" style="display:none;">
    <div id="messages"></div>
    <input type="text" id="chatInput" placeholder="Presiona Enter para hablar">
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let world = [];
let players = {}; 
let connections = {};
let myId = null;
let isHost = false;

let me = {
    x: 100, y: 100,
    targetX: 100, targetY: 100,
    name: "User",
    color: `hsl(${Math.random() * 360}, 70%, 60%)`,
    lvl: 1
};

// Generar Mundo
for(let x=0; x<100; x++){
    world[x] = [];
    for(let y=0; y<30; y++) world[x][y] = y > 15 ? 2 : 0;
}

function startHost() {
    isHost = true;
    me.name = document.getElementById('playerName').value || "Host";
    const peer = new Peer();
    peer.on('open', id => {
        myId = id;
        players[id] = me;
        document.getElementById('status').innerText = "Tu ID: " + id;
        init();
    });
    peer.on('connection', conn => {
        conn.on('open', () => {
            connections[conn.peer] = conn;
            // Enviamos el estado inicial al nuevo
            conn.send({ type: 'init', world, players });
        });
        conn.on('data', data => handleData(data, conn.peer));
    });
}

function startJoin() {
    isHost = false;
    const hostId = document.getElementById('joinId').value;
    me.name = document.getElementById('playerName').value || "Player";
    const peer = new Peer();
    peer.on('open', id => {
        myId = id;
        players[id] = me;
        const conn = peer.connect(hostId);
        conn.on('open', () => {
            connections[hostId] = conn;
            // Avisamos al host que entramos
            conn.send({ type: 'join', p: me });
            init();
        });
        conn.on('data', data => handleData(data, hostId));
    });
}

function handleData(data, senderId) {
    if (data.type === 'init') {
        world = data.world;
        players = data.players;
    }
    if (data.type === 'join') {
        players[senderId] = data.p; // El host registra al invitado
        if(isHost) broadcast({ type: 'new_player', id: senderId, p: data.p });
    }
    if (data.type === 'new_player') {
        players[data.id] = data.p; // Los invitados registran a otros invitados
    }
    if (data.type === 'sync') {
        if(!players[senderId]) return;
        players[senderId].targetX = data.x;
        players[senderId].targetY = data.y;
        if(isHost) broadcast({ type: 'sync', x: data.x, y: data.y }, senderId);
    }
    if (data.type === 'chat') {
        addChatMessage(data.name, data.msg);
    }
}

function broadcast(data, excludeId = null) {
    for (let id in connections) {
        if (id !== excludeId) connections[id].send(data);
    }
}

function init() {
    document.getElementById('setup').style.display = 'none';
    document.getElementById('chat-box').style.display = 'block';
    
    // Controles
    window.addEventListener('keydown', e => {
        if(document.activeElement === document.getElementById('chatInput')) return;
        if(e.key === 'w') me.y -= 10;
        if(e.key === 's') me.y += 10;
        if(e.key === 'a') me.x -= 10;
        if(e.key === 'd') me.x += 10;
        
        const syncData = { type: 'sync', x: me.x, y: me.y };
        if(isHost) broadcast(syncData);
        else connections[Object.keys(connections)[0]].send(syncData);
    });

    // Chat
    document.getElementById('chatInput').addEventListener('keypress', e => {
        if(e.key === 'Enter') {
            const msg = e.target.value;
            if(!msg) return;
            const chatData = { type: 'chat', name: me.name, msg: msg };
            addChatMessage(me.name, msg);
            if(isHost) broadcast(chatData);
            else connections[Object.keys(connections)[0]].send(chatData);
            e.target.value = '';
        }
    });

    requestAnimationFrame(loop);
}

function addChatMessage(name, msg) {
    const div = document.getElementById('messages');
    div.innerHTML += `<div><b>${name}:</b> ${msg}</div>`;
    div.scrollTop = div.scrollHeight;
}

function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Dibujar Mundo
    ctx.fillStyle = "#22c55e";
    for(let x=0; x<world.length; x++){
        for(let y=0; y<world[x].length; y++){
            if(world[x][y] === 2) ctx.fillRect(x*32, y*32, 32, 32);
        }
    }

    // Dibujar Jugadores
    for (let id in players) {
        let p = players[id];
        // Suavizado
        if (id !== myId) {
            p.x += (p.targetX - p.x) * 0.2;
            p.y += (p.targetY - p.y) * 0.2;
        } else {
            p.x = me.x; p.y = me.y;
        }

        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 30, 45);
        ctx.fillStyle = "black";
        ctx.textAlign = "center";
        ctx.fillText(p.name, p.x + 15, p.y - 5);
    }
    requestAnimationFrame(loop);
}
</script>
</body>
</html>
