<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG NEO GENESIS - FIX</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #38bdf8; --accent: #ef4444; --gold: #fbbf24; --glass: rgba(15, 23, 42, 0.95); }
        body { margin: 0; overflow: hidden; background: #070a0e; font-family: 'Segoe UI', sans-serif; color: white; touch-action: none; }
        canvas { display: block; background: #0a0f0a; }
        .glass { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; }
        #room-id-tag { position: absolute; top: 10px; right: 10px; padding: 10px; font-family: monospace; z-index: 1000; display: none; color: var(--primary); border: 1px solid var(--primary); }
        #setup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 30px; text-align: center; z-index: 1000; width: 300px; }
        input { background: #1e293b; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; width: 90%; margin-bottom: 12px; }
        button { background: var(--primary); border: none; padding: 14px; font-weight: bold; border-radius: 8px; cursor: pointer; width: 100%; color: #000; }
        #hud { position: absolute; top: 15px; left: 15px; padding: 12px; z-index: 500; pointer-events: none; display:none; }
        .bar { height: 8px; width: 150px; background: #334155; margin-top: 5px; border-radius: 4px; overflow: hidden; }
        #hp-fill { height: 100%; width: 100%; background: var(--accent); }
    </style>
</head>
<body>

    <div id="room-id-tag" class="glass" onclick="copyId()">ID: ---</div>

    <div id="setup" class="glass">
        <h2 style="color:var(--primary)">NEO GENESIS</h2>
        <input type="text" id="playerName" placeholder="Tu Nombre">
        <button id="hostBtn" onclick="startHost()">CREAR REINO</button>
        <p style="margin:10px; font-size:12px; opacity:0.5">o</p>
        <input type="text" id="joinId" placeholder="ID del Amigo">
        <button onclick="startJoin()" style="background:#475569; color:white;">UNIRSE</button>
        <p id="status" style="font-size:12px; color:var(--gold); margin-top:10px"></p>
    </div>

    <div id="hud" class="glass">
        <div id="d-name">Guerrero</div>
        <div class="bar"><div id="hp-fill"></div></div>
        <div style="color:var(--gold); font-size:12px; margin-top:5px" id="d-gold">$150</div>
    </div>

    <canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth; canvas.height = window.innerHeight;

let players = {}, slimes = [], connections = {}, peer = null, myId = null;
let me = { x: 2000, y: 2000, name: "", hp: 100, gold: 150, weapon: 'Espada', angle: 0, atkF: 0 };

// 1. MEJORADO: Función de Host con manejo de errores
function startHost() {
    const name = document.getElementById('playerName').value;
    if(!name) return alert("Escribe tu nombre");
    me.name = name;

    document.getElementById('status').innerText = "Invocando servidor...";
    document.getElementById('hostBtn').disabled = true;

    // Inicializar PeerJS con servidores de Google para evitar bloqueos
    peer = new Peer(null, {
        debug: 2,
        config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' }]}
    });

    peer.on('open', id => {
        myId = id;
        players[id] = me;
        document.getElementById('room-id-tag').innerText = "SALA ID: " + id;
        document.getElementById('room-id-tag').style.display = "block";
        document.getElementById('setup').style.display = "none";
        document.getElementById('hud').style.display = "block";
        initGame();
        // Crear slimes iniciales
        for(let i=0; i<10; i++) spawnSlime();
    });

    peer.on('connection', conn => {
        conn.on('open', () => {
            connections[conn.peer] = conn;
            conn.send({type:'init', players, slimes});
        });
        conn.on('data', data => handleData(data, conn.peer));
    });

    peer.on('error', err => {
        console.error(err);
        alert("Error de conexión. Prueba abrirlo en una ventana de incógnito o HTTPS.");
        location.reload();
    });
}

function startJoin() {
    const hostId = document.getElementById('joinId').value.trim();
    const name = document.getElementById('playerName').value;
    if(!hostId || !name) return alert("Faltan datos");
    me.name = name;

    peer = new Peer();
    peer.on('open', id => {
        myId = id;
        const conn = peer.connect(hostId);
        conn.on('open', () => {
            connections[hostId] = conn;
            conn.send({type:'join', p:me});
            document.getElementById('setup').style.display = "none";
            document.getElementById('hud').style.display = "block";
            initGame();
        });
        conn.on('data', data => handleData(data, hostId));
    });
}

function handleData(data, senderId) {
    if(data.type === 'init') { players = data.players; slimes = data.slimes; players[myId] = me; }
    if(data.type === 'join') { players[senderId] = data.p; if(peer.id === myId) broadcast({type:'new', id:senderId, p:data.p}); }
    if(data.type === 'new') { players[data.id] = data.p; }
    if(data.type === 'sync') { if(players[senderId]) Object.assign(players[senderId], data); }
}

function broadcast(data) { for(let id in connections) connections[id].send(data); }

function spawnSlime() {
    slimes.push({id: Math.random(), x: 1800+Math.random()*400, y: 1800+Math.random()*400, hp: 50});
}

function initGame() {
    requestAnimationFrame(loop);
}

function loop() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.translate(-me.x + canvas.width/2, -me.y + canvas.height/2);

    // Fondo
    ctx.fillStyle = "#0d1a0d";
    ctx.fillRect(0,0,4000,4000);

    // Dibujar Jugadores
    for(let id in players) {
        let p = players[id];
        ctx.fillStyle = id === myId ? "#38bdf8" : "#ef4444";
        ctx.fillRect(p.x - 15, p.y - 15, 30, 30);
        ctx.fillStyle = "white";
        ctx.fillText(p.name, p.x - 10, p.y - 20);
        
        if(id === myId) {
            // Movimiento simple para test
            if(window.innerWidth < 800) { /* Joystick logic here */ }
            // Enviar posición
            if(myId && connections) broadcast({type:'sync', x:me.x, y:me.y});
        }
    }

    // Dibujar Slimes
    slimes.forEach(s => {
        ctx.fillStyle = "#4ade80";
        ctx.beginPath(); ctx.arc(s.x, s.y, 15, 0, 7); ctx.fill();
    });

    ctx.restore();
    requestAnimationFrame(loop);
}

function copyId() {
    const id = document.getElementById('room-id-tag').innerText.replace("SALA ID: ", "");
    navigator.clipboard.writeText(id);
    alert("¡ID Copiado!");
}
</script>
</body>
</html>
