<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RPG Block World P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a2e; font-family: 'Courier New', Courier, monospace; }
        canvas { display: block; image-rendering: pixelated; }
        #ui { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: #00ff41; padding: 15px; border-radius: 5px; border: 2px solid #00ff41; z-index: 10; }
        input, button { background: #16213e; border: 1px solid #00ff41; color: white; padding: 5px; margin-top: 5px; }
        #hud { position: absolute; bottom: 20px; left: 20px; color: white; text-shadow: 2px 2px black; font-size: 20px; pointer-events: none; }
    </style>
</head>
<body>

<div id="ui">
    <div id="setup">
        <label>Tu Nombre:</label><br>
        <input type="text" id="playerName" placeholder="Escribe tu Nick..."><br>
        <button onclick="startHost()">Ser HOST (Crear Mundo)</button><hr>
        <input type="text" id="joinId" placeholder="ID del Host">
        <button onclick="startJoin()">Unirse a Mundo</button>
    </div>
    <p id="status">Estado: Configura tu personaje</p>
</div>

<div id="hud">
    <div id="stats">Nivel: 1 | XP: 0/100</div>
    <div id="hp-bar" style="width: 200px; height: 10px; background: red; border: 2px solid white;"></div>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const status = document.getElementById('status');
const statsDiv = document.getElementById('stats');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const TILE_SIZE = 40;
let world = []; 
let players = {}; 
let myId = null;
let peer = null;
let connections = [];

// --- INICIALIZACIÓN DE JUGADOR ---
let myData = {
    name: "Invitado",
    x: 200, y: 200,
    hp: 100, lvl: 1, xp: 0,
    color: `hsl(${Math.random() * 360}, 70%, 50%)`
};

// Crear mundo procedural simple
for(let x = 0; x < 100; x++) {
    world[x] = [];
    for(let y = 0; y < 30; y++) {
        world[x][y] = y > 12 ? (y === 13 ? 1 : 2) : 0; // 1: Cesped, 2: Piedra
    }
}

function startHost() {
    myData.name = document.getElementById('playerName').value || "Host";
    peer = new Peer();
    peer.on('open', id => {
        myId = id;
        status.innerText = "ID de Sala: " + id;
        players[id] = myData;
        initGame();
    });
    peer.on('connection', conn => {
        connections.push(conn);
        conn.on('data', data => handleData(data, conn.peer));
        // Al conectar, le pasamos el mundo al nuevo
        setTimeout(() => conn.send({ type: 'syncWorld', world: world }), 500);
    });
}

function startJoin() {
    const hostId = document.getElementById('joinId').value;
    myData.name = document.getElementById('playerName').value || "Jugador";
    peer = new Peer();
    peer.on('open', id => {
        myId = id;
        const conn = peer.connect(hostId);
        connections.push(conn);
        conn.on('open', () => {
            status.innerText = "Conectado al Host";
            players[id] = myData;
            initGame();
        });
        conn.on('data', data => handleData(data, hostId));
    });
}

function handleData(data, senderId) {
    if (data.type === 'update') players[senderId] = data.player;
    if (data.type === 'syncWorld') world = data.world;
    if (data.type === 'blockChange') world[data.x][data.y] = data.block;
}

function broadcast(data) {
    connections.forEach(conn => conn.send(data));
}

function initGame() {
    document.getElementById('setup').style.display = 'none';
    
    // Controles RPG
    window.addEventListener('keydown', e => {
        const speed = 10;
        if(e.key === 'w') myData.y -= speed;
        if(e.key === 's') myData.y += speed;
        if(e.key === 'a') myData.x -= speed;
        if(e.key === 'd') myData.x += speed;
        
        broadcast({ type: 'update', player: myData });
    });

    // Acción RPG: Construir da XP
    canvas.addEventListener('mousedown', e => {
        const gx = Math.floor(e.clientX / TILE_SIZE);
        const gy = Math.floor(e.clientY / TILE_SIZE);
        const isDelete = e.button !== 0;
        
        world[gx][gy] = isDelete ? 0 : 2;
        
        // Ganar XP
        myData.xp += 10;
        if(myData.xp >= 100) {
            myData.lvl++;
            myData.xp = 0;
            alert("¡SUBISTE DE NIVEL! Ahora eres Nivel " + myData.lvl);
        }
        updateHUD();
        
        broadcast({ type: 'blockChange', x: gx, y: gy, block: world[gx][gy] });
        broadcast({ type: 'update', player: myData });
    });

    requestAnimationFrame(gameLoop);
}

function updateHUD() {
    statsDiv.innerText = `Nivel: ${myData.lvl} | XP: ${myData.xp}/100 | Nombre: ${myData.name}`;
}

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Dibujar Mundo
    for(let x = 0; x < world.length; x++) {
        for(let y = 0; y < world[x].length; y++) {
            if(!world[x][y]) continue;
            ctx.fillStyle = world[x][y] === 1 ? '#2d6a4f' : '#4a4e69';
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE - 1, TILE_SIZE - 1);
        }
    }

    // Dibujar Jugadores y Nametags
    for(let id in players) {
        const p = players[id];
        
        // El "Steve"
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 30, 50);

        // Nametag (Nombre + Nivel)
        ctx.fillStyle = "white";
        ctx.font = "bold 14px Arial";
        ctx.textAlign = "center";
        const tag = `[Lvl ${p.lvl}] ${p.name}`;
        ctx.fillText(tag, p.x + 15, p.y - 10);
    }

    requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>
