<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RPG Ultra Smooth P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #0f172a; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        #ui { position: absolute; top: 20px; left: 20px; background: rgba(15, 23, 42, 0.9); color: #38bdf8; padding: 20px; border-radius: 12px; border: 1px solid #38bdf8; box-shadow: 0 0 20px rgba(0,0,0,0.5); z-index: 100; }
        input { background: #1e293b; border: 1px solid #334155; color: white; padding: 8px; border-radius: 4px; width: 150px; }
        button { background: #38bdf8; border: none; color: #0f172a; padding: 8px 15px; font-weight: bold; border-radius: 4px; cursor: pointer; transition: 0.3s; }
        button:hover { background: #7dd3fc; }
        #hud { position: absolute; bottom: 20px; left: 20px; color: white; pointer-events: none; }
    </style>
</head>
<body>

<div id="ui">
    <div id="setup">
        <input type="text" id="playerName" placeholder="Tu Nick RPG">
        <button onclick="startHost()">Crear Mundo</button>
        <hr style="border: 0; border-top: 1px solid #334155; margin: 15px 0;">
        <input type="text" id="joinId" placeholder="ID del Mundo">
        <button onclick="startJoin()">Unirse</button>
    </div>
    <p id="status">Esperando...</p>
</div>

<div id="hud">
    <div id="stats" style="font-size: 24px; font-weight: bold;">Nivel: 1 | XP: 0</div>
    <div style="width: 250px; height: 12px; background: #334155; border-radius: 6px; overflow: hidden; margin-top: 5px;">
        <div id="xp-bar" style="width: 0%; height: 100%; background: #38bdf8; transition: 0.3s;"></div>
    </div>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const TILE_SIZE = 40;
let world = [];
let players = {}; 
let keys = {};
let myId = null;
let peer = null;
let connections = [];

// Mi personaje con suavizado
let me = {
    id: null,
    name: "Player",
    x: 400, y: 300,
    targetX: 400, targetY: 300, // Para suavizar a otros
    hp: 100, lvl: 1, xp: 0,
    color: `hsl(${Math.random() * 360}, 70%, 60%)`
};

// Generar Mapa
for(let x=0; x<100; x++){
    world[x] = [];
    for(let y=0; y<40; y++) world[x][y] = y > 15 ? (y === 16 ? 1 : 2) : 0;
}

function startHost() {
    me.name = document.getElementById('playerName').value || "Host";
    peer = new Peer();
    peer.on('open', id => {
        myId = id; me.id = id;
        document.getElementById('status').innerText = "Comparte este ID: " + id;
        players[id] = me;
        init();
    });
    peer.on('connection', conn => {
        connections.push(conn);
        conn.on('data', data => handleData(data, conn.peer));
        // Enviar mundo y jugadores actuales al nuevo
        setTimeout(() => conn.send({ type: 'init', world, players }), 500);
    });
}

function startJoin() {
    const hostId = document.getElementById('joinId').value;
    me.name = document.getElementById('playerName').value || "Viajero";
    peer = new Peer();
    peer.on('open', id => {
        myId = id; me.id = id;
        const conn = peer.connect(hostId);
        connections.push(conn);
        conn.on('open', () => {
            document.getElementById('status').innerText = "Conectado";
            players[id] = me;
            init();
        });
        conn.on('data', data => handleData(data, hostId));
    });
}

function handleData(data, senderId) {
    if (data.type === 'init') { world = data.world; players = data.players; }
    if (data.type === 'sync') {
        if (!players[senderId]) players[senderId] = data.p;
        // En lugar de saltar, guardamos la meta para interpolar
        players[senderId].targetX = data.p.x;
        players[senderId].targetY = data.p.y;
        players[senderId].name = data.p.name;
        players[senderId].lvl = data.p.lvl;
    }
    if (data.type === 'block') world[data.x][data.y] = data.b;
}

function init() {
    document.getElementById('ui').style.opacity = "0.3";
    window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
    
    // Enviar mi posición 30 veces por segundo (frecuencia de red)
    setInterval(() => {
        if(myId) connections.forEach(c => c.send({ type: 'sync', p: me }));
    }, 33);

    // Click para bloques
    canvas.addEventListener('mousedown', e => {
        const gx = Math.floor(e.clientX / TILE_SIZE);
        const gy = Math.floor(e.clientY / TILE_SIZE);
        const b = e.button === 0 ? 2 : 0;
        world[gx][gy] = b;
        me.xp += 5;
        if(me.xp >= 100) { me.lvl++; me.xp = 0; }
        connections.forEach(c => c.send({ type: 'block', x: gx, y: gy, b: b }));
    });

    requestAnimationFrame(loop);
}

function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // 1. Moverme a mí (Local)
    const speed = 6;
    if (keys['w'] || keys['arrowup']) me.y -= speed;
    if (keys['s'] || keys['arrowdown']) me.y += speed;
    if (keys['a'] || keys['arrowleft']) me.x -= speed;
    if (keys['d'] || keys['arrowright']) me.x += speed;

    // 2. Dibujar Mundo
    for(let x=0; x<canvas.width/TILE_SIZE + 1; x++){
        for(let y=0; y<canvas.height/TILE_SIZE + 1; y++){
            if(!world[x][y]) continue;
            ctx.fillStyle = world[x][y] === 1 ? "#22c55e" : "#475569";
            ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
        }
    }

    // 3. Dibujar y Suavizar Jugadores
    for (let id in players) {
        let p = players[id];
        
        if (id !== myId) {
            // INTERPOLACIÓN: Se mueve un 15% hacia el objetivo cada frame
            p.x += (p.targetX - p.x) * 0.15;
            p.y += (p.targetY - p.y) * 0.15;
        }

        // Cuerpo
        ctx.fillStyle = p.color;
        ctx.shadowBlur = 10; ctx.shadowColor = p.color;
        ctx.fillRect(p.x, p.y, 30, 50);
        ctx.shadowBlur = 0;

        // Nametag RPG
        ctx.fillStyle = "white";
        ctx.font = "bold 14px 'Segoe UI'";
        ctx.textAlign = "center";
        ctx.fillText(`Lv.${p.lvl} ${p.name}`, p.x + 15, p.y - 15);
        
        // Barra de vida pequeña sobre la cabeza
        ctx.fillStyle = "#ef4444";
        ctx.fillRect(p.x, p.y - 8, 30, 4);
    }

    // Actualizar HUD
    document.getElementById('stats').innerText = `Nivel: ${me.lvl} | XP: ${me.xp}`;
    document.getElementById('xp-bar').style.width = me.xp + "%";

    requestAnimationFrame(loop);
}
</script>
</body>
</html>
