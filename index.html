<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Minecraft RPG Emoji ‚Äî Hotbar drag&drop + wheel + sonidos</title>
<style>
  :root{ --accent:#ffd86b; --ui-bg:rgba(0,0,0,0.7); --slot:#111; --slot-border:#444 }
  html,body{height:100%; margin:0;}
  body{margin:0;background:#222;font-family:Arial, sans-serif;overflow:hidden;color:#eee}
  canvas{display:block;background:#87CEEB; cursor: crosshair;}
  #ui{position:fixed;top:10px;left:10px;background:rgba(0,0,0,0.6);color:#fff;padding:10px;border-radius:10px;font-size:14px;z-index:50;}
  /* INVENTARIO (abre con E) */
  #inventory{
    position:fixed;
    bottom:12px;
    left:50%;
    transform:translateX(-50%) translateY(18px) scale(0.96);
    gap:8px;
    background:var(--ui-bg);
    padding:12px;
    border-radius:10px;
    z-index:160;
    max-width:90vw;
    overflow:auto;
    display:flex;
    align-items:center;
    justify-content:center;
    opacity:0;
    pointer-events:none;
    transition: transform .22s cubic-bezier(.2,.9,.2,1), opacity .22s ease;
  }
  #inventory.open{ transform:translateX(-50%) translateY(0) scale(1); opacity:1; pointer-events:auto; box-shadow:0 12px 40px rgba(0,0,0,0.6); }

  .slot{width:60px;height:60px;background:var(--slot);border:2px solid var(--slot-border);border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-size:26px;position:relative;cursor:pointer;user-select:none;margin:6px;}
  .slot.selected{border-color:var(--accent); box-shadow: 0 0 14px rgba(255,200,90,0.12) inset;}
  .slot.ghost{ opacity:0.28; filter:grayscale(100%);}
  .count{position:absolute;bottom:4px;right:6px;font-size:12px;color:#ddd}
  #craftMenu{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#111;padding:16px;border-radius:12px;display:none;color:white;z-index:170;}
  button{margin:6px;padding:8px 12px;cursor:pointer;border-radius:8px;border:0;background:#3dbb3d;color:#042; font-weight:600;}
  button.ghost{ background:#333; color:#ddd; }
  #equip{position:fixed; top:10px; right:10px; background:rgba(0,0,0,0.6); color:white; padding:10px; border-radius:10px; display:grid; grid-template-columns:repeat(2,64px); gap:8px; align-items:center; z-index:50;}
  .equip-slot{width:64px; height:64px; background:var(--slot); border:2px solid var(--slot-border); border-radius:8px; display:flex;align-items:center;justify-content:center;font-size:26px; position:relative; cursor:pointer;}
  .equip-label{font-size:12px; text-align:center; color:#ddd; grid-column:span 2;}
  .highlight { box-shadow: 0 0 8px 2px rgba(156,204,255,0.06) inset; border-color: #9cf !important; }

  /* HOTBAR */
  #hotbar{ position:fixed; bottom:88px; left:50%; transform:translateX(-50%); display:flex; gap:8px; z-index:140; align-items:center; }
  .hot-slot{ width:56px; height:56px; background:rgba(0,0,0,0.55); border:2px solid #333; border-radius:8px; display:flex;align-items:center;justify-content:center; color:#fff; font-size:22px; position:relative; cursor:pointer; user-select:none; transition: transform .08s ease, box-shadow .12s ease; }
  .hot-slot .num{ position:absolute; left:6px; top:4px; font-size:11px; color:#ccc; }
  .hot-slot.selected{ border-color:var(--accent); box-shadow:0 0 18px rgba(255,200,90,0.12) inset; transform:translateY(-4px) scale(1.02); }
  .hot-slot .count{ position:absolute; right:4px; bottom:4px; font-size:11px; color:#ddd; }

  /* small context menu for hotbar */
  .hot-context{ position:fixed; z-index:9999; background:#111; border:1px solid #333; padding:6px; border-radius:6px; display:none; color:#fff; font-size:13px; }
  .hot-context button{ background:#222; color:#fff; border-radius:6px; padding:6px 8px; margin:4px 0; display:block; width:100%; text-align:left; }

  /* pause overlay cuando inventario */
  #pauseOverlay{ position:fixed; inset:0; background:rgba(0,0,0,0.28); z-index:150; display:none; pointer-events:none; }

  /* main menu, saves, etc (estilos previos simplificados) */
  #mainMenu{ position:fixed; inset:0; background:#111; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px; z-index:999; color:white; }
  #mainMenu h1{ font-size:42px; margin-bottom:4px; }
  #savePanel{ position:fixed; right:12px; bottom:72px; width:360px; max-height:70vh; overflow:auto; background:rgba(0,0,0,0.92); color:#fff; padding:12px; border-radius:10px; z-index:90; display:none; box-shadow:0 8px 40px rgba(0,0,0,0.8); transition: transform .28s ease, opacity .28s ease; }

  @media (max-width:700px){
    #inventory{ left:50%; bottom:8px; transform:translateX(-50%); }
    .slot{width:48px;height:48px;font-size:22px;}
    .hot-slot{ width:44px; height:44px; font-size:18px; }
  }
</style>
</head>
<body>

<!-- MAIN MENU -->
<div id="mainMenu">
  <h1>Minecraft RPG Emoji</h1>
  <div class="subtitle">Arrastra a la hotbar, rueda para seleccionar, E abre inventario (pausa)</div>
  <div style="display:flex;gap:10px">
    <button onclick="startNewWorld('survival')">üå≤ Nuevo ‚Äî Survival</button>
    <button class="ghost" onclick="startNewWorld('creative')">üß± Nuevo ‚Äî Creativo</button>
    <button class="ghost" onclick="openWorldSelector()">üìÅ Seleccionar Mundo</button>
  </div>
  <div style="margin-top:8px;font-size:13px;color:#ccc">Arrastra desde inventario ‚Üí hotbar. Click derecho en hotbar = asignar/limpiar.</div>
</div>

<canvas id="game"></canvas>
<div id="ui"></div>

<!-- Equipamiento -->
<div id="equip">
  <div class="equip-label">Equipamiento</div>
  <div id="equip-weapon" class="equip-slot" title="Arma (suelta aqu√≠)"></div>
  <div id="equip-head" class="equip-slot" title="Cabeza (suelta aqu√≠)"></div>
  <div id="equip-chest" class="equip-slot" title="Pecho (suelta aqu√≠)"></div>
  <div id="equip-legs" class="equip-slot" title="Piernas (suelta aqu√≠)"></div>
  <div id="equip-boots" class="equip-slot" title="Botas (suelta aqu√≠)"></div>
</div>

<!-- pause overlay -->
<div id="pauseOverlay"></div>

<!-- Save / Quick UI -->
<button id="openSavesBtn" title="Abrir Guardar/Cargar" style="position:fixed; right:12px; bottom:10px; z-index:95;">üíæ Guardar/Cargar</button>

<!-- HOTBAR -->
<div id="hotbar" aria-hidden="false"></div>

<!-- inventory -->
<div id="inventory" role="dialog" aria-label="Inventario"></div>

<!-- Hotbar context menu -->
<div id="hotContext" class="hot-context"></div>

<!-- Save panel (simplified) -->
<div id="savePanel"></div>

<script>
/* ================= CONFIG & STATE ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const ui = document.getElementById("ui");
const invUI = document.getElementById("inventory");
const hotbarEl = document.getElementById("hotbar");
const pauseOverlay = document.getElementById("pauseOverlay");
const hotContext = document.getElementById("hotContext");
const openSavesBtn = document.getElementById("openSavesBtn");
const mainMenu = document.getElementById("mainMenu");
const savePanel = document.getElementById("savePanel");

canvas.width = innerWidth;
canvas.height = innerHeight;

const TILE = 58;
const WORLD_W = 80;
const WORLD_H = 80;

let gameStarted = false;
let gameMode = null; // "survival"|"creative"
let worldMenuOpen = false;
let inventoryOpen = false;

const sprites = {
  tree: "üå≥", stone: "üóø", coal: "‚ö´", player: "üßô", enemy: "üëπ",
  woodBlock: "üß±", stoneBlock: "‚¨ú", plank: "ü™µ", apple: "üçé",
  sword: "‚öîÔ∏è", pickaxe: "‚õèÔ∏è", helmet: "ü™ñ", chestplate: "üõ°Ô∏è", leggings: "ü©≥", boots: "üë¢",
  iron: "‚õìÔ∏è", gold: "ü•á", mithril: "üî∑", diamond: "üíé", ruby: "üî¥"
};
const itemIcons = {
  wood: "üå≥", stone: "üóø", plank: "ü™µ", woodBlock: "üß±", stoneBlock: "‚¨ú",
  coal: "‚ö´", apple: "üçé", sword: "‚öîÔ∏è", pickaxe: "‚õèÔ∏è", helmet: "ü™ñ", chestplate: "üõ°Ô∏è", leggings: "ü©≥", boots: "üë¢",
  iron: "‚õìÔ∏è", gold: "ü•á", mithril: "üî∑", diamond: "üíé", ruby: "üî¥"
};

let world = [];
let player = null;
let enemies = [];
let keys = {};
let camX=0, camY=0;
const placeable = new Set(["woodBlock","stoneBlock"]);
let moveCD = 0, MOVE_DELAY = 10;
let selected = null; // item id selected for placement/viewing
let hotbar = new Array(9).fill(null);
let hotbarIndex = 0;

/* ========== AUDIO (open/close inventory + assign) ========== */
function playTone(f=880, dur=120, vol=0.02, type='sine'){
  try {
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const actx = new AudioCtx();
    const o = actx.createOscillator();
    const g = actx.createGain();
    o.type = type;
    o.frequency.value = f;
    g.gain.value = vol;
    o.connect(g); g.connect(actx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); try{ actx.close(); }catch(e){} }, dur);
  } catch(e){ /* ignore */ }
}
function soundOpenInventory(){ playTone(660,140,0.02,'triangle'); playTone(880,140,0.01,'sine'); }
function soundCloseInventory(){ playTone(420,120,0.02,'sine'); }
function soundAssignSlot(){ playTone(1200,90,0.02,'sine'); }

/* ========== WORLD CREATION ========== */
function genSeed(){ return Math.floor(Math.random()*0xFFFFFFFF); }
function createNewWorld(seed=null){
  world = [];
  for (let y=0;y<WORLD_H;y++){
    world[y]=[];
    for (let x=0;x<WORLD_W;x++){
      const r = Math.random();
      if (r < 0.12) world[y][x]="tree";
      else if (r < 0.20) {
        if (Math.random()<0.06) world[y][x]="coal"; else world[y][x]="stone";
      } else if (r < 0.22) world[y][x]="iron";
      else if (r < 0.225) world[y][x]="gold";
      else if (r < 0.227) world[y][x]="mithril";
      else if (r < 0.231) world[y][x]="diamond";
      else if (r < 0.235) world[y][x]="ruby";
      else world[y][x]="grass";
    }
  }
  player = {
    x: Math.floor(WORLD_W/2), y: Math.floor(WORLD_H/2),
    hp:100, maxHp:100, baseAtk:8, atk:8,
    defensePercent:0, extraMaxHp:0,
    inv: { wood:0, stone:0, plank:0, woodBlock:0, stoneBlock:0, coal:0, apple:0, sword:0, pickaxe:0, helmet:0, chestplate:0, leggings:0, boots:0, iron:0, gold:0, mithril:0, diamond:0, ruby:0 },
    equipment: { weapon:null, head:null, chest:null, legs:null, boots:null }
  };
  enemies = [];
  for (let i=0;i<25;i++) enemies.push({ x:Math.floor(Math.random()*WORLD_W), y:Math.floor(Math.random()*WORLD_H), hp:28, atk:6, moveCD:Math.floor(Math.random()*30), attackCD:0 });
  populateHotbarAuto();
}

/* ========== HOTBAR RENDER & DRAG/DROP ========== */
function populateHotbarAuto(){
  const order = ["wood","stone","plank","woodBlock","stoneBlock","coal","apple","sword","pickaxe","helmet","chestplate","leggings","boots","iron","gold","mithril","diamond","ruby"];
  hotbar.fill(null);
  let i=0;
  for (const id of order){
    if (i>=9) break;
    if ((player.inv[id]||0)>0){ hotbar[i]=id; i++; }
  }
  hotbarIndex = 0; renderHotbar();
}
function renderHotbar(){
  hotbarEl.innerHTML = "";
  for (let i=0;i<9;i++){
    const slot = document.createElement("div");
    slot.className = "hot-slot" + (hotbarIndex===i ? " selected" : "");
    slot.dataset.index = i;
    const num = document.createElement("div"); num.className = "num"; num.textContent = (i+1);
    slot.appendChild(num);
    const id = hotbar[i];
    if (id){
      const ic = document.createElement("div"); ic.textContent = itemIcons[id]||id;
      slot.appendChild(ic);
      const cnt = document.createElement("div"); cnt.className = "count"; cnt.textContent = (gameMode==="creative") ? "‚àû" : (player.inv[id]||0);
      slot.appendChild(cnt);
    }
    // click selects
    slot.addEventListener("click", (ev)=> {
      hotbarIndex = i; selected = hotbar[i]; renderHotbar(); drawInv();
    });
    // right-click: assign currently selected inventory item to this slot (or clear if none)
    slot.addEventListener("contextmenu", (ev)=>{
      ev.preventDefault();
      showHotContext(i, ev.clientX, ev.clientY);
    });
    // drag & drop handlers (accept items dragged from inventory)
    slot.addEventListener("dragover", (ev)=>{ ev.preventDefault(); slot.style.boxShadow = "0 0 8px rgba(200,200,255,0.06) inset"; });
    slot.addEventListener("dragleave", ()=>{ slot.style.boxShadow = ""; });
    slot.addEventListener("drop", (ev)=> {
      ev.preventDefault();
      slot.style.boxShadow = "";
      const id = ev.dataTransfer.getData("text/plain") || ev.dataTransfer.getData("item");
      if (!id) return;
      hotbar[i] = id;
      renderHotbar();
      soundAssignSlot();
    });
    hotbarEl.appendChild(slot);
  }
}

/* small context menu: assign or clear */
function showHotContext(index, x, y){
  hotContext.style.left = x + "px";
  hotContext.style.top = y + "px";
  hotContext.innerHTML = "";
  const assignBtn = document.createElement("button");
  assignBtn.textContent = "Asignar item seleccionado a slot " + (index+1);
  assignBtn.onclick = ()=> {
    if (selected){ hotbar[index] = selected; renderHotbar(); soundAssignSlot(); }
    else alert("Selecciona un item en el inventario primero para asignarlo aqu√≠.");
    hotContext.style.display = "none";
  };
  const clearBtn = document.createElement("button");
  clearBtn.textContent = "Limpiar slot " + (index+1);
  clearBtn.onclick = ()=> { hotbar[index] = null; renderHotbar(); hotContext.style.display = "none"; };
  const quickFill = document.createElement("button");
  quickFill.textContent = "Seleccionar primer item disponible";
  quickFill.onclick = ()=> {
    // pick first item in inventory (not zero)
    const keys = Object.keys(player.inv);
    for (const k of keys){ if ((player.inv[k]||0) > 0){ hotbar[index] = k; renderHotbar(); break; } }
    hotContext.style.display = "none";
  };
  hotContext.appendChild(assignBtn);
  hotContext.appendChild(quickFill);
  hotContext.appendChild(clearBtn);
  hotContext.style.display = "block";
  // hide on next click anywhere
  setTimeout(()=> { window.addEventListener("click", hideHotContextOnce); }, 10);
}
function hideHotContextOnce(){ hotContext.style.display = "none"; window.removeEventListener("click", hideHotContextOnce); }

/* ========== INVENTORY DRAW + DRAG START ========== */
function drawInv(){
  invUI.classList.toggle("open", inventoryOpen);
  invUI.style.display = inventoryOpen ? "flex" : "none";
  invUI.innerHTML = "";

  const itemsOrder = [
    ["üå≥","wood"], ["üóø","stone"], ["ü™µ","plank"], ["üß±","woodBlock"], ["‚¨ú","stoneBlock"],
    ["‚ö´","coal"], ["üçé","apple"], ["‚öîÔ∏è","sword"], ["‚õèÔ∏è","pickaxe"],
    ["ü™ñ","helmet"], ["üõ°Ô∏è","chestplate"], ["ü©≥","leggings"], ["üë¢","boots"],
    ["‚õìÔ∏è","iron"], ["ü•á","gold"], ["üî∑","mithril"], ["üíé","diamond"], ["üî¥","ruby"]
  ];
  let any=false;
  itemsOrder.forEach(it=>{
    const id = it[1];
    const count = (gameMode==="creative") ? 999 : (player.inv[id]||0);
    if (count > 0){
      any = true;
      const slot = document.createElement("div");
      slot.className = "slot" + (selected===id? " selected":"");
      slot.draggable = true;
      slot.dataset.item = id;
      slot.innerHTML = (itemIcons[id]||it[0]) + `<div class="count">${count}</div>`;
      // click = equip/use/select
      slot.addEventListener("click", ()=> {
        if (["sword","pickaxe","helmet","chestplate","leggings","boots"].includes(id)){
          equipFromInv(id);
          selected = null;
          drawInv();
          return;
        }
        if (id === "apple"){
          useApple();
          selected = null;
          drawInv(); return;
        }
        if (placeable.has(id)){
          selected = (selected===id? null:id);
          drawInv();
          return;
        }
        selected = (selected===id? null:id);
        drawInv();
      });
      slot.addEventListener("dblclick", ()=> { if (["sword","pickaxe","helmet","chestplate","leggings","boots"].includes(id)) equipFromInv(id); });

      // dragstart -> provide id
      slot.addEventListener("dragstart", (ev)=>{
        ev.dataTransfer.setData("text/plain", id);
        ev.dataTransfer.setData("item", id);
      });

      invUI.appendChild(slot);
    }
  });
  if (!any){
    const hint = document.createElement("div"); hint.style.color="#ddd"; hint.style.padding="8px 12px"; hint.textContent="Inventario vac√≠o ‚Äî recoge recursos";
    invUI.appendChild(hint);
    selected = null;
  }
  drawEquipUI();
  renderHotbar();
}

/* ========== Equip functions ========== */
function isEquippable(id){ return ["sword","pickaxe","helmet","chestplate","leggings","boots"].includes(id); }
function equipFromInv(itemId){
  if (!itemId || (player.inv[itemId] || 0) <= 0) return;
  if (itemId==="sword" || itemId==="pickaxe"){
    if (player.equipment.weapon) player.inv[player.equipment.weapon] = (player.inv[player.equipment.weapon]||0) + 1;
    player.inv[itemId]--; player.equipment.weapon = itemId;
    recalcStats(); drawInv(); drawEquipUI(); return;
  }
  const armorMap = { helmet:"head", chestplate:"chest", leggings:"legs", boots:"boots" };
  if (armorMap[itemId]){
    const slot = armorMap[itemId];
    if (player.equipment[slot]) player.inv[player.equipment[slot]] = (player.inv[player.equipment[slot]]||0)+1;
    player.inv[itemId]--; player.equipment[slot] = itemId;
    recalcStats(); drawInv(); drawEquipUI(); return;
  }
}
function unequipSlot(slot){
  if (!slot) return;
  const val = player.equipment[slot];
  if (!val) return;
  player.inv[val] = (player.inv[val]||0) + 1;
  player.equipment[slot] = null;
  recalcStats(); drawInv(); drawEquipUI();
}
function drawEquipUI(){
  const fill = (slotElem, type) => {
    slotElem.innerHTML = "";
    const equippedId = (type==="weapon") ? player.equipment.weapon : (type==="head"?player.equipment.head:(type==="chest"?player.equipment.chest:(type==="legs"?player.equipment.legs:player.equipment.boots)));
    if (equippedId){
      const d = document.createElement("div"); d.className="slot"; d.textContent = itemIcons[equippedId] || "?"; slotElem.appendChild(d);
    } else {
      const ghost = document.createElement("div"); ghost.className="slot ghost"; ghost.textContent = (type==="weapon"?"‚öîÔ∏è": type==="head"?"ü™ñ": type==="chest"?"üõ°Ô∏è": type==="legs"?"üëñ":"ü•æ"); slotElem.appendChild(ghost);
    }
    if (type==="weapon"){
      slotElem.onclick = ()=> { if (player.equipment.weapon){ player.inv[player.equipment.weapon] = (player.inv[player.equipment.weapon]||0)+1; player.equipment.weapon=null; recalcStats(); drawInv(); drawEquipUI(); } };
    } else {
      const map = { head:"head", chest:"chest", legs:"legs", boots:"boots" };
      slotElem.onclick = ()=> unequipSlot(map[type]);
    }
  };
  fill(document.getElementById("equip-weapon"), "weapon");
  fill(document.getElementById("equip-head"), "head");
  fill(document.getElementById("equip-chest"), "chest");
  fill(document.getElementById("equip-legs"), "legs");
  fill(document.getElementById("equip-boots"), "boots");
}

/* ========== Movement, enemies, recolecci√≥n ========== */
function recalcStats(){
  player.atk = player.baseAtk; player.defensePercent = 0; player.extraMaxHp = 0;
  if (player.equipment.weapon==="sword") player.atk+=8;
  if (player.equipment.weapon==="pickaxe") player.atk+=2;
  if (player.equipment.head==="helmet"){ player.defensePercent+=0.06; player.extraMaxHp+=6; }
  if (player.equipment.chest==="chestplate"){ player.defensePercent+=0.28; player.extraMaxHp+=22; }
  if (player.equipment.legs==="leggings"){ player.defensePercent+=0.12; player.extraMaxHp+=10; }
  if (player.equipment.boots==="boots"){ player.defensePercent+=0.05; player.extraMaxHp+=4; }
  player.defensePercent = Math.min(player.defensePercent, 0.7);
  player.maxHp = 100 + player.extraMaxHp; if (player.hp > player.maxHp) player.hp = player.maxHp;
}
function isBlockingTile(tile){ return tile==="tree"||tile==="stone"||tile==="woodBlock"||tile==="stoneBlock"||tile==="iron"||tile==="gold"||tile==="mithril"||tile==="diamond"||tile==="ruby"; }
function attemptMove(nx, ny){
  if (nx<0||nx>=WORLD_W||ny<0||ny>=WORLD_H) return false;
  if (isBlockingTile(world[ny][nx])) return false;
  for (let i=enemies.length-1;i>=0;i--){ if (enemies[i].x===nx && enemies[i].y===ny){ enemies[i].hp -= player.atk; if (enemies[i].hp<=0) enemies.splice(i,1); else { const dmg = enemies[i].atk*(1-player.defensePercent); if (gameMode!=="creative"){ player.hp -= dmg; if (player.hp<0) player.hp=0; } } return false; } }
  player.x = nx; player.y = ny; return true;
}
function movePlayer(){
  if (moveCD>0) return;
  let moved=false;
  if (keys["w"]){ if (attemptMove(player.x, player.y-1)) moved=true; }
  else if (keys["s"]){ if (attemptMove(player.x, player.y+1)) moved=true; }
  else if (keys["a"]){ if (attemptMove(player.x-1, player.y)) moved=true; }
  else if (keys["d"]){ if (attemptMove(player.x+1, player.y)) moved=true; }
  if (moved) moveCD = MOVE_DELAY;
}
function moveEnemies(){
  for (const e of enemies){
    if (e.moveCD>0) e.moveCD--; else {
      e.moveCD = 14 + Math.floor(Math.random()*18);
      const dx = player.x - e.x, dy = player.y - e.y;
      const dist = Math.abs(dx)+Math.abs(dy);
      let moved=false;
      if (dist < 8){
        const tryOrder = Math.abs(dx)>Math.abs(dy) ? [[Math.sign(dx),0],[0,Math.sign(dy)],[0,-Math.sign(dy)],[-Math.sign(dx),0]] : [[0,Math.sign(dy)],[Math.sign(dx),0],[-Math.sign(dx),0],[0,-Math.sign(dy)]];
        for (const d of tryOrder){
          const nx=e.x+d[0], ny=e.y+d[1];
          if (nx<0||nx>=WORLD_W||ny<0||ny>=WORLD_H) continue;
          if (isBlockingTile(world[ny][nx])) continue;
          if (enemies.some(o=>o!==e && o.x===nx && o.y===ny)) continue;
          e.x = nx; e.y = ny; moved=true; break;
        }
      } else {
        const dirs = [[1,0],[-1,0],[0,1],[0,-1]];
        for (let t=0;t<6 && !moved;t++){ const d=dirs[Math.floor(Math.random()*dirs.length)]; const nx=e.x+d[0], ny=e.y+d[1]; if (nx<0||nx>=WORLD_W||ny<0||ny>=WORLD_H) continue; if (isBlockingTile(world[ny][nx])) continue; if (enemies.some(o=>o!==e && o.x===nx && o.y===ny)) continue; e.x=nx; e.y=ny; moved=true; break; }
      }
    }
    const md = Math.abs(e.x - player.x) + Math.abs(e.y - player.y);
    if (md === 1){
      if (e.attackCD === undefined) e.attackCD = 0;
      if (e.attackCD <= 0){ const dmg = e.atk*(1-player.defensePercent); if (gameMode!=="creative"){ player.hp -= dmg; if (player.hp<0) player.hp=0; } e.attackCD = 24; } else e.attackCD--;
    } else { if (e.attackCD>0) e.attackCD--; }
  }
}

/* ========== Click interactions (collect/place/attack) ========== */
canvas.addEventListener("mousedown", (e)=>{
  const rect = canvas.getBoundingClientRect();
  const tx = Math.floor((e.clientX - rect.left + camX)/TILE);
  const ty = Math.floor((e.clientY - rect.top + camY)/TILE);
  if (inventoryOpen) return; // no interacciones cuando inventario abierto
  if (Math.abs(tx - player.x) > 2 || Math.abs(ty - player.y) > 2) return;
  if (e.button === 0){
    for (let i=enemies.length-1;i>=0;i--){ if (enemies[i].x===tx && enemies[i].y===ty){ enemies[i].hp -= player.atk; if (enemies[i].hp<=0) enemies.splice(i,1); return; } }
    const tile = world[ty]?.[tx]; if (!tile) return;
    if (tile==="tree"){ player.inv.wood++; world[ty][tx]="grass"; if (Math.random()<0.22) player.inv.apple++; drawInv(); }
    else if (tile==="stone"){ player.inv.stone++; if (Math.random()<0.06) player.inv.coal++; world[ty][tx]="grass"; drawInv(); }
    else if (tile==="coal"){ player.inv.coal++; world[ty][tx]="grass"; drawInv(); }
    else if (tile==="iron"){ player.inv.iron++; world[ty][tx]="grass"; drawInv(); }
    else if (tile==="gold"){ player.inv.gold++; world[ty][tx]="grass"; drawInv(); }
    else if (tile==="mithril"){ player.inv.mithril++; world[ty][tx]="grass"; drawInv(); }
    else if (tile==="diamond"){ player.inv.diamond++; world[ty][tx]="grass"; drawInv(); }
    else if (tile==="ruby"){ player.inv.ruby++; world[ty][tx]="grass"; drawInv(); }
  }
  if (e.button === 2){
    const tile = world[ty]?.[tx]; if (!tile) return; if (tile !== "grass") return;
    const sel = selected; if (!sel) return;
    if (!placeable.has(sel)) return;
    if (sel === "woodBlock" && (player.inv.woodBlock > 0 || gameMode === "creative")){ world[ty][tx] = "woodBlock"; if (gameMode!=="creative") player.inv.woodBlock--; drawInv(); }
    else if (sel === "stoneBlock" && (player.inv.stoneBlock > 0 || gameMode === "creative")){ world[ty][tx] = "stoneBlock"; if (gameMode!=="creative") player.inv.stoneBlock--; drawInv(); }
  }
});
canvas.addEventListener("contextmenu", (e)=>{ e.preventDefault(); });

/* ========== Crafting / Use ========== */
function craftPlank(){ if (player.inv.wood >= 1){ player.inv.wood--; player.inv.plank += 4; } drawInv(); }
function craftWoodBlock(){ if (player.inv.plank >= 4){ player.inv.plank -= 4; player.inv.woodBlock += 1; } drawInv(); }
function craftStoneBlock(){ if (player.inv.stone >= 4){ player.inv.stone -= 4; player.inv.stoneBlock += 1; } drawInv(); }
function craftSword(){ if (player.inv.plank >= 2 && player.inv.stone >= 1){ player.inv.plank -= 2; player.inv.stone -= 1; player.inv.sword += 1; } drawInv(); }
function craftPickaxe(){ if (player.inv.stone >= 3 && player.inv.plank >= 2){ player.inv.stone -= 3; player.inv.plank -= 2; player.inv.pickaxe += 1; } drawInv(); }
function craftHelmet(){ if (player.inv.plank >= 3){ player.inv.plank -= 3; player.inv.helmet += 1; } drawInv(); }
function craftChestplate(){ if (player.inv.plank >= 6){ player.inv.plank -= 6; player.inv.chestplate += 1; } drawInv(); }
function craftLeggings(){ if (player.inv.plank >= 5){ player.inv.plank -= 5; player.inv.leggings += 1; } drawInv(); }
function craftBoots(){ if (player.inv.plank >= 2){ player.inv.plank -= 2; player.inv.boots += 1; } drawInv(); }
function useApple(){ if (player.inv.apple > 0){ player.inv.apple--; if (gameMode !== "creative"){ player.hp += 30; if (player.hp > player.maxHp) player.hp = player.maxHp; } } drawInv(); }

/* ========== DRAW WORLD & ENTITIES ========== */
ctx.textAlign = "center"; ctx.textBaseline = "middle";
function draw(){
  camX = player.x * TILE - canvas.width/2 + TILE/2;
  camY = player.y * TILE - canvas.height/2 + TILE/2;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for (let y=0;y<WORLD_H;y++){
    for (let x=0;x<WORLD_W;x++){
      const sx = x*TILE - camX, sy = y*TILE - camY;
      if (sx < -TILE || sy < -TILE || sx > canvas.width || sy > canvas.height) continue;
      ctx.fillStyle = "#3dbb3d"; ctx.fillRect(sx, sy, TILE, TILE);
      const t = world[y][x];
      if (t === "tree"){ ctx.font = `${Math.floor(TILE*0.9)}px serif`; ctx.fillStyle = "#000"; ctx.fillText(sprites.tree, sx + TILE/2, sy + TILE/2 - TILE*0.06); }
      else if (t === "stone"){ ctx.font = `${Math.floor(TILE*0.7)}px serif`; ctx.fillStyle = "#000"; ctx.fillText(sprites.stone, sx + TILE/2, sy + TILE/2 + TILE*0.02); }
      else if (t === "coal"){ ctx.font = `${Math.floor(TILE*0.6)}px serif`; ctx.fillStyle = "#000"; ctx.fillText("‚ö´", sx + TILE/2, sy + TILE/2 + TILE*0.02); }
      else if (t === "woodBlock"){ ctx.font = `${Math.floor(TILE*0.7)}px serif`; ctx.fillStyle = "#000"; ctx.fillText(sprites.woodBlock, sx + TILE/2, sy + TILE/2); }
      else if (t === "stoneBlock"){ ctx.font = `${Math.floor(TILE*0.7)}px serif`; ctx.fillStyle = "#000"; ctx.fillText(sprites.stoneBlock, sx + TILE/2, sy + TILE/2); }
      else if (t === "iron"){ ctx.font = `${Math.floor(TILE*0.62)}px serif`; ctx.fillStyle = "#000"; ctx.fillText(sprites.iron, sx + TILE/2, sy + TILE/2); }
      else if (t === "gold"){ ctx.font = `${Math.floor(TILE*0.62)}px serif`; ctx.fillStyle = "#000"; ctx.fillText(sprites.gold, sx + TILE/2, sy + TILE/2); }
      else if (t === "mithril"){ ctx.font = `${Math.floor(TILE*0.62)}px serif`; ctx.fillStyle = "#000"; ctx.fillText(sprites.mithril, sx + TILE/2, sy + TILE/2); }
      else if (t === "diamond"){ ctx.font = `${Math.floor(TILE*0.65)}px serif`; ctx.fillStyle = "#000"; ctx.fillText(sprites.diamond, sx + TILE/2, sy + TILE/2); }
      else if (t === "ruby"){ ctx.font = `${Math.floor(TILE*0.6)}px serif`; ctx.fillStyle = "#000"; ctx.fillText(sprites.ruby, sx + TILE/2, sy + TILE/2); }
    }
  }
  const entities = enemies.map(e=>({...e, type:'enemy'})); entities.push({...player, type:'player'});
  entities.sort((a,b)=> (a.y - b.y) || (a.x - b.x));
  for (const ent of entities){
    const sx = ent.x*TILE - camX, sy = ent.y*TILE - camY;
    if (sx < -TILE || sy < -TILE || sx > canvas.width || sy > canvas.height) continue;
    const depthOffset = ent.y - player.y; let scale = 1 + (depthOffset * 0.02); scale = Math.max(0.72, Math.min(1.36, scale));
    const cx = sx + TILE/2; const cy = sy + TILE*0.6;
    ctx.beginPath(); ctx.ellipse(cx, cy, (TILE*0.26)*scale, (TILE*0.1)*scale, 0, 0, Math.PI*2); ctx.fillStyle = "rgba(0,0,0,0.32)"; ctx.fill();
    const fontSize = Math.floor(42 * scale); ctx.font = `${fontSize}px serif`; ctx.fillStyle = "#000";
    if (ent.type === 'enemy'){
      ctx.fillText(sprites.enemy, sx + TILE/2, sy + TILE/2 - (TILE*(scale-1))*0.15);
      const barW = TILE*0.6*scale, barH = Math.max(4, 6*scale); const px = sx + TILE/2 - barW/2; const py = sy + TILE*0.06;
      ctx.fillStyle = "black"; ctx.fillRect(px-1, py-1, barW+2, barH+2); ctx.fillStyle = "red"; ctx.fillRect(px, py, barW * Math.max(0, ent.hp)/28, barH);
    } else { ctx.fillText(sprites.player, sx + TILE/2, sy + TILE/2 - (TILE*(scale-1))*0.15); }
  }
  ui.innerHTML = `‚ù§Ô∏è ${Math.floor(player.hp)}/${player.maxHp} &nbsp;&nbsp; ATK: ${player.atk} &nbsp;&nbsp; SLOT: ${hotbarIndex+1} ‚Ä¢ Selected: ${selected||"(ninguno)"} ‚Ä¢ E inventario (pausa)`;
}

/* ========== GAME LOOP ========== */
function loop(){
  if (!gameStarted){ requestAnimationFrame(loop); return; }
  if (worldMenuOpen){ requestAnimationFrame(loop); return; }
  if (inventoryOpen){ pauseOverlay.style.display = "block"; requestAnimationFrame(loop); return; }
  pauseOverlay.style.display = "none";
  if (moveCD>0) moveCD--;
  movePlayer();
  moveEnemies();
  recalcStats();
  draw();
  requestAnimationFrame(loop);
}

/* ========== INPUT (keyboard + wheel) ========== */
window.addEventListener("keydown", (e)=>{
  if (e.key === "e"){ e.preventDefault(); toggleInventory(); return; }
  if (/^[1-9]$/.test(e.key) && gameStarted && !inventoryOpen){ const n=parseInt(e.key,10); hotbarIndex = n-1; selected = hotbar[hotbarIndex]; renderHotbar(); drawInv(); }
  if (!inventoryOpen) keys[e.key.toLowerCase()] = true;
  if (!inventoryOpen && e.key.toLowerCase()==='c') toggleCraft();
  if (!inventoryOpen && e.key.toLowerCase()==='u') useApple();
  if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase() === "s"){ e.preventDefault(); const name = "save_"+new Date().toISOString().replace(/[:.]/g,'-'); saveWorld(name); }
});
window.addEventListener("keyup", (e)=>{ keys[e.key.toLowerCase()] = false; });

// wheel for quick hotbar selection when cursor over canvas
let wheelLock = false;
canvas.addEventListener("wheel", (e)=>{
  // prevent page scroll
  e.preventDefault();
  if (!gameStarted) return;
  if (wheelLock) return;
  wheelLock = true;
  setTimeout(()=> wheelLock = false, 80);
  if (e.deltaY > 0) hotbarIndex = (hotbarIndex + 1) % 9;
  else hotbarIndex = (hotbarIndex + 9 - 1) % 9;
  selected = hotbar[hotbarIndex];
  renderHotbar();
  drawInv();
}, { passive:false });

/* ========== INVENTORY TOGGLE + ANIMATIONS/SOUNDS ========== */
function toggleInventory(){
  inventoryOpen = !inventoryOpen;
  if (inventoryOpen){ invUI.classList.add("open"); invUI.style.display = "flex"; soundOpenInventory(); }
  else { invUI.classList.remove("open"); invUI.style.display = "none"; soundCloseInventory(); }
  drawInv();
}

/* ========== HOTBAR / INVENTORY HELPERS ========== */
function refreshHotbarOnInvChange(){
  // remove hotbar entries that no longer exist in inventory (unless creative)
  if (gameMode === "creative"){ renderHotbar(); return; }
  for (let i=0;i<9;i++){ const id=hotbar[i]; if (id && (player.inv[id]||0) <= 0) hotbar[i] = null; }
  // try to fill empty slots with available items
  const order = ["wood","stone","plank","woodBlock","stoneBlock","coal","apple","sword","pickaxe","helmet","chestplate","leggings","boots","iron","gold","mithril","diamond","ruby"];
  for (let i=0;i<9;i++){
    if (!hotbar[i]){
      for (const id of order){ if (!hotbar.includes(id) && (player.inv[id]||0)>0){ hotbar[i]=id; break; } }
    }
  }
  renderHotbar();
}

/* ========== SAVES (lightweight wrappers reused) ========== */
const GAME_VERSION = "1.1.0";
const SAVES_KEY = "mc_rpg_saves";
function getAllSaves(){ try{ const s=localStorage.getItem(SAVES_KEY); return s? JSON.parse(s): {}; } catch(e){ return {}; } }
function persistAllSaves(obj){ localStorage.setItem(SAVES_KEY, JSON.stringify(obj)); }
function makeSaveObject(){
  return { version:GAME_VERSION, timestamp:Date.now(), world: world, player: { x:player.x, y:player.y, inv: player.inv, equipment: player.equipment }, enemies: enemies };
}
function saveWorldWithKey(key){
  if (!key) return alert("Nombre inv√°lido");
  const saves = getAllSaves();
  if (saves[key] && saves[key].timestamp && saves[key].timestamp>0){
    if (!confirm("Sobrescribir "+key+"?")) return;
  }
  saves[key] = makeSaveObject();
  persistAllSaves(saves);
  playTone(880,120,0.02);
  alert("Guardado: "+key);
}
function saveWorld(name){ if (!name) { alert("Escribe nombre."); return; } saveWorldWithKey(name); }
function loadWorld(key){
  const saves = getAllSaves();
  if (!saves[key]) return alert("No encontrado.");
  const s = saves[key];
  world = s.world; player.x = s.player.x; player.y = s.player.y; player.inv = s.player.inv; player.equipment = s.player.equipment; enemies = s.enemies;
  gameMode = "survival";
  gameStarted = true; mainMenu.style.display = "none"; recalcStats(); drawInv(); drawEquipUI(); populateHotbarAuto();
  alert("Cargado: "+key);
}

/* ========== WORLD SELECTOR (simple) ========== */
function openWorldSelector(){ worldMenuOpen = true; document.getElementById("worldSelector")?.classList?.add('open'); }
function closeWorldSelector(){ worldMenuOpen = false; }

/* ========== INIT + UI wiring ========== */
openSavesBtn.onclick = ()=> {
  const saves = getAllSaves(); let html = "<h3>Guardados</h3>";
  for (const k of Object.keys(saves)){ html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #222"><div>${k}</div><div><button onclick="loadWorld('${k}')">Cargar</button><button onclick="(function(){ if(confirm('Eliminar ${k}?')){ const s=getAllSaves(); delete s['${k}']; persistAllSaves(s); alert('Eliminado'); } })()">Eliminar</button></div></div>`; }
  savePanel.innerHTML = html;
  savePanel.style.display = savePanel.style.display === "block" ? "none" : "block";
};

/* populate default world and start UI */
createNewWorld();
drawInv();
drawEquipUI();
renderHotbar();
draw();
loop();

/* ========== Resize handler ========== */
window.addEventListener("resize", ()=>{ canvas.width = innerWidth; canvas.height = innerHeight; draw(); });

/* small guidance */
console.log("Controls: WASD move (cooldown). E open/close inventory (pauses). 1-9 hotbar. Mouse wheel over canvas to cycle hotbar. Drag items from inventory to hotbar. Right-click hotbar to assign/clear.");
</script>
</body>
</html>
