<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RPG - Slime Invasion</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #2d5a27; font-family: 'Segoe UI', sans-serif; display: flex; }
        #game-container { position: relative; flex-grow: 1; height: 100vh; }
        canvas { display: block; background: #3e7c37; }
        #server-panel { width: 280px; background: #1e293b; color: white; padding: 20px; border-left: 4px solid #38bdf8; z-index: 100; }
        .code-box { background: #0f172a; padding: 10px; border-radius: 5px; color: #38bdf8; font-family: monospace; word-break: break-all; margin: 10px 0; }
        .menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(15,23,42,0.95); padding: 30px; border-radius: 15px; pointer-events: auto; text-align: center; color: white; border: 2px solid #38bdf8; z-index: 200; }
        button { background: #38bdf8; border: none; padding: 10px; font-weight: bold; cursor: pointer; border-radius: 5px; width: 100%; margin-top: 10px; }
        #hud { position: absolute; top: 20px; right: 20px; color: white; font-weight: bold; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="game"></canvas>
    <div id="hud">HP: <span id="hp-val">100</span></div>
    <div id="setup" class="menu">
        <h2>SLIME RPG</h2>
        <input type="text" id="playerName" placeholder="Nombre del hÃ©roe" style="padding: 10px; width: 80%;"><br>
        <button onclick="startHost()">CREAR MUNDO</button>
        <button onclick="startJoin()" style="background: #94a3b8;">UNIRSE</button>
        <input type="text" id="joinId" placeholder="ID del Host" style="padding: 10px; width: 80%; margin-top: 10px;">
    </div>
</div>

<div id="server-panel">
    <h3>ðŸ“¡ SERVIDOR</h3>
    <div id="id-display" class="code-box">Generando...</div>
    <h4>JUGADORES</h4>
    <div id="player-list"></div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth - 280;
canvas.height = window.innerHeight;

const TILE_SIZE = 64;
const WORLD_SIZE = 40;
let world = [];
let players = {};
let slimes = [];
let connections = {};
let myId = null;
let isHost = false;
let camera = { x: 0, y: 0 };

let me = {
    x: 500, y: 500, targetX: 500, targetY: 500,
    name: "HÃ©roe", color: "#38bdf8", hp: 100
};

// --- GENERACIÃ“N ---
function initWorld() {
    for(let x=0; x<WORLD_SIZE; x++) {
        world[x] = [];
        for(let y=0; y<WORLD_SIZE; y++) {
            let type = 0;
            if(Math.random() < 0.07) type = 1; // Ãrbol
            if(Math.random() < 0.03) type = 2; // Roca
            world[x][y] = type;
        }
    }
    // Solo el Host genera slimes
    if(isHost) {
        for(let i=0; i<8; i++) spawnSlime();
    }
}

function spawnSlime() {
    slimes.push({
        id: Math.random(),
        x: Math.random() * (WORLD_SIZE * TILE_SIZE),
        y: Math.random() * (WORLD_SIZE * TILE_SIZE),
        size: 20 + Math.random() * 10,
        speed: 1.5 + Math.random()
    });
}

// --- RED ---
function startHost() {
    isHost = true; initWorld();
    me.name = document.getElementById('playerName').value || "Host";
    const peer = new Peer();
    peer.on('open', id => { myId = id; players[id] = me; document.getElementById('id-display').innerText = id; init(); });
    peer.on('connection', conn => {
        conn.on('open', () => {
            connections[conn.peer] = conn;
            conn.send({ type: 'init', world, players, slimes });
        });
        conn.on('data', data => handleData(data, conn.peer));
    });
}

function startJoin() {
    const hostId = document.getElementById('joinId').value;
    me.name = document.getElementById('playerName').value || "Player";
    const peer = new Peer();
    peer.on('open', id => {
        myId = id; players[id] = me;
        const conn = peer.connect(hostId);
        conn.on('open', () => { connections[hostId] = conn; conn.send({ type: 'join', p: me }); init(); });
        conn.on('data', data => handleData(data, hostId));
    });
}

function handleData(data, senderId) {
    if (data.type === 'init') { world = data.world; players = data.players; slimes = data.slimes; }
    if (data.type === 'join') { players[senderId] = data.p; if(isHost) broadcast({type:'new', id:senderId, p:data.p}); }
    if (data.type === 'new') players[data.id] = data.p;
    if (data.type === 'sync') {
        if(players[senderId]) { players[senderId].targetX = data.x; players[senderId].targetY = data.y; }
        if(isHost) { 
            slimes = data.slimes || slimes;
            broadcast({type:'sync', x:data.x, y:data.y, id:senderId, slimes: slimes}, senderId);
        }
    }
    if (data.type === 'slimes_update') slimes = data.slimes;
}

function broadcast(data, skipId = null) {
    for(let id in connections) if(id !== skipId) connections[id].send(data);
}

// --- JUEGO ---
let keys = {};
function init() {
    document.getElementById('setup').style.display = 'none';
    window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
    requestAnimationFrame(loop);
}

function updateSlimes() {
    if(!isHost) return;

    slimes.forEach(s => {
        // Encontrar jugador mÃ¡s cercano
        let target = null;
        let minDist = 500;
        for(let id in players) {
            let dist = Math.hypot(players[id].x - s.x, players[id].y - s.y);
            if(dist < minDist) { minDist = dist; target = players[id]; }
        }

        if(target) {
            let angle = Math.atan2(target.y - s.y, target.x - s.x);
            
            // --- EVITAR OBSTÃCULOS ---
            let nextX = s.x + Math.cos(angle) * s.speed;
            let nextY = s.y + Math.sin(angle) * s.speed;
            
            let gridX = Math.floor(nextX / TILE_SIZE);
            let gridY = Math.floor(nextY / TILE_SIZE);

            if(world[gridX] && world[gridX][gridY] !== 0) {
                // Si hay algo, intenta desviarse 90 grados
                angle += Math.PI / 2;
            }

            s.x += Math.cos(angle) * s.speed;
            s.y += Math.sin(angle) * s.speed;

            // DaÃ±o al jugador
            if(minDist < 20) {
                // LÃ³gica de daÃ±o simplificada
                broadcast({type: 'damage', targetName: target.name});
            }
        }
    });
    broadcast({type: 'slimes_update', slimes: slimes});
}

function loop() {
    const speed = 4;
    if(keys['a']) me.x -= speed;
    if(keys['d']) me.x += speed;
    if(keys['w']) me.y -= speed;
    if(keys['s']) me.y += speed;

    if(isHost) updateSlimes();

    camera.x = me.x - canvas.width/2;
    camera.y = me.y - canvas.height/2;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-camera.x, -camera.y);

    // Dibujar Mundo
    for(let x=0; x<WORLD_SIZE; x++) {
        for(let y=0; y<WORLD_SIZE; y++) {
            if(world[x][y] === 1) { // Ãrbol
                ctx.fillStyle = "#451a03"; ctx.fillRect(x*64+24, y*64+40, 16, 20);
                ctx.fillStyle = "#14532d"; ctx.beginPath(); ctx.arc(x*64+32, y*64+25, 25, 0, Math.PI*2); ctx.fill();
            }
            if(world[x][y] === 2) { // Roca
                ctx.fillStyle = "#64748b"; ctx.beginPath(); ctx.arc(x*64+32, y*64+45, 15, 0, Math.PI*2); ctx.fill();
            }
        }
    }

    // Dibujar Slimes
    slimes.forEach(s => {
        ctx.fillStyle = "rgba(34, 197, 94, 0.8)";
        let bounce = Math.sin(Date.now() / 200) * 5;
        ctx.beginPath();
        ctx.ellipse(s.x, s.y + bounce, s.size, s.size - 5 + bounce, 0, 0, Math.PI*2);
        ctx.fill();
        // Ojos
        ctx.fillStyle = "black";
        ctx.fillRect(s.x-8, s.y+bounce-5, 4, 4); ctx.fillRect(s.x+4, s.y+bounce-5, 4, 4);
    });

    // Dibujar Jugadores
    for(let id in players) {
        let p = players[id];
        if(id !== myId) { p.x += (p.targetX - p.x) * 0.1; p.y += (p.targetY - p.y) * 0.1; }
        else { broadcast({type:'sync', x:me.x, y:me.y}); }
        
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x-15, p.y-20, 30, 40);
        ctx.fillStyle = "white"; ctx.textAlign = "center";
        ctx.fillText(p.name, p.x, p.y - 30);
    }

    ctx.restore();
    requestAnimationFrame(loop);
}
</script>
</body>
</html>
