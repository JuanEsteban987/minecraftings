<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Multiplayer RPG: Reinos por CÃ³digo</title>
    <style>
        :root { --gold: #f1c40f; --green: #2ecc71; --dark: #1e272e; }
        body { margin: 0; background: var(--dark); overflow: hidden; font-family: 'Segoe UI', sans-serif; color: white; }
        
        /* MENÃš DE SERVIDORES */
        #menu-container {
            position: absolute; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle, #2c3e50, #000); z-index: 100;
        }
        .panel {
            background: rgba(44, 62, 80, 0.9); padding: 40px; border-radius: 20px;
            border: 3px solid var(--gold); text-align: center; backdrop-filter: blur(10px);
        }
        input { 
            padding: 12px; width: 250px; border-radius: 8px; border: none; 
            margin: 8px 0; font-size: 16px; text-align: center;
        }
        button {
            padding: 12px 30px; background: var(--green); color: white; border: none;
            border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 15px;
            box-shadow: 0 4px 0 #27ae60;
        }
        button:active { transform: translateY(3px); box-shadow: none; }

        /* HUD JUEGO */
        #game-ui {
            display: none; position: absolute; top: 15px; left: 15px;
            background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px;
            border-left: 5px solid var(--gold); pointer-events: none;
        }
        canvas { display: none; image-rendering: pixelated; }
    </style>
</head>
<body>

    <div id="menu-container">
        <div class="panel">
            <h1 style="color: var(--gold); margin-top:0;">ðŸ‘‘ REINO MULTIJUGADOR</h1>
            <input type="text" id="username" placeholder="Tu Nombre">
            <br>
            <input type="text" id="server-code" placeholder="CÃ³digo del Reino (Ej: 1234)">
            <br>
            <button onclick="conectar()">ENTRAR AL REINO</button>
        </div>
    </div>

    <div id="game-ui">
        <div>REINO: <b id="ui-reino" style="color:var(--gold)"></b></div>
        <div>HÃ‰ROE: <b id="ui-name" style="color:var(--green)"></b></div>
        <div style="font-size: 11px; margin-top:5px; opacity:0.7">WASD: Mover | CLICK: Atacar</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const socket = io();
        const TILE = 40;

        let myId, gameActive = false;
        let players = {}, world = {}, enemies = [];

        function conectar() {
            const nombre = document.getElementById("username").value;
            const codigo = document.getElementById("server-code").value;
            if(!nombre || !codigo) return alert("Faltan datos");

            socket.emit('unirseReino', { codigo, nombre });
            
            document.getElementById("ui-name").innerText = nombre.toUpperCase();
            document.getElementById("ui-reino").innerText = codigo.toUpperCase();
            document.getElementById("menu-container").style.display = "none";
            document.getElementById("game-ui").style.display = "block";
            canvas.style.display = "block";
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            gameActive = true;
            run();
        }

        // --- SOCKETS ---
        socket.on('init', (data) => { myId = data.id; players = data.jugadores; world = data.mundo; });
        socket.on('nuevoJugador', (data) => players[data.id] = data.info);
        socket.on('jugadorMovido', (data) => { if(players[data.id]) { players[data.id].x = data.x; players[data.id].y = data.y; }});
        socket.on('jugadorAtacando', (data) => { 
            if(players[data.id]) {
                players[data.id].attacking = true;
                setTimeout(() => players[data.id].attacking = false, 150);
            }
        });
        socket.on('worldUpdate', (data) => { if(data.type) world[data.key] = data.type; else delete world[data.key]; });
        socket.on('jugadorSeFue', (id) => delete players[id]);

        // --- CONTROLES ---
        window.addEventListener('keydown', (e) => {
            if(!gameActive || !players[myId]) return;
            let nx = players[myId].x, ny = players[myId].y;
            const k = e.key.toLowerCase();
            if (k === 'w') ny -= TILE; if (k === 's') ny += TILE;
            if (k === 'a') nx -= TILE; if (k === 'd') nx += TILE;

            if(!world[`${Math.floor(nx/TILE)},${Math.floor(ny/TILE)}`]) {
                players[myId].x = nx; players[myId].y = ny;
                socket.emit('move', { x: nx, y: ny });
            }
        });

        canvas.addEventListener('mousedown', (e) => {
            if(!gameActive) return;
            socket.emit('attack');
            const gx = Math.floor(e.clientX / TILE), gy = Math.floor(e.clientY / TILE);
            const key = `${gx},${gy}`;
            socket.emit('blockUpdate', { key, type: world[key] ? null : "#7f8c8d" });
        });

        function run() {
            if(!gameActive) return;
            ctx.fillStyle = "#4a7023"; ctx.fillRect(0,0, canvas.width, canvas.height);

            // Bloques
            for(let k in world) {
                const [x, y] = k.split(',').map(Number);
                ctx.fillStyle = world[k]; ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
                ctx.strokeStyle = "rgba(0,0,0,0.2)"; ctx.strokeRect(x*TILE, y*TILE, TILE, TILE);
            }

            // Jugadores
            for(let id in players) {
                const p = players[id];
                ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, TILE, TILE);
                ctx.fillStyle = "white"; ctx.textAlign = "center";
                ctx.fillText(p.nombre, p.x + TILE/2, p.y - 10);

                if(p.attacking) {
                    ctx.fillStyle = "#f1c40f"; ctx.fillRect(p.x + TILE, p.y + 15, 25, 8);
                }
            }
            requestAnimationFrame(run);
        }
    </script>
</body>
</html>
