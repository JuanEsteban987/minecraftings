<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RPG - Neo Genesis</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #38bdf8;
            --accent: #ef4444;
            --bg: #0f172a;
            --glass: rgba(15, 23, 42, 0.85);
        }

        body { margin: 0; overflow: hidden; background: #070a0e; font-family: 'Segoe UI', Roboto, sans-serif; display: flex; color: white; }
        
        /* Contenedor del Juego */
        #game-container { position: relative; flex-grow: 1; height: 100vh; cursor: crosshair; }
        canvas { display: block; filter: saturate(1.2); }

        /* Interfaz Moderna (Glassmorphism) */
        .glass { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; }

        /* Setup / Men√∫ Principal */
        #setup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 40px; text-align: center; z-index: 1000; width: 320px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        #setup h1 { font-size: 24px; margin-bottom: 20px; letter-spacing: 2px; color: var(--primary); }

        input { background: #1e293b; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; width: 90%; margin-bottom: 10px; transition: 0.3s; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 10px rgba(56, 189, 248, 0.3); }

        button { background: var(--primary); border: none; padding: 12px 20px; font-weight: bold; border-radius: 8px; cursor: pointer; color: #000; width: 100%; transition: 0.3s; text-transform: uppercase; }
        button:hover { transform: scale(1.02); filter: brightness(1.1); }

        /* HUD Superior Izquierdo */
        #hud { position: absolute; top: 25px; left: 25px; padding: 15px; min-width: 180px; pointer-events: none; }
        .hp-container { height: 8px; background: #334155; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        #hp-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #ef4444, #f87171); transition: width 0.3s ease; }

        /* Panel lateral de Conexi√≥n */
        #server-panel { width: 280px; padding: 25px; border-left: 1px solid rgba(255,255,255,0.1); background: #0b1120; }
        .code-box { background: #1e293b; padding: 12px; border-radius: 8px; font-family: monospace; color: var(--primary); font-size: 11px; margin: 15px 0; border: 1px dotted var(--primary); cursor: pointer; }

        /* Hotbar */
        #hotbar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; padding: 12px; pointer-events: auto; }
        .slot { width: 55px; height: 55px; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; transition: 0.2s; border-radius: 10px; background: rgba(255,255,255,0.05); }
        .slot.active { background: var(--primary); color: #000; box-shadow: 0 0 20px rgba(56, 189, 248, 0.5); transform: translateY(-5px); }

        /* Pantalla de Muerte */
        #death-screen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); flex-direction: column; align-items: center; justify-content: center; z-index: 2000; pointer-events: auto; }

        #damage-flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: red; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="game"></canvas>
    <div id="damage-flash"></div>
    
    <div id="death-screen">
        <h1 style="color:var(--accent); font-size: 48px;">GUERRERO CA√çDO</h1>
        <button onclick="respawn()" style="width: 200px;">REAPARECER</button>
    </div>

    <div id="hud" class="glass">
        <div id="p-name" style="font-weight: bold; letter-spacing: 1px;">-</div>
        <div class="hp-container"><div id="hp-fill"></div></div>
    </div>

    <div id="setup" class="glass">
        <h1>NEO RPG</h1>
        <input type="text" id="playerName" placeholder="Nombre del Avatar">
        <button onclick="startHost()">Crear Reino</button>
        <div style="margin: 15px; font-size: 12px; opacity: 0.5;">o √∫nete a uno existente</div>
        <input type="text" id="joinId" placeholder="ID del Reino">
        <button onclick="startJoin()" style="background: #64748b; color: white;">Unirse</button>
    </div>

    <div id="hotbar" class="glass" style="display:none;">
        <div class="slot active" id="s1" onclick="setSlot(1)">üëä</div>
        <div class="slot" id="s2" onclick="setSlot(2)">‚öîÔ∏è</div>
        <div class="slot" id="s3" onclick="setSlot(3)">üß±</div>
    </div>
</div>

<div id="server-panel">
    <h3 style="margin-top:0">üì° CONEXI√ìN</h3>
    <p style="font-size: 12px; opacity: 0.6;">Copia el ID para invitar:</p>
    <div id="id-display" class="code-box" onclick="copyId()">Generando ID...</div>
    
    <h4 style="margin-top: 30px; border-bottom: 1px solid #334155; padding-bottom: 10px;">JUGADORES</h4>
    <div id="player-list" style="font-size: 14px; color: var(--primary);"></div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth - 280;
canvas.height = window.innerHeight;

let world = [], players = {}, slimes = [], connections = {}, peer = null;
let myId = null, isHost = false, selectedSlot = 1, isDead = false;
let camera = { x: 0, y: 0 }, keys = {};

// EL FIX: Aseguramos que 'me' sea el mismo objeto dentro de players
let me = { x: 1000, y: 1000, targetX: 1000, targetY: 1000, name: "Invitado", color: "cyan", item: 1, hp: 100 };

function startHost() {
    isHost = true;
    for(let x=0; x<50; x++) { world[x] = []; for(let y=0; y<50; y++) world[x][y] = Math.random()<0.07 ? 1 : 0; }
    for(let i=0; i<10; i++) slimes.push({id: i, x: Math.random()*2500, y: Math.random()*2500});
    
    peer = new Peer();
    peer.on('open', id => { 
        myId = id; 
        players[myId] = me; // Registro local
        document.getElementById('id-display').innerText = id;
        initGame();
    });
    peer.on('connection', conn => {
        conn.on('open', () => {
            connections[conn.peer] = conn;
            conn.send({ type: 'init', world, players, slimes });
        });
        conn.on('data', data => handleData(data, conn.peer));
    });
}

function startJoin() {
    const hostId = document.getElementById('joinId').value.trim();
    peer = new Peer();
    peer.on('open', id => {
        myId = id; 
        players[myId] = me; // Registro local inmediato
        const conn = peer.connect(hostId);
        conn.on('open', () => {
            connections[hostId] = conn;
            conn.send({ type: 'join', p: me });
            initGame();
        });
        conn.on('data', data => handleData(data, hostId));
    });
}

function handleData(data, senderId) {
    if (data.type === 'init') { world = data.world; players = data.players; slimes = data.slimes; players[myId] = me; }
    if (data.type === 'join') { players[senderId] = data.p; if(isHost) broadcast({ type: 'new', id: senderId, p: data.p }); updateUI(); }
    if (data.type === 'new') { players[data.id] = data.p; updateUI(); }
    if (data.type === 'sync') {
        if(!players[senderId]) return;
        players[senderId].targetX = data.x; players[senderId].targetY = data.y;
        players[senderId].item = data.item; players[senderId].hp = data.hp;
        if(isHost) broadcast(data, senderId);
    }
    if (data.type === 'hit') { if(data.targetId === myId) takeDamage(15); }
    if (data.type === 'slime_update' && !isHost) slimes = data.slimes;
}

function broadcast(data, skip = null) {
    for(let id in connections) if(id !== skip) connections[id].send(data);
}

function takeDamage(amt) {
    if(isDead) return;
    me.hp -= amt;
    document.getElementById('hp-fill').style.width = me.hp + "%";
    document.getElementById('damage-flash').style.opacity = 0.3;
    setTimeout(()=> document.getElementById('damage-flash').style.opacity = 0, 100);
    if(me.hp <= 0) { isDead = true; document.getElementById('death-screen').style.display = 'flex'; }
}

function respawn() {
    me.hp = 100; me.x = 1000; me.y = 1000; isDead = false;
    document.getElementById('hp-fill').style.width = "100%";
    document.getElementById('death-screen').style.display = 'none';
}

function initGame() {
    document.getElementById('setup').style.display = 'none';
    document.getElementById('hotbar').style.display = 'flex';
    me.name = document.getElementById('playerName').value || "Guerrero";
    document.getElementById('p-name').innerText = me.name;
    window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
    canvas.addEventListener('mousedown', () => {
        if(selectedSlot === 2) { // Ataque
            for(let id in players) {
                if(id === myId) continue;
                if(Math.hypot(players[id].x - me.x, players[id].y - me.y) < 70) {
                    let h = { type: 'hit', targetId: id };
                    if(isHost) broadcast(h); else Object.values(connections)[0].send(h);
                }
            }
        }
    });
    requestAnimationFrame(loop);
}

function setSlot(n) {
    selectedSlot = n; me.item = n;
    document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
    document.getElementById('s'+n).classList.add('active');
}

function loop() {
    if(!isDead) {
        const vel = 5;
        if(keys['a']) me.x -= vel; if(keys['d']) me.x += vel;
        if(keys['w']) me.y -= vel; if(keys['s']) me.y += vel;
    }

    // El Fix de movimiento: el objeto en players DEBE ser igual a me
    players[myId] = me;

    camera.x = me.x - canvas.width/2;
    camera.y = me.y - canvas.height/2;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-camera.x, -camera.y);

    // Dibujar Mundo
    for(let x=0; x<world.length; x++) {
        for(let y=0; y<world[x].length; y++) {
            if(world[x][y] === 1) {
                ctx.fillStyle = "#1e3a1e"; ctx.beginPath(); ctx.arc(x*64+32, y*64+32, 25, 0, 7); ctx.fill();
            }
        }
    }

    // Slimes (IA Host)
    if(isHost) {
        slimes.forEach(s => {
            let target = me;
            let dist = Math.hypot(target.x - s.x, target.y - s.y);
            if(dist < 400) {
                let angle = Math.atan2(target.y - s.y, target.x - s.x);
                s.x += Math.cos(angle) * 1.5; s.y += Math.sin(angle) * 1.5;
                if(dist < 30) takeDamage(0.3);
            }
        });
        broadcast({ type: 'slime_update', slimes });
    }
    slimes.forEach(s => {
        ctx.fillStyle = "#4ade80"; ctx.beginPath(); ctx.ellipse(s.x, s.y, 16, 12, 0, 0, 7); ctx.fill();
    });

    // Jugadores
    for(let id in players) {
        let p = players[id];
        if(id !== myId) {
            p.x += (p.targetX - p.x) * 0.2; p.y += (p.targetY - p.y) * 0.2;
        } else {
            broadcast({ type: 'sync', x: me.x, y: me.y, item: me.item, hp: me.hp });
        }
        ctx.fillStyle = p.hp <= 0 ? "#444" : (id === myId ? "#38bdf8" : "#f472b6");
        ctx.fillRect(p.x-15, p.y-20, 30, 40);
        ctx.fillStyle = "white"; ctx.textAlign = "center"; 
        ctx.font = "12px sans-serif";
        ctx.fillText(p.name + (p.item==2?" ‚öîÔ∏è":""), p.x, p.y-30);
    }

    ctx.restore();
    requestAnimationFrame(loop);
}

function updateUI() {
    document.getElementById('player-list').innerHTML = Object.values(players).map(p => `‚Ä¢ ${p.name}`).join('<br>');
}
function copyId() {
    navigator.clipboard.writeText(document.getElementById('id-display').innerText);
    alert("ID Copiado");
}
</script>
</body>
</html>
