<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RPG Minecraft 2D - Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .panel { position: absolute; background: rgba(15, 23, 42, 0.9); color: white; padding: 15px; border-radius: 8px; pointer-events: auto; border: 2px solid #38bdf8; }
        #setup { top: 20px; left: 20px; }
        #inventory { bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
        .slot { width: 50px; height: 50px; border: 2px solid #64748b; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; font-weight: bold; }
        .slot.active { border-color: #38bdf8; background: rgba(56, 189, 248, 0.2); }
        input { background: #1e293b; border: 1px solid #334155; color: white; padding: 5px; }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="setup" class="panel">
        <input type="text" id="playerName" placeholder="Nombre">
        <button onclick="startHost()">Crear Mundo</button>
        <input type="text" id="joinId" placeholder="ID Host">
        <button onclick="startJoin()">Unirse</button>
        <div id="status">Esperando...</div>
    </div>

    <div id="inventory">
        <div class="slot active" id="slot1">1<br>üëä</div>
        <div class="slot" id="slot2">2<br>‚öîÔ∏è</div>
        <div class="slot" id="slot3">3<br>üß±</div>
    </div>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// --- CONFIGURACI√ìN ---
const TILE_SIZE = 40;
const WORLD_WIDTH = 200; // Bloques de ancho
const WORLD_HEIGHT = 60;  // Bloques de alto
let world = [];
let players = {};
let connections = {};
let myId = null;
let isHost = false;
let selectedSlot = 1;

// C√°mara
let camera = { x: 0, y: 0 };

// Mi Jugador
let me = {
    x: 1000, y: 500, targetX: 1000, targetY: 500,
    name: "User", color: `hsl(${Math.random() * 360}, 70%, 60%)`,
    hp: 100, item: 1, attacking: 0
};

// --- GENERACI√ìN DE MUNDO ---
function generateWorld() {
    for(let x=0; x<WORLD_WIDTH; x++) {
        world[x] = [];
        for(let y=0; y<WORLD_HEIGHT; y++) {
            let type = 0; // Aire
            if(y > 20) type = 2; // Tierra/Piedra
            if(y === 20) type = 1; // Pasto
            
            // Generar √Årboles (Raro)
            if(y === 19 && Math.random() < 0.1 && x > 5) {
                type = 3; // Tronco
                world[x][y-1] = 4; // Hojas
            }
            // Generar Rocas
            if(y === 19 && Math.random() < 0.05) type = 5; 

            if(!world[x][y]) world[x][y] = type;
        }
    }
}

// --- RED ---
function startHost() {
    isHost = true;
    generateWorld();
    me.name = document.getElementById('playerName').value || "Host";
    const peer = new Peer();
    peer.on('open', id => { 
        myId = id; players[id] = me; 
        document.getElementById('status').innerText = "ID: " + id; 
        init(); 
    });
    peer.on('connection', conn => {
        conn.on('open', () => {
            connections[conn.peer] = conn;
            conn.send({ type: 'init', world, players });
        });
        conn.on('data', data => handleData(data, conn.peer));
    });
}

function startJoin() {
    const hostId = document.getElementById('joinId').value;
    me.name = document.getElementById('playerName').value || "Player";
    const peer = new Peer();
    peer.on('open', id => {
        myId = id; players[id] = me;
        const conn = peer.connect(hostId);
        conn.on('open', () => {
            connections[hostId] = conn;
            conn.send({ type: 'join', p: me });
            init();
        });
        conn.on('data', data => handleData(data, hostId));
    });
}

function handleData(data, senderId) {
    if (data.type === 'init') { world = data.world; players = data.players; }
    if (data.type === 'join') { players[senderId] = data.p; if(isHost) broadcast({type:'new', id:senderId, p:data.p}); }
    if (data.type === 'new') { players[data.id] = data.p; }
    if (data.type === 'sync') {
        if(!players[senderId]) return;
        players[senderId].targetX = data.x;
        players[senderId].targetY = data.y;
        players[senderId].attacking = data.atk;
        players[senderId].item = data.item;
        if(isHost) broadcast(data, senderId);
    }
}

function broadcast(data, skipId = null) {
    for(let id in connections) if(id !== skipId) connections[id].send(data);
}

// --- LOOP PRINCIPAL ---
let keys = {};
function init() {
    document.getElementById('setup').style.display = 'none';
    window.addEventListener('keydown', e => {
        keys[e.key.toLowerCase()] = true;
        if(['1','2','3'].includes(e.key)) {
            selectedSlot = e.key;
            me.item = parseInt(e.key);
            updateUI();
        }
    });
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
    
    canvas.addEventListener('mousedown', () => {
        me.attacking = 15; // Frames de animaci√≥n
    });

    requestAnimationFrame(loop);
}

function updateUI() {
    document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
    document.getElementById('slot' + selectedSlot).classList.add('active');
}

function loop() {
    // 1. L√≥gica de Movimiento Fluido
    const speed = 7;
    if(keys['a']) me.x -= speed;
    if(keys['d']) me.x += speed;
    if(keys['w']) me.y -= speed;
    if(keys['s']) me.y += speed;

    // 2. C√°mara sigue al jugador
    camera.x = me.x - canvas.width/2;
    camera.y = me.y - canvas.height/2;

    // 3. Renderizado
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-camera.x, -camera.y);

    // Dibujar Mundo (Optimizado: Solo lo que se ve)
    let startX = Math.max(0, Math.floor(camera.x / TILE_SIZE));
    let endX = Math.min(WORLD_WIDTH, startX + Math.ceil(canvas.width / TILE_SIZE) + 1);
    
    for(let x=startX; x<endX; x++) {
        for(let y=0; y<WORLD_HEIGHT; y++) {
            let t = world[x][y];
            if(!t) continue;
            if(t === 1) ctx.fillStyle = '#22c55e'; // Pasto
            if(t === 2) ctx.fillStyle = '#78350f'; // Tierra
            if(t === 3) ctx.fillStyle = '#451a03'; // Tronco
            if(t === 4) ctx.fillStyle = '#15803d'; // Hojas
            if(t === 5) ctx.fillStyle = '#64748b'; // Roca
            ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
        }
    }

    // Dibujar Jugadores
    for(let id in players) {
        let p = players[id];
        if(id !== myId) {
            p.x += (p.targetX - p.x) * 0.2;
            p.y += (p.targetY - p.y) * 0.2;
        } else {
            p.x = me.x; p.y = me.y;
            // Enviar datos
            if(frameCount % 2 === 0) broadcast({type:'sync', x:me.x, y:me.y, atk:me.attacking, item:me.item});
        }

        // Cuerpo
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 30, 50);
        
        // Arma/Herramienta
        if(p.item === 2) { // Espada
            ctx.fillStyle = '#cbd5e1';
            let rot = p.attacking > 0 ? 0.8 : 0;
            ctx.save();
            ctx.translate(p.x + 30, p.y + 25);
            ctx.rotate(rot);
            ctx.fillRect(0, -5, 30, 10);
            ctx.restore();
        }

        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.fillText(p.name, p.x + 15, p.y - 10);
        
        if(p.attacking > 0) p.attacking--;
    }

    ctx.restore();
    frameCount++;
    requestAnimationFrame(loop);
}

let frameCount = 0;
</script>
</body>
</html>
