<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG Neo Genesis - 100 Weapons Update</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #38bdf8; --accent: #ef4444; --gold: #fbbf24; --glass: rgba(15, 23, 42, 0.95); }
        body { margin: 0; overflow: hidden; background: #070a0e; font-family: 'Segoe UI', sans-serif; color: white; touch-action: none; }
        canvas { display: block; background: #0a0f0a; }
        .glass { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; }
        
        /* HUD */
        #hud { position: absolute; top: 15px; left: 15px; padding: 12px; min-width: 160px; z-index: 500; pointer-events: none; }
        .bar { height: 6px; border-radius: 3px; margin-top: 5px; overflow: hidden; background: #334155; }
        #hp-fill { height: 100%; width: 100%; background: var(--accent); transition: 0.3s; }
        #xp-fill { height: 100%; width: 0%; background: #a855f7; transition: 0.3s; }
        .stats-text { font-size: 12px; display: flex; justify-content: space-between; margin-top: 5px; font-weight: bold; }

        /* Tienda e Inventario */
        #shop-ui { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); width: 260px; padding: 15px; display: none; z-index: 600; max-height: 80vh; overflow-y: auto; border: 2px solid var(--gold); }
        .shop-item { background: rgba(255,255,255,0.05); border: 1px solid #334155; padding: 8px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; font-size: 13px; }
        .shop-item:active { background: rgba(56, 189, 248, 0.2); }
        .rarity-common { color: #9ca3af; }
        .rarity-rare { color: #3b82f6; font-weight: bold; }
        .rarity-epic { color: #a855f7; font-weight: bold; }
        .rarity-legendary { color: var(--gold); font-weight: bold; text-shadow: 0 0 5px orange; }

        #btn-shop-toggle { position: absolute; top: 15px; right: 15px; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; font-size: 20px; z-index: 500; cursor: pointer; border: 1px solid var(--gold); color: var(--gold); }

        /* Controles */
        #mobile-controls { position: absolute; inset: 0; pointer-events: none; display: none; }
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.05); border-radius: 50%; pointer-events: auto; border: 2px solid rgba(255,255,255,0.1); }
        #joystick-stick { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: var(--primary); border-radius: 50%; }
        #attack-btn { position: absolute; bottom: 50px; right: 40px; width: 85px; height: 85px; background: var(--accent); border-radius: 50%; pointer-events: auto; display: flex; justify-content: center; align-items: center; font-size: 30px; }

        #setup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 30px; text-align: center; z-index: 1000; width: 280px; }
        input { background: #1e293b; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; width: 90%; margin-bottom: 10px; }
        button { background: var(--primary); border: none; padding: 12px; font-weight: bold; border-radius: 8px; cursor: pointer; width: 100%; color: #000; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="game"></canvas>
    
    <div id="setup" class="glass">
        <h2 style="color:var(--primary); margin:0 0 15px 0;">NEO GENESIS: ELITE</h2>
        <input type="text" id="playerName" placeholder="Tu Nombre">
        <button onclick="startHost()">CREAR REINO</button>
        <input type="text" id="joinId" placeholder="ID del Host" style="margin-top:10px">
        <button onclick="startJoin()" style="background:#475569; color:white;">UNIRSE</button>
    </div>

    <div id="hud" class="glass" style="display:none">
        <div id="d-name">---</div>
        <div class="stats-text"><span id="d-lv">LV. 1</span> <span id="d-gold" style="color:var(--gold)">$0</span></div>
        <div class="bar"><div id="hp-fill"></div></div>
        <div class="bar" style="height:3px; margin-top:3px"><div id="xp-fill"></div></div>
    </div>

    <div id="btn-shop-toggle" class="glass" style="display:none" onclick="toggleShop()">游</div>

    <div id="shop-ui" class="glass">
        <h3 style="margin:0 0 10px 0; color:var(--gold)">MERCADO DE ALMAS</h3>
        <div id="shop-list"></div>
        <button onclick="toggleShop()" style="background:#334155; color:white; margin-top:10px">CERRAR</button>
    </div>

    <div id="mobile-controls">
        <div id="joystick-zone"><div id="joystick-stick"></div></div>
        <div id="attack-btn">丘덢잺</div>
    </div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth; canvas.height = window.innerHeight;

let world = [], players = {}, slimes = [], connections = {}, peer = null;
let myId = null, isHost = false, isDead = false;
let camera = { x: 0, y: 0 }, keys = {};
let me = { x: 2000, y: 2000, name: "", hp: 100, maxHp: 100, lv: 1, xp: 0, gold: 1000, atkF: 0, weapon: 'Pu침os' };

// --- BASE DE DATOS MASIVA (100 ARMAS GENERADAS) ---
const WEAPONS = {};
const weaponNames = ["Espada", "Daga", "Hacha", "Lanza", "Maza", "Sable", "Martillo", "Cimitarra", "Guada침a", "Katana"];
const materials = ["Madera", "Hierro", "Acero", "Obsidiana", "Mithril", "Diamante", "Drag칩n", "Celestial", "Abisal", "G칠nesis"];

let count = 0;
for(let m of materials) {
    for(let w of weaponNames) {
        count++;
        let rarity = count < 30 ? 'common' : count < 60 ? 'rare' : count < 90 ? 'epic' : 'legendary';
        let price = count * 50;
        WEAPONS[`w${count}`] = {
            name: `${w} de ${m}`,
            range: 60 + (count * 0.5),
            dmg: 10 + (count * 2),
            color: rarity === 'legendary' ? '#fbbf24' : rarity === 'epic' ? '#a855f7' : rarity === 'rare' ? '#3b82f6' : 'white',
            area: count % 10 === 0 ? 6.28 : 1.5,
            price: price,
            rarity: rarity
        };
    }
}
WEAPONS['Pu침os'] = { name: 'Pu침os', range: 50, dmg: 5, color: 'white', area: 1.2, price: 0 };

// --- 10 ENEMIGOS NUEVOS ---
const ENEMY_TYPES = [
    { n: "Slime", hp: 1, speed: 1.5, color: "#4ade80", xp: 20, gold: 10, size: 15 },
    { n: "Slime Guerrero", hp: 3, speed: 1.2, color: "#166534", xp: 40, gold: 25, size: 20 },
    { n: "Slime Veloz", hp: 1, speed: 3.5, color: "#fef08a", xp: 30, gold: 20, size: 12 },
    { n: "Slime Tanque", hp: 10, speed: 0.8, color: "#1e293b", xp: 100, gold: 80, size: 30 },
    { n: "Sombra", hp: 5, speed: 2.0, color: "#4c1d95", xp: 70, gold: 50, size: 18 },
    { n: "Espectro", hp: 2, speed: 2.5, color: "#a5f3fc", xp: 60, gold: 40, size: 16 },
    { n: "Ojo Carmes칤", hp: 8, speed: 1.8, color: "#991b1b", xp: 150, gold: 120, size: 22 },
    { n: "Golem de Lava", hp: 25, speed: 0.6, color: "#f97316", xp: 300, gold: 250, size: 40 },
    { n: "Viper de Cristal", hp: 6, speed: 3.0, color: "#22d3ee", xp: 180, gold: 150, size: 14 },
    { n: "Rey Slime", hp: 100, speed: 1.0, color: "#fbbf24", xp: 1000, gold: 1000, size: 60 }
];

// --- SISTEMA M칍VIL ---
let joyX = 0, joyY = 0;
const isTouch = ('ontouchstart' in window);
if(isTouch) {
    document.getElementById('mobile-controls').style.display = 'block';
    const jZone = document.getElementById('joystick-zone');
    const jStick = document.getElementById('joystick-stick');
    jZone.addEventListener('touchmove', e => {
        e.preventDefault(); const t = e.touches[0]; const r = jZone.getBoundingClientRect();
        const dx = t.clientX - (r.left + r.width/2), dy = t.clientY - (r.top + r.height/2);
        const d = Math.min(45, Math.hypot(dx, dy)), a = Math.atan2(dy, dx);
        joyX = Math.cos(a) * (d/45); joyY = Math.sin(a) * (d/45);
        jStick.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
    });
    jZone.addEventListener('touchend', () => { joyX = 0; joyY = 0; jStick.style.transform = `translate(0,0)`; });
    document.getElementById('attack-btn').addEventListener('touchstart', e => { e.preventDefault(); doAttack(); });
}

// --- RED ---
function startHost() {
    me.name = document.getElementById('playerName').value || "Host";
    isHost = true;
    for(let x=0; x<60; x++){ world[x]=[]; for(let y=0; y<60; y++) world[x][y]=Math.random()<0.05?1:0; }
    for(let i=0; i<20; i++) spawnEnemy();
    peer = new Peer();
    peer.on('open', id => { myId=id; players[id]=me; initGame(); });
    peer.on('connection', conn => {
        conn.on('open', () => { connections[conn.peer]=conn; conn.send({type:'init', world, players, slimes}); });
        conn.on('data', data => handleData(data, conn.peer));
    });
}

function startJoin() {
    const hostId = document.getElementById('joinId').value.trim();
    me.name = document.getElementById('playerName').value || "Guest";
    peer = new Peer();
    peer.on('open', id => {
        myId=id; players[id]=me;
        const conn = peer.connect(hostId);
        conn.on('open', () => { connections[hostId]=conn; conn.send({type:'join', p:me}); initGame(); });
        conn.on('data', data => handleData(data, hostId));
    });
}

function handleData(data, senderId) {
    if (data.type === 'init') { world=data.world; players=data.players; slimes=data.slimes; players[myId]=me; }
    if (data.type === 'join') { players[senderId]=data.p; if(isHost) broadcast({type:'new', id:senderId, p:data.p}); }
    if (data.type === 'new') { players[data.id]=data.p; }
    if (data.type === 'sync') { if(players[senderId]) Object.assign(players[senderId], data); if(isHost) broadcast(data, senderId); }
    if (data.type === 'slime_update') slimes = data.slimes;
    if (data.type === 'kill_slime') { if(isHost) slimes = slimes.filter(s => s.id !== data.sid); }
    if (data.type === 'hit' && data.tid === myId) takeDamage(data.dmg);
}

function broadcast(data, skip=null) { for(let id in connections) if(id!==skip) connections[id].send(data); }

// --- GAME ---
function initGame() {
    document.getElementById('setup').style.display='none';
    document.getElementById('hud').style.display='block';
    document.getElementById('btn-shop-toggle').style.display='flex';
    fillShop();
    window.addEventListener('keydown', e => { keys[e.key.toLowerCase()]=true; if(e.key==='e') toggleShop(); });
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()]=false);
    canvas.addEventListener('mousedown', doAttack);
    requestAnimationFrame(loop);
}

function fillShop() {
    const list = document.getElementById('shop-list');
    Object.keys(WEAPONS).forEach(key => {
        if(key === 'Pu침os') return;
        const w = WEAPONS[key];
        const item = document.createElement('div');
        item.className = `shop-item rarity-${w.rarity}`;
        item.innerHTML = `<strong>${w.name}</strong><br>$${w.price} | Dmg: ${w.dmg}`;
        item.onclick = () => buyWeapon(key);
        list.appendChild(item);
    });
}

function buyWeapon(id) {
    if(me.gold >= WEAPONS[id].price) {
        me.gold -= WEAPONS[id].price;
        me.weapon = id;
        updateHUD();
        alert("Equipado: " + WEAPONS[id].name);
    } else alert("Oro insuficiente");
}

function doAttack() {
    if(isDead) return;
    me.atkF = 12;
    const w = WEAPONS[me.weapon];
    slimes.forEach(s => {
        if(Math.hypot(s.x - me.x, s.y - me.y) < w.range) {
            if(isHost) {
                s.hp -= w.dmg;
                if(s.hp <= 0) {
                    addXP(s.xp); me.gold += s.gold;
                    slimes = slimes.filter(sl => sl.id !== s.id);
                    setTimeout(spawnEnemy, 3000);
                }
            } else connections[Object.keys(connections)[0]].send({type:'kill_slime', sid: s.id});
        }
    });
}

function spawnEnemy() {
    let x = Math.random()*3800, y = Math.random()*3800;
    let dist = Math.hypot(x-2000, y-2000);
    let typeIndex = Math.min(9, Math.floor(dist / 300));
    let t = ENEMY_TYPES[typeIndex];
    slimes.push({id: Math.random(), x, y, hp: t.hp, type: typeIndex, ...t});
}

function loop() {
    const v = 5;
    if(!isDead) {
        if(isTouch) { me.x += joyX*v; me.y += joyY*v; }
        else { if(keys['a']) me.x-=v; if(keys['d']) me.x+=v; if(keys['w']) me.y-=v; if(keys['s']) me.y+=v; }
    }
    if(me.atkF > 0) me.atkF--;
    players[myId] = me;
    camera.x=me.x-canvas.width/2; camera.y=me.y-canvas.height/2;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save(); ctx.translate(-camera.x, -camera.y);

    // Fondo y Dungeon
    let d = Math.hypot(me.x-2000, me.y-2000);
    ctx.fillStyle = d > 1200 ? "#050505" : "#0d1a0d";
    ctx.fillRect(0,0,4000,4000);

    // Host IA
    if(isHost) {
        slimes.forEach(s => {
            let target = null, minDist = 600;
            for(let id in players) {
                let dist = Math.hypot(players[id].x-s.x, players[id].y-s.y);
                if(dist < minDist) { minDist = dist; target = players[id]; }
            }
            if(target) {
                let a = Math.atan2(target.y-s.y, target.x-s.x);
                s.x += Math.cos(a)*s.speed; s.y += Math.sin(a)*s.speed;
                if(minDist < 30) takeDamage(s.speed/2);
            }
        });
        broadcast({type:'slime_update', slimes});
    }

    slimes.forEach(s => {
        ctx.fillStyle = s.color; ctx.beginPath();
        ctx.ellipse(s.x, s.y, s.size, s.size*0.8, 0, 0, 7); ctx.fill();
        ctx.fillStyle="white"; ctx.font="8px Arial"; ctx.fillText(s.n, s.x, s.y-s.size);
    });

    for(let id in players) {
        let p = players[id];
        if(id !== myId) { p.x+=(p.targetX-p.x)*0.2; p.y+=(p.targetY-p.y)*0.2; }
        else { broadcast({type:'sync', x:me.x, y:me.y, weapon:me.weapon, hp:me.hp, atk:me.atkF, lv:me.lv, gold:me.gold}); }
        ctx.fillStyle = id === myId ? "#38bdf8" : "#f472b6";
        ctx.fillRect(p.x-15, p.y-20, 30, 40);
        if(p.atk > 0) {
            const w = WEAPONS[p.weapon || 'Pu침os'];
            ctx.strokeStyle = w.color; ctx.lineWidth = 3; ctx.beginPath();
            ctx.arc(p.x, p.y, w.range, -w.area/2, w.area/2); ctx.stroke();
        }
        ctx.fillStyle="white"; ctx.textAlign="center"; ctx.fillText(`${p.name} Lv.${p.lv}`, p.x, p.y-30);
    }
    ctx.restore(); requestAnimationFrame(loop);
}

function takeDamage(a) { me.hp-=a; updateHUD(); if(me.hp<=0) location.reload(); }
function addXP(amt) { me.xp += amt; if(me.xp >= 100){ me.lv++; me.xp=0; me.maxHp+=20; me.hp=me.maxHp; } updateHUD(); }
function updateHUD() {
    document.getElementById('d-name').innerText = me.name + " (" + WEAPONS[me.weapon].name + ")";
    document.getElementById('d-lv').innerText = "LV. " + me.lv;
    document.getElementById('d-gold').innerText = "$" + Math.floor(me.gold);
    document.getElementById('hp-fill').style.width = (me.hp/me.maxHp*100) + "%";
    document.getElementById('xp-fill').style.width = me.xp + "%";
}
function toggleShop() { const s = document.getElementById('shop-ui'); s.style.display = s.style.display === 'block' ? 'none' : 'block'; }
</script>
</body>
</html>
