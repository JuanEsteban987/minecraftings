<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Minecraft RPG P2P</title>
<style>
body{
margin:0;
background:#1b1b1b;
color:white;
font-family:sans-serif;
text-align:center
}
canvas{
background:#6ec6ff;
display:block;
margin:auto
}
#menu{padding:20px}
</style>
</head>
<body>

<div id="menu">
<h2>Minecraft RPG P2P</h2>
<input id="name" placeholder="tu nombre"><br><br>
<button onclick="host()">HOST</button>
<button onclick="join()">JOIN</button>
<br><br>
<input id="code" placeholder="codigo">
<p id="info"></p>
</div>

<canvas id="game" width="900" height="550" style="display:none"></canvas>

<script>
// ---------- WEBRTC ----------
let pc, channel;
let isHost=false;
let players={};
let myId=Math.random().toString(36).slice(2);

function host(){
isHost=true;
startRTC();
}
function join(){
startRTC();
}

function startRTC(){
pc=new RTCPeerConnection({
iceServers:[{urls:"stun:stun.l.google.com:19302"}]
});

channel=pc.createDataChannel("game");

channel.onmessage=e=>{
players=JSON.parse(e.data);
};

pc.ondatachannel=e=>{
channel=e.channel;
channel.onmessage=ev=>{
players=JSON.parse(ev.data);
};
};

pc.onicecandidate=e=>{
if(!e.candidate){
let code=btoa(JSON.stringify(pc.localDescription));
document.getElementById("code").value=code;
document.getElementById("info").textContent="Comparte este c칩digo";
}
};

if(isHost){
pc.createOffer().then(o=>pc.setLocalDescription(o));
}else{
let code=prompt("Pega el c칩digo del host");
let desc=new RTCSessionDescription(JSON.parse(atob(code)));
pc.setRemoteDescription(desc)
.then(()=>pc.createAnswer())
.then(a=>pc.setLocalDescription(a));
}

startGame();
}

// ---------- JUEGO RPG ----------
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

let keys={};
onkeydown=e=>keys[e.key]=true;
onkeyup=e=>keys[e.key]=false;

let me={
x:450,
y:280,
emoji:"游븸",
name:"",
};

// 游꺕 mundo con 치rboles emoji
const TILE=40;
const MAP_W=60;
const MAP_H=40;
let world=[];

for(let y=0;y<MAP_H;y++){
world[y]=[];
for(let x=0;x<MAP_W;x++){
world[y][x]=Math.random()<0.08?"游꺕":"";
}
}

function startGame(){
me.name=document.getElementById("name").value||"Jugador";
document.getElementById("menu").style.display="none";
canvas.style.display="block";
loop();
}

// ---------- LOGICA ----------
function update(){

let sp=3;
if(keys["w"]) me.y-=sp;
if(keys["s"]) me.y+=sp;
if(keys["a"]) me.x-=sp;
if(keys["d"]) me.x+=sp;

// guardar mi estado
players[myId]=me;

// enviar a peers
if(channel && channel.readyState==="open"){
channel.send(JSON.stringify(players));
}
}

// ---------- DIBUJO ----------
function draw(){

ctx.clearRect(0,0,canvas.width,canvas.height);

// dibujar pasto
ctx.fillStyle="#3cb043";
ctx.fillRect(0,0,canvas.width,canvas.height);

// 치rboles emoji
ctx.font="28px serif";
for(let y=0;y<MAP_H;y++){
for(let x=0;x<MAP_W;x++){
let t=world[y][x];
if(t){
ctx.fillText(
t,
x*TILE,
y*TILE+30
);
}
}
}

// players
ctx.font="24px serif";
ctx.textAlign="center";

for(let id in players){
let p=players[id];
if(!p)continue;

// nametag
ctx.fillStyle="white";
ctx.font="14px sans-serif";
ctx.fillText(p.name,p.x,p.y-18);

// emoji skin
ctx.font="26px serif";
ctx.fillText(p.emoji,p.x,p.y);
}
}

function loop(){
update();
draw();
requestAnimationFrame(loop);
}
</script>
</body>
</html>
