<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RPG - Combat & Fix</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #2d5a27; font-family: sans-serif; display: flex; }
        #game-container { position: relative; flex-grow: 1; height: 100vh; }
        canvas { display: block; background: #3e7c37; }
        #server-panel { width: 250px; background: #1e293b; color: white; padding: 20px; border-left: 4px solid #38bdf8; }
        .code-box { background: #0f172a; padding: 10px; border-radius: 5px; color: #38bdf8; font-family: monospace; font-size: 11px; }
        #hotbar { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; pointer-events: auto; }
        .slot { width: 50px; height: 50px; background: rgba(0,0,0,0.6); border: 2px solid #64748b; border-radius: 5px; display: flex; justify-content: center; align-items: center; color: white; cursor: pointer; font-size: 24px; }
        .slot.active { border-color: #38bdf8; box-shadow: 0 0 10px #38bdf8; }
        .menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 30px; border-radius: 15px; text-align: center; color: white; border: 2px solid #38bdf8; z-index: 1000; }
        #damage-flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: red; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="game"></canvas>
    <div id="damage-flash"></div>
    <div id="setup" class="menu">
        <h2>BATALLA RPG</h2>
        <input type="text" id="playerName" placeholder="Nombre" style="padding:10px; margin:5px;"><br>
        <button onclick="startHost()" style="padding:10px; cursor:pointer;">HOSTEAR</button>
        <button onclick="startJoin()" style="padding:10px; cursor:pointer;">UNIRSE</button>
        <input type="text" id="joinId" placeholder="ID del Host" style="padding:10px; margin:5px;">
    </div>
    <div id="hotbar">
        <div class="slot active" id="s1" onclick="setSlot(1)">üëä</div>
        <div class="slot" id="s2" onclick="setSlot(2)">‚öîÔ∏è</div>
        <div class="slot" id="s3" onclick="setSlot(3)">üß±</div>
    </div>
</div>

<div id="server-panel">
    <h3>üì° SERVER</h3>
    <div id="id-display" class="code-box">...</div>
    <h4>JUGADORES</h4>
    <div id="player-list"></div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth - 250;
canvas.height = window.innerHeight;

const TILE_SIZE = 64;
let world = [], players = {}, slimes = [], connections = {}, myId = null, isHost = false, selectedSlot = 1;
let camera = { x: 0, y: 0 };
let me = { x: 400, y: 400, targetX: 400, targetY: 400, name: "Yo", color: "#38bdf8", item: 1, hp: 100 };

// --- LOGICA DE RED (LA CLAVE DEL ARREGLO) ---
function handleData(data, senderId) {
    if (data.type === 'init') { world = data.world; players = data.players; slimes = data.slimes; }
    if (data.type === 'join') { 
        players[senderId] = data.p; 
        if(isHost) broadcast({ type: 'new', id: senderId, p: data.p }); 
        updateUI();
    }
    if (data.type === 'new') { players[data.id] = data.p; updateUI(); }
    
    // El Host reenv√≠a la posici√≥n a TODOS para que el invitado se vea mover
    if (data.type === 'sync') {
        if(!players[senderId]) return;
        players[senderId].targetX = data.x;
        players[senderId].targetY = data.y;
        players[senderId].item = data.item;
        if(isHost) broadcast(data, senderId); // RELEV√ì: Env√≠a a los dem√°s
    }
    
    if (data.type === 'hit') {
        if(data.targetId === myId) takeDamage(10);
    }
}

function broadcast(data, skip = null) {
    for(let id in connections) if(id !== skip) connections[id].send(data);
}

// --- SISTEMA DE COMBATE ---
function attack() {
    if(selectedSlot !== 2) return; // Solo espada

    // Atacar Slimes
    slimes = slimes.filter(s => {
        let d = Math.hypot(s.x - me.x, s.y - me.y);
        return d > 60; // Si est√° cerca, muere (desaparece)
    });

    // Atacar Jugadores
    for(let id in players) {
        if(id === myId) continue;
        let d = Math.hypot(players[id].x - me.x, players[id].y - me.y);
        if(d < 60) {
            let hitData = { type: 'hit', targetId: id };
            if(isHost) broadcast(hitData);
            else connections[Object.keys(connections)[0]].send(hitData);
        }
    }
}

function takeDamage(amt) {
    me.hp -= amt;
    document.getElementById('damage-flash').style.opacity = 0.5;
    setTimeout(() => document.getElementById('damage-flash').style.opacity = 0, 100);
    if(me.hp <= 0) { alert("Has muerto"); location.reload(); }
}

// --- FUNCIONES DE INICIO ---
function startHost() {
    isHost = true;
    for(let x=0; x<30; x++) { world[x] = []; for(let y=0; y<30; y++) world[x][y] = Math.random() < 0.05 ? 1 : 0; }
    for(let i=0; i<5; i++) slimes.push({ x: Math.random()*1000, y: Math.random()*1000, id: i });
    
    const peer = new Peer();
    peer.on('open', id => { myId = id; players[id] = me; document.getElementById('id-display').innerText = id; init(); });
    peer.on('connection', conn => {
        conn.on('open', () => { connections[conn.peer] = conn; conn.send({ type: 'init', world, players, slimes }); });
        conn.on('data', data => handleData(data, conn.peer));
    });
}

function startJoin() {
    const hostId = document.getElementById('joinId').value;
    const peer = new Peer();
    peer.on('open', id => {
        myId = id; players[id] = me;
        const conn = peer.connect(hostId);
        conn.on('open', () => { connections[hostId] = conn; conn.send({ type: 'join', p: me }); init(); });
        conn.on('data', data => handleData(data, hostId));
    });
}

function setSlot(n) {
    selectedSlot = n;
    me.item = n;
    document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
    document.getElementById('s'+n).classList.add('active');
}

let keys = {};
function init() {
    document.getElementById('setup').style.display = 'none';
    window.addEventListener('keydown', e => { 
        keys[e.key.toLowerCase()] = true;
        if(e.key === '1') setSlot(1); if(e.key === '2') setSlot(2); if(e.key === '3') setSlot(3);
    });
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
    canvas.addEventListener('mousedown', attack);
    requestAnimationFrame(loop);
}

function loop() {
    if(keys['a']) me.x -= 5; if(keys['d']) me.x += 5;
    if(keys['w']) me.y -= 5; if(keys['s']) me.y += 5;

    camera.x = me.x - canvas.width/2; camera.y = me.y - canvas.height/2;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-camera.x, -camera.y);

    // Mundo
    ctx.fillStyle = "#14532d";
    for(let x=0; x<30; x++) for(let y=0; y<30; y++) if(world[x][y] === 1) ctx.fillRect(x*64, y*64, 60, 60);

    // Slimes
    ctx.fillStyle = "lime";
    slimes.forEach(s => ctx.beginPath() || ctx.arc(s.x, s.y, 20, 0, 7) || ctx.fill());

    // Jugadores
    for(let id in players) {
        let p = players[id];
        if(id !== myId) { p.x += (p.targetX - p.x) * 0.15; p.y += (p.targetY - p.y) * 0.15; }
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x-15, p.y-20, 30, 40);
        ctx.fillStyle = "white"; ctx.fillText(p.name + (p.item === 2 ? " [‚öîÔ∏è]" : ""), p.x - 20, p.y - 30);
    }

    broadcast({ type: 'sync', x: me.x, y: me.y, item: me.item });
    ctx.restore();
    requestAnimationFrame(loop);
}

function updateUI() {
    document.getElementById('player-list').innerHTML = Object.values(players).map(p => `‚Ä¢ ${p.name}`).join('<br>');
}
</script>
</body>
</html>
