<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Minecraft RPG Online</title>
<style>
body{margin:0;background:#1b1b1b;color:white;font-family:sans-serif;overflow:hidden}
#menu{text-align:center;padding:20px}
canvas{background:#6ec6ff;display:none}
#hud{
position:fixed;
right:10px;
top:10px;
background:rgba(0,0,0,.6);
padding:12px;
border-radius:10px;
display:none;
width:260px;
}
</style>
</head>
<body>

<div id="menu">
<h2>Minecraft RPG Online</h2>
<input id="name" placeholder="tu nombre"><br><br>
<button onclick="host()">HOST</button>
<button onclick="join()">JOIN</button><br><br>
<input id="roomInput" placeholder="codigo sala">
</div>

<div id="hud">
<b>ðŸŽ® Sala:</b> <span id="roomLabel"></span><br>
<b>ðŸ‘¥ Jugadores:</b>
<div id="playersList"></div>
</div>

<canvas id="game" width="900" height="550"></canvas>

<script>
// ---------- SALAS ----------
let socket=new WebSocket("wss://signaling.simplewebrtc.com");
let room=null;
let myId=Math.random().toString(36).slice(2);
let peers={};
let players={};

// ---------- HOST ----------
function host(){
room=Math.random().toString(36).slice(2,7);
document.getElementById("roomInput").value=room;
connect(room);
}

// ---------- JOIN ----------
function join(){
room=document.getElementById("roomInput").value.trim();
if(!room)return alert("Pon codigo");
connect(room);
}

// ---------- CONEXION ----------
function connect(roomName){
socket.onopen=()=>{
socket.send(JSON.stringify({
type:"join",
room:roomName,
id:myId
}));
};

socket.onmessage=msg=>{
let data=JSON.parse(msg.data);

if(data.type==="players"){
players=data.players;
}
};

startGame();
}

// ---------- JUEGO ----------
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

let keys={};
onkeydown=e=>keys[e.key]=true;
onkeyup=e=>keys[e.key]=false;

let me={x:1200,y:900,emoji:"ðŸ§‘",name:""};

const TILE=40;
const MAP_W=120;
const MAP_H=120;

let world=[];
for(let y=0;y<MAP_H;y++){
world[y]=[];
for(let x=0;x<MAP_W;x++){
world[y][x]=Math.random()<0.07?"ðŸŒ³":"";
}
}

let cam={x:0,y:0};

function startGame(){
me.name=document.getElementById("name").value||"Jugador";

document.getElementById("menu").style.display="none";
document.getElementById("hud").style.display="block";
canvas.style.display="block";
document.getElementById("roomLabel").textContent=room;

loop();
}

// ---------- UPDATE ----------
function update(){
let sp=4;
if(keys["w"]) me.y-=sp;
if(keys["s"]) me.y+=sp;
if(keys["a"]) me.x-=sp;
if(keys["d"]) me.x+=sp;

cam.x=me.x-canvas.width/2;
cam.y=me.y-canvas.height/2;

players[myId]=me;

if(socket.readyState===1){
socket.send(JSON.stringify({
type:"state",
room:room,
players:players
}));
}

let list="";
for(let id in players) list+=players[id].name+"<br>";
document.getElementById("playersList").innerHTML=list;
}

// ---------- DRAW ----------
function draw(){
ctx.clearRect(0,0,canvas.width,canvas.height);

ctx.fillStyle="#3cb043";
ctx.fillRect(0,0,canvas.width,canvas.height);

ctx.font="28px serif";
for(let y=0;y<MAP_H;y++){
for(let x=0;x<MAP_W;x++){
let t=world[y][x];
if(!t) continue;
let px=x*TILE-cam.x;
let py=y*TILE-cam.y;
if(px<-TILE||py<-TILE||px>canvas.width||py>canvas.height) continue;
ctx.fillText(t,px,py+30);
}
}

ctx.textAlign="center";
for(let id in players){
let p=players[id];
let px=p.x-cam.x;
let py=p.y-cam.y;

ctx.fillStyle="white";
ctx.font="14px sans-serif";
ctx.fillText(p.name,px,py-18);

ctx.font="26px serif";
ctx.fillText(p.emoji,px,py);
}
}

function loop(){
update();
draw();
requestAnimationFrame(loop);
}
</script>
</body>
</html>
