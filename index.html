<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RPG P2P: Tienda, PvP & Barras de Vida</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Courier New', monospace; margin: 0; overflow: hidden; background: #1a1a1a; color: white; }
        canvas { background: #2d5a27; display: none; }
        
        /* UI Estilo Retro */
        #main-menu {
            position: absolute; width: 100%; height: 100%; background: radial-gradient(#2d5a27, #1a1a1a);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
        .menu-box { background: rgba(0,0,0,0.9); padding: 30px; border: 4px solid #8b4513; border-radius: 15px; text-align: center; }
        input, button { margin: 10px; padding: 12px; font-size: 16px; border-radius: 5px; border: none; }
        button { cursor: pointer; background: #ffd700; font-weight: bold; }

        /* Paneles de Juego */
        .ui-left { position: absolute; top: 10px; left: 10px; z-index: 10; padding: 10px; background: rgba(0,0,0,0.8); border: 2px solid #555; display: none; min-width: 150px; }
        .ui-right { position: absolute; top: 10px; right: 10px; z-index: 10; padding: 15px; background: rgba(40, 40, 40, 0.9); border: 3px solid #8b4513; display: none; }
        
        #hud { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center; pointer-events: none; display: none; }
        #inventory { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 250px; background: #333; border: 4px solid #8b4513; padding: 20px; display: none; z-index: 20; }
        
        .player-list-item { color: #0f0; font-size: 12px; margin: 2px 0; }
        .gold-count { color: #ffd700; font-weight: bold; font-size: 18px; }
    </style>
</head>
<body>

    <div id="main-menu">
        <div class="menu-box">
            <h1 style="color: #ffd700;">WORLD P2P RPG</h1>
            <input type="text" id="init-nick" placeholder="Tu Nombre" maxlength="10">
            <div>
                Ropa: <input type="color" id="init-skin" value="#ffd700">
                Acc: <input type="color" id="init-acc" value="#ff0000">
            </div>
            <button onclick="startGame(true)">CREAR SALA</button><br>
            <input type="text" id="join-id" placeholder="ID del Host">
            <button onclick="startGame(false)">UNIRSE</button>
        </div>
    </div>

    <div class="ui-left" id="panel-left">
        <strong>ID:</strong> <span id="my-id" style="color:#0f0">...</span><br>
        <div id="player-count" style="margin: 5px 0;">Jugadores: 1</div>
        <div id="player-names"></div>
        <hr>
        <div class="gold-count">ORO: $<span id="gold-val">0</span></div>
    </div>

    <div class="ui-right" id="panel-right">
        <input type="text" id="live-nick" oninput="updateAppearance()" style="width:100%">
        <input type="color" id="live-skin" onchange="updateAppearance()">
        <input type="color" id="live-acc" onchange="updateAppearance()">
    </div>

    <div id="hud">
        <div id="player-tag">Nvl 1</div>
        <div style="width: 200px; height: 10px; background: #444; border: 1px solid #000;">
            <div id="hp-bar" style="background: #ff3333; height: 100%; width: 100%;"></div>
        </div>
        <small>Presiona [I] Stats | Tienda en el centro del mapa</small>
    </div>

    <div id="inventory">
        <h2 style="text-align:center; color: gold;">STATS</h2>
        <p>Ataque: <span id="st-atk">10</span></p>
        <p>Experiencia: <span id="st-xp">0</span></p>
        <button onclick="document.getElementById('inventory').style.display='none'">Cerrar</button>
    </div>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const peer = new Peer();

        const WORLD_SIZE = 3000;
        let isHost = true;
        let gameActive = false;
        let gold = 0;

        let myData = { 
            id: '', x: 1500, y: 1500, nick: "Heroe", skin: "#ffd700", acc: "#ff0000",
            lv: 1, xp: 0, hp: 100, maxHp: 100, atk: 10, state: 'idle', frame: 0, dir: 1, angle: 0
        };
        
        let peers = {};
        let remotePlayers = {};
        let slimes = [];
        let animTimer = 0;

        // Tienda
        const shop = { x: 1400, y: 1400, w: 200, h: 200 };

        function startGame(host) {
            isHost = host;
            myData.nick = document.getElementById('init-nick').value || "Heroe";
            myData.skin = document.getElementById('init-skin').value;
            myData.acc = document.getElementById('init-acc').value;
            
            if(!isHost) {
                const tid = document.getElementById('join-id').value;
                if(!tid) return alert("Falta ID");
                setupConnection(peer.connect(tid));
            }
            
            gameActive = true;
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            document.querySelectorAll('.ui-left, .ui-right, #hud').forEach(e => e.style.display = 'block');
            
            if(isHost) spawnSlimes();
            render();
        }

        function spawnSlimes() {
            for(let i=0; i<30; i++) {
                slimes.push({ id: i, x: Math.random()*WORLD_SIZE, y: Math.random()*WORLD_SIZE, hp: 50, maxHp: 50, frame: 0 });
            }
        }

        peer.on('open', (id) => { myData.id = id; document.getElementById('my-id').innerText = id; });
        peer.on('connection', setupConnection);

        function setupConnection(conn) {
            peers[conn.peer] = conn;
            conn.on('data', (data) => {
                if (data.type === 'player_sync') remotePlayers[data.data.id] = data.data;
                if (data.type === 'world_sync') slimes = data.slimes;
                if (data.type === 'damage' && data.targetId === myData.id) myData.hp -= data.dmg;
                if (data.type === 'slime_damage' && isHost) {
                    let s = slimes.find(s => s.id === data.id);
                    if(s) s.hp -= data.dmg;
                }
            });
            conn.on('open', updateUI);
            conn.on('close', () => { delete remotePlayers[conn.peer]; updateUI(); });
        }

        function updateUI() {
            const count = Object.keys(remotePlayers).length + 1;
            document.getElementById('player-count').innerText = `Jugadores: ${count}`;
            let namesHTML = `<div class="player-list-item">● ${myData.nick} (Tú)</div>`;
            for(let id in remotePlayers) namesHTML += `<div class="player-list-item">● ${remotePlayers[id].nick}</div>`;
            document.getElementById('player-names').innerHTML = namesHTML;
        }

        function broadcast(msg) {
            for(let id in peers) if(peers[id].open) peers[id].send(msg);
        }

        function updateAppearance() {
            myData.nick = document.getElementById('live-nick').value;
            myData.skin = document.getElementById('live-skin').value;
            myData.acc = document.getElementById('live-acc').value;
            updateUI();
        }

        // INPUTS
        const keys = {};
        window.onkeydown = (e) => {
            keys[e.key.toLowerCase()] = true;
            if(e.key.toLowerCase() === 'i') document.getElementById('inventory').style.display = 'block';
        };
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;
        window.onmousemove = (e) => {
            myData.angle = Math.atan2(e.clientY - window.innerHeight/2, e.clientX - window.innerWidth/2);
            myData.dir = (e.clientX > window.innerWidth/2) ? 1 : -1;
        };
        window.onmousedown = () => {
            myData.state = 'attack';
            doAttack();
            setTimeout(() => myData.state = 'idle', 200);
        };

        function doAttack() {
            // Ataque a Slimes
            slimes.forEach(s => {
                if(s.hp <= 0) return;
                let d = Math.hypot(s.x - myData.x, s.y - myData.y);
                if(d < 80) {
                    if(isHost) { s.hp -= myData.atk; if(s.hp<=0) addGold(10); }
                    else broadcast({ type: 'slime_damage', id: s.id, dmg: myData.atk });
                }
            });
            // ATAQUE AMIGO (PVP)
            for(let id in remotePlayers) {
                let p = remotePlayers[id];
                if(Math.hypot(p.x - myData.x, p.y - myData.y) < 80) {
                    broadcast({ type: 'damage', targetId: p.id, dmg: myData.atk });
                }
            }
        }

        function addGold(val) { gold += val; document.getElementById('gold-val').innerText = gold; }

        function update() {
            if(!gameActive) return;
            let moving = false;
            if (keys['w']) { myData.y -= 5; moving = true; }
            if (keys['s']) { myData.y += 5; moving = true; }
            if (keys['a']) { myData.x -= 5; moving = true; }
            if (keys['d']) { myData.x += 5; moving = true; }
            
            // Lógica Tienda
            if(myData.x > shop.x && myData.x < shop.x + shop.w && myData.y > shop.y && myData.y < shop.y + shop.h) {
                if(gold >= 50) { gold -= 50; myData.atk += 5; document.getElementById('gold-val').innerText = gold; }
            }

            if(isHost) {
                const players = [myData, ...Object.values(remotePlayers)];
                slimes.forEach(s => {
                    if(s.hp <= 0) return;
                    let target = players.sort((a,b) => Math.hypot(a.x-s.x, a.y-s.y) - Math.hypot(b.x-s.x, b.y-s.y))[0];
                    let d = Math.hypot(target.x - s.x, target.y - s.y);
                    if(d < 250) { s.x += (target.x-s.x)*0.01; s.y += (target.y-s.y)*0.01; }
                });
                broadcast({ type: 'world_sync', slimes: slimes });
            }
            broadcast({ type: 'player_sync', data: myData });
            document.getElementById('hp-bar').style.width = (myData.hp/myData.maxHp)*100 + "%";
            if(myData.hp <= 0) { myData.hp = 100; myData.x = 1500; myData.y = 1500; }
        }

        function drawEntity(x, y, hp, maxHp, nick, color, acc, angle, state, isSlime) {
            ctx.save();
            ctx.translate(x, y);
            
            // Barra de vida
            ctx.fillStyle = "black"; ctx.fillRect(-20, -45, 40, 6);
            ctx.fillStyle = isSlime ? "#0f0" : "#f00"; ctx.fillRect(-20, -45, 40 * (hp/maxHp), 6);
            
            if(isSlime) {
                ctx.fillStyle = "#44ff44"; ctx.beginPath(); ctx.ellipse(0, 0, 15, 12, 0, 0, Math.PI*2); ctx.fill();
            } else {
                ctx.fillStyle = color; ctx.fillRect(-15, -15, 30, 30);
                ctx.fillStyle = acc; ctx.fillRect(-15, -2, 30, 5);
                if(state === 'attack') {
                    ctx.save(); ctx.rotate(angle); ctx.strokeStyle = "white"; ctx.lineWidth = 3;
                    ctx.beginPath(); ctx.arc(20, 0, 30, -0.8, 0.8); ctx.stroke(); ctx.restore();
                }
                ctx.fillStyle = "white"; ctx.textAlign = "center"; ctx.fillText(nick, 0, -55);
            }
            ctx.restore();
        }

        function render() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            const camX = canvas.width/2 - myData.x; const camY = canvas.height/2 - myData.y;
            ctx.save(); ctx.translate(camX, camY);

            // Suelo y Tienda
            ctx.fillStyle = "rgba(255,255,255,0.05)";
            for(let i=0; i<=WORLD_SIZE; i+=200) ctx.fillRect(i, 0, 1, WORLD_SIZE), ctx.fillRect(0, i, WORLD_SIZE, 1);
            ctx.fillStyle = "#8b4513"; ctx.fillRect(shop.x, shop.y, shop.w, shop.h);
            ctx.fillStyle = "white"; ctx.fillText("TIENDA (Pisa para +ATK $50)", shop.x + 10, shop.y - 10);

            slimes.forEach(s => drawEntity(s.x, s.y, s.hp, s.maxHp, "", "", "", 0, "", true));
            for(let id in remotePlayers) {
                let p = remotePlayers[id];
                drawEntity(p.x, p.y, p.hp, p.maxHp, p.nick, p.skin, p.acc, p.angle, p.state, false);
            }
            drawEntity(myData.x, myData.y, myData.hp, myData.maxHp, myData.nick, myData.skin, myData.acc, myData.angle, myData.state, false);

            ctx.restore();
            update();
            requestAnimationFrame(render);
        }
    </script>
</body>
</html>
