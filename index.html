<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG Neo Genesis: Combat Elite</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #38bdf8; --accent: #ef4444; --gold: #fbbf24; --glass: rgba(15, 23, 42, 0.9); }
        body { margin: 0; overflow: hidden; background: #070a0e; font-family: 'Segoe UI', sans-serif; color: white; touch-action: none; }
        canvas { display: block; background: #0a0f0a; }
        .glass { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; }
        
        /* Sala ID Esquina */
        #room-id-tag { position: absolute; top: 10px; right: 10px; padding: 8px 15px; font-family: monospace; font-size: 14px; color: var(--primary); border: 1px solid var(--primary); z-index: 1000; display: none; cursor: pointer; }

        /* HUD */
        #hud { position: absolute; top: 15px; left: 15px; padding: 12px; min-width: 160px; z-index: 500; pointer-events: none; }
        .bar { height: 6px; border-radius: 3px; margin-top: 5px; overflow: hidden; background: #334155; }
        #hp-fill { height: 100%; width: 100%; background: var(--accent); transition: 0.1s; }
        #xp-fill { height: 100%; width: 0%; background: #a855f7; }
        .stats-text { font-size: 12px; display: flex; justify-content: space-between; margin-top: 5px; font-weight: bold; }

        /* Tienda */
        #shop-ui { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); width: 260px; padding: 15px; display: none; z-index: 600; max-height: 70vh; overflow-y: auto; border: 2px solid var(--gold); }
        .shop-item { background: rgba(255,255,255,0.05); border: 1px solid #334155; padding: 8px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; font-size: 13px; }
        
        /* Controles */
        #mobile-controls { position: absolute; inset: 0; pointer-events: none; display: none; }
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 110px; height: 110px; background: rgba(255,255,255,0.05); border-radius: 50%; pointer-events: auto; border: 2px solid rgba(255,255,255,0.1); }
        #joystick-stick { position: absolute; top: 30px; left: 30px; width: 50px; height: 50px; background: var(--primary); border-radius: 50%; opacity: 0.6; }
        #attack-btn { position: absolute; bottom: 50px; right: 40px; width: 80px; height: 80px; background: var(--accent); border-radius: 50%; pointer-events: auto; display: flex; justify-content: center; align-items: center; font-size: 30px; opacity: 0.8; }

        #setup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 30px; text-align: center; z-index: 1000; width: 280px; }
        input { background: #1e293b; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; width: 90%; margin-bottom: 10px; font-size: 16px; }
        button { background: var(--primary); border: none; padding: 12px; font-weight: bold; border-radius: 8px; cursor: pointer; width: 100%; color: #000; }
    </style>
</head>
<body>

    <div id="room-id-tag" class="glass" onclick="copyRoomId()">ID: ---</div>

    <div id="setup" class="glass">
        <h2 style="color:var(--primary); margin:0 0 15px 0;">NEO GENESIS</h2>
        <input type="text" id="playerName" placeholder="Tu Nombre">
        <button onclick="startHost()">CREAR REINO</button>
        <input type="text" id="joinId" placeholder="ID de la Sala" style="margin-top:10px">
        <button onclick="startJoin()" style="background:#475569; color:white;">UNIRSE</button>
    </div>

    <div id="hud" class="glass" style="display:none">
        <div id="d-name">---</div>
        <div class="stats-text"><span id="d-lv">LV. 1</span> <span id="d-gold" style="color:var(--gold)">$0</span></div>
        <div class="bar"><div id="hp-fill"></div></div>
        <div class="bar" style="height:3px; margin-top:3px"><div id="xp-fill"></div></div>
    </div>

    <div id="shop-ui" class="glass">
        <h3 style="margin:0 0 10px 0; color:var(--gold)">MERCADO</h3>
        <div id="shop-list"></div>
        <button onclick="toggleShop()" style="background:#334155; color:white; margin-top:10px">CERRAR</button>
    </div>

    <div id="mobile-controls">
        <div id="joystick-zone"><div id="joystick-stick"></div></div>
        <div id="attack-btn">⚔️</div>
    </div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth; canvas.height = window.innerHeight;

let world = [], players = {}, slimes = [], connections = {}, peer = null;
let myId = null, isHost = false, isDead = false;
let camera = { x: 0, y: 0 }, keys = {};
let me = { x: 2000, y: 2000, name: "", hp: 100, maxHp: 100, lv: 1, xp: 0, gold: 100, atkF: 0, weapon: 'w1', angle: 0 };

const WEAPONS = {};
const weaponNames = ["Espada", "Daga", "Hacha", "Lanza", "Martillo"];
const materials = ["Madera", "Hierro", "Acero", "Obsidiana", "Mithril", "Diamante", "Génesis"];

let count = 0;
materials.forEach(m => {
    weaponNames.forEach(w => {
        count++;
        let rarity = count < 10 ? 'common' : count < 25 ? 'rare' : 'epic';
        WEAPONS[`w${count}`] = {
            name: `${w} de ${m}`,
            range: 50 + (count * 2),
            dmg: 10 + (count * 3),
            color: count > 30 ? '#fbbf24' : count > 15 ? '#a855f7' : '#38bdf8',
            price: count * 40
        };
    });
});

const ENEMY_TYPES = [
    { n: "Slime", hp: 30, speed: 1.5, color: "#4ade80", xp: 20, gold: 10, size: 15 },
    { n: "Sombra", hp: 60, speed: 2.2, color: "#4c1d95", xp: 50, gold: 40, size: 20 }
];

// --- MOBILE ---
let joyX = 0, joyY = 0;
const isTouch = ('ontouchstart' in window);
if(isTouch) {
    document.getElementById('mobile-controls').style.display = 'block';
    const jZone = document.getElementById('joystick-zone');
    const jStick = document.getElementById('joystick-stick');
    jZone.addEventListener('touchmove', e => {
        e.preventDefault(); const t = e.touches[0]; const r = jZone.getBoundingClientRect();
        const dx = t.clientX - (r.left + r.width/2), dy = t.clientY - (r.top + r.height/2);
        const d = Math.min(45, Math.hypot(dx, dy)), a = Math.atan2(dy, dx);
        joyX = Math.cos(a); joyY = Math.sin(a);
        me.angle = a;
        jStick.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
    });
    jZone.addEventListener('touchend', () => { joyX = 0; joyY = 0; jStick.style.transform = `translate(0,0)`; });
    document.getElementById('attack-btn').addEventListener('touchstart', e => { e.preventDefault(); doAttack(); });
}

// --- RED ---
function startHost() {
    me.name = document.getElementById('playerName').value || "Host";
    isHost = true;
    for(let i=0; i<15; i++) spawnEnemy();
    peer = new Peer();
    peer.on('open', id => { myId=id; players[id]=me; showId(id); initGame(); });
    peer.on('connection', conn => {
        conn.on('open', () => { connections[conn.peer]=conn; conn.send({type:'init', players, slimes}); });
        conn.on('data', data => handleData(data, conn.peer));
    });
}

function startJoin() {
    const hostId = document.getElementById('joinId').value.trim();
    me.name = document.getElementById('playerName').value || "Invitado";
    peer = new Peer();
    peer.on('open', id => {
        myId=id; players[id]=me; showId(hostId);
        const conn = peer.connect(hostId);
        conn.on('open', () => { connections[hostId]=conn; conn.send({type:'join', p:me}); initGame(); });
        conn.on('data', data => handleData(data, hostId));
    });
}

function handleData(data, senderId) {
    if (data.type === 'init') { players=data.players; slimes=data.slimes; players[myId]=me; }
    if (data.type === 'join') { players[senderId]=data.p; if(isHost) broadcast({type:'new', id:senderId, p:data.p}); }
    if (data.type === 'new') { players[data.id]=data.p; }
    if (data.type === 'sync') { if(players[senderId]) Object.assign(players[senderId], data); if(isHost) broadcast(data, senderId); }
    if (data.type === 'slime_update') slimes = data.slimes;
    if (data.type === 'hit' && data.tid === myId) takeDamage(data.dmg);
    if (data.type === 'kill_slime' && isHost) {
        slimes = slimes.filter(s => {
            if(s.id === data.sid) { s.hp -= data.dmg; if(s.hp<=0) { spawnEnemy(); return false; } }
            return true;
        });
    }
}

function broadcast(data, skip=null) { for(let id in connections) if(id!==skip) connections[id].send(data); }

function showId(id) {
    const tag = document.getElementById('room-id-tag');
    tag.innerText = "SALA: " + id;
    tag.style.display = "block";
}

function initGame() {
    document.getElementById('setup').style.display='none';
    document.getElementById('hud').style.display='block';
    fillShop();
    window.addEventListener('keydown', e => { 
        keys[e.key.toLowerCase()]=true; 
        if(e.key === 'e') toggleShop();
    });
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()]=false);
    canvas.addEventListener('mousedown', doAttack);
    requestAnimationFrame(loop);
}

function doAttack() {
    if(isDead || me.atkF > 0) return;
    me.atkF = 15; // Inicia animación
    const w = WEAPONS[me.weapon];

    // Lógica de daño a Slimes
    slimes.forEach(s => {
        if(Math.hypot(s.x - me.x, s.y - me.y) < w.range + 20) {
            if(isHost) { s.hp -= w.dmg; if(s.hp <= 0) { addXP(20); me.gold += 15; slimes = slimes.filter(sl => sl.id !== s.id); spawnEnemy(); } }
            else connections[Object.keys(connections)[0]].send({type:'kill_slime', sid: s.id, dmg: w.dmg});
        }
    });

    // Lógica de daño a Jugadores (Friendly Fire)
    for(let id in players) {
        if(id === myId) continue;
        if(Math.hypot(players[id].x - me.x, players[id].y - me.y) < w.range) {
            let h = {type:'hit', tid: id, dmg: w.dmg};
            if(isHost) broadcast(h); else Object.values(connections)[0].send(h);
        }
    }
}

function spawnEnemy() {
    let x = 1500 + Math.random()*1000, y = 1500 + Math.random()*1000;
    let t = ENEMY_TYPES[Math.random() > 0.8 ? 1 : 0];
    slimes.push({id: Math.random(), x, y, ...t});
}

function loop() {
    const v = 4.5;
    if(!isDead) {
        if(isTouch && (joyX !== 0 || joyY !== 0)) { me.x += joyX*v; me.y += joyY*v; }
        else {
            let dx = 0, dy = 0;
            if(keys['a']) dx--; if(keys['d']) dx++; if(keys['w']) dy--; if(keys['s']) dy++;
            if(dx !== 0 || dy !== 0) {
                me.angle = Math.atan2(dy, dx);
                me.x += dx*v; me.y += dy*v;
            }
        }
    }

    if(me.atkF > 0) me.atkF--;
    players[myId] = me;
    camera.x=me.x-canvas.width/2; camera.y=me.y-canvas.height/2;
    ctx.clearRect(0,0,canvas.width,canvas.height); ctx.save(); ctx.translate(-camera.x, -camera.y);

    // Suelo
    ctx.fillStyle = "#0d1a0d"; ctx.fillRect(0,0,4000,4000);

    // Slimes
    if(isHost) {
        slimes.forEach(s => {
            let target = null, minDist = 500;
            for(let id in players) {
                let d = Math.hypot(players[id].x-s.x, players[id].y-s.y);
                if(d < minDist) { minDist = d; target = players[id]; }
            }
            if(target) {
                let a = Math.atan2(target.y-s.y, target.x-s.x);
                s.x += Math.cos(a)*s.speed; s.y += Math.sin(a)*s.speed;
                if(minDist < 25) takeDamage(0.3);
            }
        });
        broadcast({type:'slime_update', slimes});
    }
    slimes.forEach(s => {
        ctx.fillStyle = s.color; ctx.beginPath(); ctx.ellipse(s.x, s.y, s.size, s.size*0.8, 0, 0, 7); ctx.fill();
    });

    // Jugadores y Armas
    for(let id in players) {
        let p = players[id];
        if(id !== myId) { p.x+=(p.targetX-p.x)*0.2; p.y+=(p.targetY-p.y)*0.2; }
        else { broadcast({type:'sync', x:me.x, y:me.y, weapon:me.weapon, hp:me.hp, atk:me.atkF, lv:me.lv, gold:me.gold, angle:me.angle}); }

        // Dibujar Arma (Física)
        const w = WEAPONS[p.weapon];
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.angle + (p.atk > 0 ? (15 - p.atk) * 0.2 : 0)); // Animación de giro al atacar
        
        ctx.fillStyle = w.color;
        // Mango y Hoja
        ctx.fillRect(10, -2, w.range, 4); 
        ctx.fillStyle = "rgba(255,255,255,0.3)";
        ctx.fillRect(10, -2, 10, 4); // Guarda
        ctx.restore();

        // Cuerpo Jugador
        ctx.fillStyle = id === myId ? "#38bdf8" : "#f472b6";
        ctx.fillRect(p.x-12, p.y-12, 24, 24);
        ctx.fillStyle="white"; ctx.font="10px Arial"; ctx.textAlign="center";
        ctx.fillText(p.name, p.x, p.y-18);
    }

    ctx.restore(); requestAnimationFrame(loop);
}

function takeDamage(a) { 
    me.hp -= a; updateHUD(); 
    if(me.hp<=0 && !isDead) { isDead=true; location.reload(); } 
}

function addXP(amt) {
    me.xp += amt; if(me.xp >= 100){ me.lv++; me.xp=0; me.maxHp+=20; me.hp=me.maxHp; }
    updateHUD();
}

function updateHUD() {
    document.getElementById('d-name').innerText = me.name;
    document.getElementById('d-lv').innerText = "LV. " + me.lv;
    document.getElementById('d-gold').innerText = "$" + Math.floor(me.gold);
    document.getElementById('hp-fill').style.width = (me.hp/me.maxHp*100) + "%";
    document.getElementById('xp-fill').style.width = me.xp + "%";
}

function fillShop() {
    const list = document.getElementById('shop-list');
    Object.keys(WEAPONS).forEach(k => {
        const w = WEAPONS[k];
        const div = document.createElement('div');
        div.className = 'shop-item';
        div.innerHTML = `<strong>${w.name}</strong><br>$${w.price} | Dmg: ${w.dmg}`;
        div.onclick = () => { if(me.gold >= w.price){ me.gold-=w.price; me.weapon=k; updateHUD(); alert("Equipado!"); } };
        list.appendChild(div);
    });
}
function toggleShop() { const s=document.getElementById('shop-ui'); s.style.display=s.style.display==='block'?'none':'block'; }
function copyRoomId() {
    const text = document.getElementById('room-id-tag').innerText.split(': ')[1];
    navigator.clipboard.writeText(text);
    alert("Código copiado: " + text);
}
</script>
</body>
</html>
