<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RPG P2P Fix - Sincronizado</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #0f172a; font-family: sans-serif; }
        canvas { display: block; }
        #ui { position: absolute; top: 20px; left: 20px; background: rgba(15, 23, 42, 0.9); color: #38bdf8; padding: 20px; border-radius: 12px; border: 1px solid #38bdf8; z-index: 100; }
        input { background: #1e293b; border: 1px solid #334155; color: white; padding: 8px; border-radius: 4px; width: 140px; }
        button { background: #38bdf8; border: none; padding: 8px; font-weight: bold; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>

<div id="ui">
    <div id="setup">
        <input type="text" id="playerName" placeholder="Tu Nick">
        <button onclick="startHost()">Crear Mundo</button><br><br>
        <input type="text" id="joinId" placeholder="ID del Host">
        <button onclick="startJoin()">Unirse</button>
    </div>
    <p id="status">Estado: Esperando...</p>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const TILE_SIZE = 40;
let world = [];
let players = {}; 
let keys = {};
let myId = null;
let peer = null;
let connections = {}; // Usamos un objeto para mapear IDs a conexiones
let isHost = false;

let me = {
    x: 400, y: 300,
    name: "Jugador",
    lvl: 1, xp: 0,
    color: `hsl(${Math.random() * 360}, 70%, 60%)`
};

// Generar Mapa Simple
for(let x=0; x<100; x++){
    world[x] = [];
    for(let y=0; y<40; y++) world[x][y] = y > 15 ? (y === 16 ? 1 : 2) : 0;
}

function startHost() {
    isHost = true;
    me.name = document.getElementById('playerName').value || "Host";
    peer = new Peer();
    peer.on('open', id => {
        myId = id;
        document.getElementById('status').innerText = "ID: " + id;
        players[id] = me;
        init();
    });

    peer.on('connection', conn => {
        conn.on('open', () => {
            connections[conn.peer] = conn;
            // Al conectarse alguien, el host le manda el mundo y los jugadores actuales
            conn.send({ type: 'init', world, players });
        });
        conn.on('data', data => handleData(data, conn.peer));
    });
}

function startJoin() {
    isHost = false;
    const hostId = document.getElementById('joinId').value;
    me.name = document.getElementById('playerName').value || "Invitado";
    peer = new Peer();
    peer.on('open', id => {
        myId = id;
        const conn = peer.connect(hostId);
        connections[hostId] = conn;
        conn.on('open', () => {
            document.getElementById('status').innerText = "Conectado al Host";
            players[id] = me;
            init();
        });
        conn.on('data', data => handleData(data, hostId));
    });
}

function handleData(data, senderId) {
    if (data.type === 'init') {
        world = data.world;
        players = data.players;
    }
    
    if (data.type === 'sync') {
        // Actualizamos o creamos al jugador que envió la data
        if (!players[senderId]) players[senderId] = data.p;
        players[senderId].targetX = data.p.x;
        players[senderId].targetY = data.p.y;
        players[senderId].name = data.p.name;
        players[senderId].lvl = data.p.lvl;

        // ¡ESTA ES LA CLAVE! Si soy el Host, reenvío esta info a todos los demás
        if (isHost) {
            for (let id in connections) {
                if (id !== senderId) { // No se lo devuelvas al que lo envió
                    connections[id].send({ type: 'sync_relay', id: senderId, p: data.p });
                }
            }
        }
    }

    if (data.type === 'sync_relay') {
        // El invitado recibe la info de otros invitados a través del host
        if (!players[data.id]) players[data.id] = data.p;
        players[data.id].targetX = data.p.x;
        players[data.id].targetY = data.p.y;
    }
}

function init() {
    document.getElementById('setup').style.display = "none";
    window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
    
    // El Invitado solo le manda al Host. El Host le manda a todos.
    setInterval(() => {
        if(myId) {
            const dataToSend = { type: 'sync', p: me };
            for (let id in connections) {
                connections[id].send(dataToSend);
            }
        }
    }, 30);

    requestAnimationFrame(loop);
}

function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Movimiento Local
    const speed = 5;
    if (keys['w']) me.y -= speed;
    if (keys['s']) me.y += speed;
    if (keys['a']) me.x -= speed;
    if (keys['d']) me.x += speed;

    // Dibujar Mundo
    for(let x=0; x<canvas.width/TILE_SIZE + 1; x++){
        for(let y=0; y<canvas.height/TILE_SIZE + 1; y++){
            if(!world[x] || !world[x][y]) continue;
            ctx.fillStyle = world[x][y] === 1 ? "#22c55e" : "#475569";
            ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
        }
    }

    // Dibujar Jugadores con Suavizado
    for (let id in players) {
        let p = players[id];
        if (id !== myId && p.targetX !== undefined) {
            p.x += (p.targetX - p.x) * 0.2;
            p.y += (p.targetY - p.y) * 0.2;
        }

        ctx.fillStyle = p.color || 'white';
        ctx.fillRect(p.x, p.y, 30, 50);
        
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.fillText(`${p.name} (Lv.${p.lvl || 1})`, p.x + 15, p.y - 10);
    }

    requestAnimationFrame(loop);
}
</script>
</body>
</html>
