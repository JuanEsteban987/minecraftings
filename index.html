<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RPG P2P Multiplayer</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #222; color: white; }
        canvas { background: #444; border: 4px solid #555; display: block; margin: 0 auto; }
        .ui { margin: 20px; padding: 10px; background: #333; border-radius: 8px; }
        input { padding: 8px; }
    </style>
</head>
<body>

    <div class="ui">
        <h3>Tu ID: <span id="my-id">...</span></h3>
        <input type="text" id="target-id" placeholder="ID del amigo para unirse">
        <button onclick="connectToPeer()">Conectar y Jugar</button>
        <div style="margin-top:10px;">
            Nick: <input type="text" id="nick" value="Guerrero">
            Skin: <select id="skin"><option value="gold">Dorado</option><option value="cyan">Cian</option></select>
        </div>
    </div>

    <canvas id="game" width="600" height="400"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const peer = new Peer(); // Crea un ID aleatorio automáticamente

        let myData = { x: 100, y: 100, nick: "Jugador", skin: "gold", level: 1 };
        let peers = {}; // Aquí guardaremos las conexiones con otros
        let remotePlayers = {}; // Datos de los otros jugadores

        // 1. Mostrar mi ID al iniciar
        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = id;
        });

        // 2. Escuchar cuando alguien se conecta a MÍ
        peer.on('connection', (conn) => {
            setupConnection(conn);
        });

        function connectToPeer() {
            const targetId = document.getElementById('target-id').value;
            const conn = peer.connect(targetId);
            setupConnection(conn);
        }

        function setupConnection(conn) {
            conn.on('open', () => {
                peers[conn.peer] = conn;
                // Enviar mis datos iniciales
                conn.send({ type: 'init', data: myData });

                conn.on('data', (data) => {
                    if (data.type === 'move' || data.type === 'init') {
                        remotePlayers[conn.peer] = data.data;
                    }
                });
            });
        }

        // 3. Lógica de Movimiento
        const keys = {};
        window.onkeydown = (e) => keys[e.key] = true;
        window.onkeyup = (e) => keys[e.key] = false;

        function update() {
            let moved = false;
            myData.nick = document.getElementById('nick').value;
            myData.skin = document.getElementById('skin').value;

            if (keys['ArrowUp'] || keys['w']) { myData.y -= 3; moved = true; }
            if (keys['ArrowDown'] || keys['s']) { myData.y += 3; moved = true; }
            if (keys['ArrowLeft'] || keys['a']) { myData.x -= 3; moved = true; }
            if (keys['ArrowRight'] || keys['d']) { myData.x += 3; moved = true; }

            if (moved) {
                // Notificar a todos los peers conectados
                for (let id in peers) {
                    peers[id].send({ type: 'move', data: myData });
                }
            }
        }

        // 4. Renderizado
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Dibujarme a mí
            drawPlayer(myData);

            // Dibujar a los demás
            for (let id in remotePlayers) {
                drawPlayer(remotePlayers[id]);
            }

            update();
            requestAnimationFrame(draw);
        }

        function drawPlayer(p) {
            ctx.fillStyle = p.skin;
            ctx.fillRect(p.x, p.y, 30, 30);
            ctx.fillStyle = "white";
            ctx.fillText(`${p.nick} (Lvl ${p.level})`, p.x - 10, p.y - 10);
        }

        draw();
    </script>
</body>
</html>
